<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Pilgrim's Journey â€“ Game</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Georgia", system-ui, sans-serif;
      background: url('bg_game.png') center/cover no-repeat fixed;
    }

    .overlay {
      background: rgba(0,0,0,0.35);
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
      padding: 16px;
    }

    /* ìƒë‹¨ ë°” */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(60,60,60,0.95);
      color: #f5f5f5;
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
      margin-bottom: 24px;
    }

    .player-info {
      font-size: 14px;
      white-space: nowrap;
    }

    .player-info strong {
      font-size: 16px;
      margin-right: 6px;
    }

    .stats {
      font-size: 13px;
      opacity: 0.9;
    }

    .top-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-top {
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      background: #8e5b32;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    }
    .btn-top.save {
      background: #407a3b;
    }
    .btn-top:hover {
      filter: brightness(1.05);
    }

    /* ìŠ¤í† ë¦¬ ì¹´ë“œ */
    .story-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 32px;
    }

    .story-card {
      width: min(900px, 90vw);
      background: rgba(255,255,245,0.94);
      border-radius: 18px;
      padding: 22px 28px 26px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
      border: 1px solid rgba(220,200,160,0.9);
      position: relative;
      overflow: hidden;
    }

    /* ì–‘í”¼ì§€ ëŠë‚Œ ì¥ì‹ */
    .story-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.5), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(230,210,170,0.35), transparent 60%);
      pointer-events: none;
    }

    .story-content {
      position: relative;
      z-index: 1;
    }

    .story-ko {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #3a2a16;
    }

    .story-en {
      font-size: 14px;
      color: #665544;
      margin-bottom: 16px;
    }

    /* ì„ íƒì§€ (RPG ìŠ¤íƒ€ì¼) */
    .choice-container {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .choice-btn {
      text-align: left;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #c9b289;
      background: linear-gradient(90deg, #fdf5e6, #f5e4c6);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .choice-btn::before {
      content: "â–¶";
      margin-right: 6px;
      color: #b07a3b;
    }

    .choice-btn:hover {
      filter: brightness(1.04);
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }

    /* ìŠ¤í† ë¦¬ ë¡œê·¸ (í•œ ì¤„) */
    .story-log {
      margin-top: 14px;
      padding: 6px 10px;
      border-radius: 9px;
      background: rgba(255,248,224,0.9);
      border: 1px solid rgba(214,189,135,0.9);
      font-size: 13px;
      color: #4a3a1e;
      min-height: 18px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ìƒì  ëª¨ë‹¬ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .modal {
      background: #f8f4ec;
      border-radius: 18px;
      padding: 20px 24px 24px;
      width: min(640px, 95vw);
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      border: 2px solid #b7935d;
      overflow-y: auto;
      max-height: 90vh;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #54351c;
    }

    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 22px;
      font-weight: bold;
    }

    .shop-faith {
      font-size: 13px;
      color: #333;
      margin-bottom: 8px;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 18px;
      margin-top: 8px;
    }

    .shop-item {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: 1px solid #e2d2b4;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 80px;
    }

    .shop-item-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #3b2615;
    }

    .shop-item-cost {
      font-size: 12px;
      color: #7a5b34;
      margin-bottom: 6px;
    }

    .shop-buy-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      align-self: flex-end;
      background: #8e5b32;
      color: #fff;
    }
    .shop-buy-btn:hover {
      filter: brightness(1.05);
    }

    .gacha-section {
      border-top: 1px dashed #c7b08a;
      padding-top: 10px;
      margin-top: 14px;
      text-align: center;
    }

    .gacha-btn {
      margin-top: 8px;
      padding: 10px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      background: linear-gradient(90deg,#f2a93b,#ff6f61);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }
    .gacha-btn:hover {
      filter: brightness(1.05);
    }

    .gacha-desc {
      font-size: 12px;
      color: #7a5b34;
    }

    /* ê°€ì±  ë¡œê·¸ */
    .gacha-log-box {
      margin-top: 10px;
      margin-bottom: 12px;
      background:#fff7e0;
      padding:10px;
      border-radius:10px;
      border:1px solid #d8c6a4;
      max-height:80px;
      overflow-y:auto;
      font-size:13px;
    }

    /* ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out;
      z-index: 50;
    }
    .toast.show {
      opacity: 1;
    }
  </style>
</head>

<body>
<div class="overlay">

  <!-- ìƒë‹¨ ë°” -->
  <div class="top-bar">
    <div class="player-info">
      <strong id="playerName">Player: ë¡œê·¸ì¸</strong>
      <span class="stats" id="statLine"></span>
    </div>
    <div class="top-buttons">
      <button class="btn-top" onclick="openShop()">ìƒì </button>
      <button class="btn-top save" onclick="saveGame()">ì €ì¥</button>
    </div>
  </div>

  <!-- ìŠ¤í† ë¦¬ ì¹´ë“œ -->
  <div class="story-wrapper">
    <div class="story-card">
      <div class="story-content">
        <div class="story-ko" id="storyKo">ìŠ¤í† ë¦¬ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        <div class="story-en" id="storyEn">The story text will appear here.</div>

        <!-- ì„ íƒì§€ ì˜ì—­ -->
        <div id="choiceContainer" class="choice-container"></div>

        <!-- ì „íˆ¬/ë„ë§/ê²°ê³¼ ë“± í•œ ì¤„ ë¡œê·¸ -->
        <div class="story-log" id="storyLog"></div>
      </div>
    </div>
  </div>

  <!-- ìƒì  ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="shopBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>Pilgrim ìƒì </h2>
        <button class="modal-close" onclick="closeShop()">Ã—</button>
      </div>

      <div class="shop-faith" id="shopFaithText"></div>

      <!-- ëœë¤ë½‘ê¸° ê¸°ë¡ì°½ -->
      <div id="randomLogBox" class="gacha-log-box">
        <p style="margin:0; color:#999;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>

      <div class="shop-grid" id="shopGrid"></div>

      <div class="gacha-section">
        <div class="gacha-desc">ëœë¤ ë½‘ê¸° (50F) â€“ í° ë³´ìƒ ë˜ëŠ” ê½!</div>
        <button class="gacha-btn" onclick="rollGacha()">âœ¨ ëœë¤ ë½‘ê¸° âœ¨</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

</div>

<script>
  /* ---------------- ê¸°ë³¸ ì„¤ì • ---------------- */

  const API_URL = "https://script.google.com/macros/s/AKfycbwUqF_7np5AgJTygWKEn8diNyiFmvAnHaSsY0Xz3zVMuw5bGnn6y2Wr35zmq-w_ZuHyTQ/exec";

  let playerId = localStorage.getItem("pilgrimPlayerId") || "";
  let playerName = localStorage.getItem("pilgrimPlayerName") || "ë¡œê·¸ì¸";

  const defaultState = {
    str: 1,
    hp: 10,        // í˜„ì¬ HP
    maxHp: 10,     // ìµœëŒ€ HP
    dex: 1,
    def: 1,
    life: 1,
    faith: 0,
    storyKey: "0-0", // í˜„ì¬ ìŠ¤í† ë¦¬ ID
    branch: 0        // 0,1,2 ...
  };

  let state = { ...defaultState };

  try {
    const saved = JSON.parse(localStorage.getItem("pilgrimSaveData") || "null");
    if (saved) {
      state = Object.assign({}, defaultState, saved);
    }
  } catch (e) {}

  if (!state.maxHp) state.maxHp = state.hp || 10;
  if (!state.storyKey) state.storyKey = "0-0";
  if (state.life == null) state.life = 1;

  /* ëœë¤ë½‘ê¸° ë¡œê·¸ (ê²Œì„ ì¤‘ ìœ ì§€, ìƒˆ ë¡œê·¸ì¸ ì‹œ ì´ˆê¸°í™”) */
  let randomLog = [];

  /* ì „íˆ¬ ìƒíƒœ */
  let battleState = {
    active: false,
    wins: 0,
    losses: 0
  };

  /* ---------------- í™•ë¥  ê³„ì‚° í•¨ìˆ˜ë“¤ ---------------- */

  function getAttackWinChance() {
    const base = 0.4;       // 40%
    const perStr = 0.0001;  // STR +1ë‹¹ 0.01%
    let chance = base + perStr * state.str;
    return Math.min(chance, 0.8); // ìµœëŒ€ 80%
  }

  function getDefenseChance() {
    const perDef = 0.0001; // DEF +1ë‹¹ 0.01%
    let chance = perDef * state.def;
    return Math.min(chance, 0.8); // ìµœëŒ€ 80%
  }

  function getRunChanceInBattle() {
    const base = 0.10;     // 10%
    const perDex = 0.0001; // DEX +1ë‹¹ 0.01%
    let chance = base + perDex * state.dex;
    return Math.min(chance, 0.7); // ìµœëŒ€ 70%
  }

  function getRunChanceEncounter() {
    const base = 0.5;      // 50%
    const perDex = 0.0001; // DEX +1ë‹¹ 0.01%
    let chance = base + perDex * state.dex;
    return Math.min(chance, 0.9); // ìµœëŒ€ 90% (ì„ì˜ ì„¤ì •)
  }

  function chance(p) {
    return Math.random() < p;
  }

  /* ---------------- ìŠ¤í† ë¦¬ ë°ì´í„° ---------------- */

  // branch: 1 = 1ë²ˆ ê¸¸(ì†Œë”ì— ë‚¨ëŠ”ë‹¤), 2 = ë– ë‚œ ê¸¸
  const scenes = {
    // 0-0 : ê²Œì„ ì‹œì‘ ë©”ì¸ ìŠ¤í† ë¦¬
    "0-0": {
      id: "0-0",
      branch: 0,
      random: false,
      ko: `ì„¸ìƒì—ëŠ” ì£„ê°€ ë§Œì—°í•˜ê³  ìˆë‹¤. ë¬´ì—‡ì´ ì£„ì¸ê°€? ë¬´ì—‡ì´ ë„ë•ì¸ê°€? ì‚¬ëŒë“¤ì€ ì¸ê¶Œì´ë¼ëŠ” ë¯¸ëª… ì•„ë˜, ì„œì„œíˆ íƒ€ë½í•˜ê³  ìˆë‹¤.
ì´ëŸ¬í•œ ì„¸ìƒ ì†ì—ì„œâ€¦ ë‚˜ëŠ” ëŒ€ì²´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ëŠ”ê°€?

{name}ë‹˜, ë‹¹ì‹ ì€ í˜„ì¬ 'ì†Œë”'ì´ë¼ëŠ” íƒ€ë½í•œ ë„ì‹œì— ê±°ì£¼í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ë‹¹ì‹ ì€ ì†Œë”ì— ê³„ì† ë¨¸ë¬´ì‹œê² ìŠµë‹ˆê¹Œ? ì•„ë‹ˆë©´ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
      en: `Sin is everywhere in this world. People slowly fall into darkness in the name of "human rights."
In this world, what should I do?

{name}, you are now living in the corrupted city of Sodom.
Will you stay in Sodom, or will you leave?`,
      choices: [
        {
          text: "1. ì†Œë”ì— ë‚¨ëŠ”ë‹¤ (Stay in Sodom)",
          action: () => {
            state.branch = 1;
            setStoryLog("ë‹¹ì‹ ì€ ì†Œë”ì— ë‚¨ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.");
            gotoScene("1-1");
          }
        },
        {
          text: "2. ì†Œë”ì„ ë– ë‚œë‹¤ (Leave Sodom)",
          action: () => {
            state.branch = 2;
            setStoryLog("ë‹¹ì‹ ì€ ì†Œë”ì„ ë– ë‚˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.");
            gotoScene("2-1");
          }
        }
      ]
    },

    // 1-1 : ëœë¤ ìŠ¤í† ë¦¬ì˜ ì²« ì‚¬ê±´ (ì†Œë”ì— ë‚¨ê²¼ì„ ë•Œ)
    "1-1": {
      id: "1-1",
      branch: 1,
      random: false,
      ko: `ì§‘ì— ìŒì‹ì´ ì—†ì–´ì„œ, ë§ˆíŠ¸ë¡œ í–¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ê·¸ëŸ°ë° ì•ì—ì„œ ë§ˆì£¼ ì˜¤ë˜ ê°™ì€ ì„±ë³„ì˜ ì‚¬ëŒì´ {name}ë‹˜ì„ ë³´ë”ë‹ˆ,
ìœ™í¬ë¥¼ í•˜ë©° ë‹¤ê°€ì™€ ìœ í˜¹í•˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤.

{player}ë‹˜, ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
      en: `You are heading to the market because there is no food at home.
Suddenly, someone of the same gender walks toward you,
winks at you, and tries to tempt you.

What will you do, {player}?`,
      choices: [
        {
          text: "1. í•¨ê»˜í•œë‹¤ (Go with them)",
          action: () => {
            // HP -10
            const dmg = 10;
            setStoryLog("ìœ í˜¹ì— ë”°ë¼ê°”ìŠµë‹ˆë‹¤... ì˜ì , ìœ¡ì ìœ¼ë¡œ ì§€ì³ HPê°€ 10 ê°ì†Œí•©ë‹ˆë‹¤.");
            applyDamage(dmg);
            // ì´í›„ 1ë²ˆ ë¸Œëœì¹˜ ëœë¤ ìŠ¤í† ë¦¬ë¡œ
            gotoRandomStoryInBranch(1);
          }
        },
        {
          text: "2. ì‹¸ìš´ë‹¤ (Fight)",
          action: () => {
            setStoryLog("ì‹¸ìš°ê¸°ë¡œ ê²°ì‹¬í–ˆìŠµë‹ˆë‹¤. ê°€ìœ„ë°”ìœ„ë³´ ì „íˆ¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤.");
            startBattle();
          }
        },
        {
          text: "3. ë„ë§ê°„ë‹¤ (Run away)",
          action: () => {
            attemptEncounterEscape();
          }
        }
      ]
    },

    // 2-1 : ì†Œë”ì„ ë– ë‚œ ì‚¬ëŒì„ ìœ„í•œ ì²« ìŠ¤í† ë¦¬ (ê°„ë‹¨ ë²„ì „)
    "2-1": {
      id: "2-1",
      branch: 2,
      random: false,
      ko: `ë‹¹ì‹ ì€ ì†Œë”ì„ ë– ë‚˜ ê´‘ì•¼ ê¸¸ì„ ê±·ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.
ë’¤ë¥¼ ëŒì•„ë³´ë©´ ì—¬ì „íˆ ë¶ˆë¹›ê³¼ ì†ŒìŒì´ ê°€ë“í•œ ë„ì‹œê°€ ë³´ì…ë‹ˆë‹¤.
ê·¸ëŸ¬ë‚˜ ë§ˆìŒ í•œí¸ì—ëŠ” ì´ìƒí•œ í‰ì•ˆì´ ì°¾ì•„ì˜µë‹ˆë‹¤.

ì´ì œ ì–´ë””ë¡œ ê°€ì•¼ í• ê¹Œìš”?`,
      en: `You leave Sodom and begin walking through the wilderness.
Behind you, the city is still full of noise and lights,
but deep in your heart, a strange peace begins to grow.

Where will you go now?`,
      choices: [
        {
          text: "1. í•˜ë‚˜ë‹˜ê»˜ ê¸°ë„í•˜ë©° ê¸¸ì„ ë¬»ëŠ”ë‹¤ (Pray and ask God for direction)",
          action: () => {
            state.faith += 5;
            setStoryLog("í•˜ë‚˜ë‹˜ê»˜ ê¸°ë„í–ˆìŠµë‹ˆë‹¤. ì‹ ì•™ì‹¬ +5");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(2);
          }
        },
        {
          text: "2. ê·¸ëƒ¥ ì•ì— ë³´ì´ëŠ” ê¸¸ë¡œ ê°„ë‹¤ (Just follow the road)",
          action: () => {
            setStoryLog("ì•„ë¬´ ê³„íš ì—†ì´ ê¸¸ì„ ë”°ë¼ ê±·ìŠµë‹ˆë‹¤...");
            gotoRandomStoryInBranch(2);
          }
        }
      ]
    },

    // ---- ë¸Œëœì¹˜ 1 ëœë¤ ìŠ¤í† ë¦¬ ì˜ˆì‹œë“¤ ----
    "1-R1": {
      id: "1-R1",
      branch: 1,
      random: true,
      ko: `ì†Œë”ì˜ ë°¤ê±°ë¦¬ë¥¼ ê±¸ìœ¼ë©°, {name}ë‹˜ì€ í•˜ëŠ˜ì˜ ë³„ì„ ì˜¬ë ¤ë‹¤ë´…ë‹ˆë‹¤.
ì´ ë„ì‹œì˜ ì£„ì•… ê°€ìš´ë°ì„œë„, í•˜ë‚˜ë‹˜ì€ ì—¬ì „íˆ í•˜ëŠ˜ì—ì„œ ë‹¤ ë³´ê³  ê³„ì‹­ë‹ˆë‹¤.`,
      en: `{name} walks through the night streets of Sodom and looks up at the stars.
Even in this sinful city, God is still watching from heaven.`,
      choices: [
        {
          text: "ê¸°ë„í•˜ë©° íšŒê°œí•œë‹¤ (Pray and repent)",
          action: () => {
            state.faith += 3;
            setStoryLog("íšŒê°œì˜ ê¸°ë„ë¥¼ ë“œë ¸ìŠµë‹ˆë‹¤. ì‹ ì•™ì‹¬ +3");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(1);
          }
        }
      ]
    },
    "1-R2": {
      id: "1-R2",
      branch: 1,
      random: true,
      ko: `ì¹œêµ¬ë“¤ì´ {name}ë‹˜ì„ ë¶ˆëŸ¬ ìˆ ìë¦¬ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤.
ë¶„ìœ„ê¸°ëŠ” ì ì  ê³¼ê²©í•´ì§€ê³ , í•˜ë‚˜ë‹˜ì„ ì¡°ë¡±í•˜ëŠ” ë§ê¹Œì§€ ë‚˜ì˜µë‹ˆë‹¤.`,
      en: `Some friends invite {name} to a drinking party.
The atmosphere gets wilder, and they even begin to mock God.`,
      choices: [
        {
          text: "ì¡°ìš©íˆ ìë¦¬ë¥¼ ë– ë‚œë‹¤ (Quietly leave)",
          action: () => {
            state.faith += 2;
            setStoryLog("ìœ í˜¹ì„ ë¿Œë¦¬ì¹˜ê³  ìë¦¬ë¥¼ ë– ë‚¬ìŠµë‹ˆë‹¤. ì‹ ì•™ì‹¬ +2");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(1);
          }
        },
        {
          text: "ê°™ì´ ìˆ ì„ ë§ˆì‹ ë‹¤ (Drink with them)",
          action: () => {
            setStoryLog("ì˜ì ìœ¼ë¡œ ì§€ì³ ê°‘ë‹ˆë‹¤... HP 2 ê°ì†Œ.");
            applyDamage(2);
            gotoRandomStoryInBranch(1);
          }
        }
      ]
    },

    // ---- ë¸Œëœì¹˜ 2 ëœë¤ ìŠ¤í† ë¦¬ ì˜ˆì‹œë“¤ ----
    "2-R1": {
      id: "2-R1",
      branch: 2,
      random: true,
      ko: `ê´‘ì•¼ì—ì„œ ê¸¸ì„ ìƒì€ ê²ƒë§Œ ê°™ì§€ë§Œ,
{surname}ë‹˜ì€ ë§ˆìŒì†ìœ¼ë¡œ ì¡°ìš©íˆ ì‹œí¸ 23í¸ì„ ë– ì˜¬ë¦½ë‹ˆë‹¤.`,
      en: `You seem lost in the wilderness,
but quietly in your heart, you recall Psalm 23.`,
      choices: [
        {
          text: "â€œì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆâ€¦â€ë¥¼ ë¬µìƒí•œë‹¤",
          action: () => {
            state.faith += 4;
            setStoryLog("ë§ì”€ì„ ë¬µìƒí•˜ë©° ìœ„ë¡œë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. ì‹ ì•™ì‹¬ +4");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(2);
          }
        }
      ]
    },
    "2-R2": {
      id: "2-R2",
      branch: 2,
      random: true,
      ko: `ë©€ë¦¬ì„œ ì‘ì€ ë§ˆì„ í•˜ë‚˜ê°€ ë³´ì…ë‹ˆë‹¤.
ê·¸ê³³ì—ëŠ” í•˜ë‚˜ë‹˜ì„ ì˜ˆë°°í•˜ëŠ” ê³µë™ì²´ê°€ ìˆë‹¤ëŠ” ì†Œë¬¸ì„ ë“¤ì—ˆìŠµë‹ˆë‹¤.`,
      en: `In the distance, you see a small village.
You heard that there is a community there that worships God.`,
      choices: [
        {
          text: "ë§ˆì„ë¡œ ë“¤ì–´ê°€ ë³¸ë‹¤",
          action: () => {
            setStoryLog("ìƒˆë¡œìš´ ë¯¿ìŒì˜ ê³µë™ì²´ë¥¼ í–¥í•´ ê±¸ìŒì„ ì˜®ê¹ë‹ˆë‹¤.");
            gotoRandomStoryInBranch(2);
          }
        }
      ]
    }
  };

  /* ---------------- ìŠ¤í† ë¦¬ ì—”ì§„ ---------------- */

  function replaceName(text) {
    if (!text) return "";
    return text
      .replace(/\{name\}/g, playerName)
      .replace(/\{player\}/g, playerName)
      .replace(/\{surname\}/g, playerName);
  }

  function renderScene(scene) {
    document.getElementById("storyKo").textContent = replaceName(scene.ko);
    document.getElementById("storyEn").textContent = replaceName(scene.en);

    const choiceBox = document.getElementById("choiceContainer");
    choiceBox.innerHTML = "";

    if (scene.choices && scene.choices.length) {
      scene.choices.forEach((choice) => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = choice.text;
        btn.onclick = () => choice.action();
        choiceBox.appendChild(btn);
      });
    } else {
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = "ê³„ì† ì§„í–‰";
      btn.onclick = () => gotoRandomStoryInBranch(state.branch || 1);
      choiceBox.appendChild(btn);
    }
  }

  function gotoScene(id) {
    const scene = scenes[id];
    if (!scene) {
      setStoryLog("ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì€ ìŠ¤í† ë¦¬ì…ë‹ˆë‹¤.");
      return;
    }
    state.storyKey = id;
    if (scene.branch != null) state.branch = scene.branch;
    renderScene(scene);
    saveGame(true);
  }

  function gotoRandomStoryInBranch(branch) {
    const pool = Object.values(scenes).filter(
      (s) => s.branch === branch && s.random
    );
    if (!pool.length) {
      // ëœë¤ ìŠ¤í† ë¦¬ê°€ ì•„ì§ ì—†ìœ¼ë©´, í•´ë‹¹ ë¸Œëœì¹˜ì˜ ì²« ë©”ì¸ìŠ¤í† ë¦¬ë¡œ ë³µê·€
      const fallback = branch === 1 ? "1-1" : "2-1";
      gotoScene(fallback);
      return;
    }
    const idx = Math.floor(Math.random() * pool.length);
    const chosen = pool[idx];
    gotoScene(chosen.id);
  }

  function setStoryLog(msg) {
    document.getElementById("storyLog").textContent = msg || "";
  }

  /* ---------------- HP / LIFE / ë¶€í™œ / ê²Œì„ì˜¤ë²„ ---------------- */

  function applyDamage(dmg) {
  state.hp -= dmg;
  if (state.hp < 0) state.hp = 0;

  if (state.hp <= 0) {

    // 1) LIFE ê°ì†Œ
    state.life -= 1;

    // 2) LIFE ê²€ì‚¬ (0 ì´í•˜ = Game Over)
    if (state.life <= 0) {
      handleGameOver();
      return;
    }

    // 3) LIFEê°€ ì•„ì§ ë‚¨ì•„ìˆìœ¼ë©´ ë¶€í™œ
    state.hp = state.maxHp;
    setStoryLog("HPê°€ 0ì´ ë˜ì–´ í•œ ëª©ìˆ¨ì„ ìƒì—ˆì§€ë§Œ, ë‹¤ì‹œ ì¼ì–´ë‚¬ìŠµë‹ˆë‹¤! ë‹¤ë¥¸ ì‚¬ê±´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
    renderHeader();
    saveGame(true);

    gotoRandomStoryInBranch(state.branch || 1);
    return;
  }

  renderHeader();
  saveGame(true);
}

  function handleGameOver() {
    const keptFaith = state.faith; // ì‹ ì•™ì‹¬ë§Œ ìœ ì§€
    setStoryLog("Game Over... ëŠ¥ë ¥ì¹˜ëŠ” ì´ˆê¸°í™”ë˜ê³ , ì‹ ì•™ì‹¬ë§Œ ìœ ì§€ë©ë‹ˆë‹¤.");

    state = {
      ...defaultState,
      faith: keptFaith
    };

    renderHeader();
    saveGame(true);
    gotoScene("0-0");
  }

  /* ---------------- ì „íˆ¬ ì‹œìŠ¤í…œ (ê°€ìœ„ë°”ìœ„ë³´) ---------------- */

  function startBattle() {
    battleState = {
      active: true,
      wins: 0,
      losses: 0
    };

    const battleScene = {
      id: "battle",
      branch: state.branch,
      random: false,
      ko: `ì „íˆ¬ ëª¨ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!
ê°€ìœ„, ë°”ìœ„, ë³´ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.
3ë²ˆ ì´ê¸°ë©´ ìŠ¹ë¦¬, 3ë²ˆ ì§€ë©´ íŒ¨ë°°ì…ë‹ˆë‹¤.`,
      en: `Battle mode has begun!
Choose rock, paper, or scissors.
Win 3 times to win the battle. Lose 3 times and you are defeated.`,
      choices: [
        { text: "âœŒ ê°€ìœ„ (Scissors)", action: () => battleRound() },
        { text: "âœŠ ë°”ìœ„ (Rock)",     action: () => battleRound() },
        { text: "âœ‹ ë³´ (Paper)",      action: () => battleRound() },
        { text: "ğŸƒ ë„ë§ (Run away)", action: () => battleRun() }
      ]
    };

    renderScene(battleScene);
    setStoryLog("ê°€ìœ„ë°”ìœ„ë³´ì—ì„œ 3ë²ˆ ì´ê¸°ë©´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.");
  }

  function battleRound() {
    if (!battleState.active) return;

    const winProb = getAttackWinChance();
    if (chance(winProb)) {
      battleState.wins++;
      setStoryLog(`ì „íˆ¬ì—ì„œ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! (í˜„ì¬ ìŠ¹ë¦¬: ${battleState.wins}/3)`);

      if (battleState.wins >= 3) {
        battleWin();
      }
    } else {
      battleState.losses++;
      setStoryLog(`ì „íˆ¬ì—ì„œ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤... (í˜„ì¬ íŒ¨ë°°: ${battleState.losses}/3)`);

      if (battleState.losses >= 3) {
        battleLose();
      }
    }
  }

  function battleRun() {
    if (!battleState.active) return;
    const runProb = getRunChanceInBattle();

    if (chance(runProb)) {
      battleState.active = false;
      setStoryLog("ì „íˆ¬ì—ì„œ ë„ë§ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!");
      saveGame(true);
      gotoRandomStoryInBranch(state.branch || 1);
    } else {
      battleState.losses++;
      setStoryLog(`ë„ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤! (íŒ¨ë°° ì¹´ìš´íŠ¸ +1 â†’ ${battleState.losses}/3)`);

      if (battleState.losses >= 3) {
        battleLose();
      }
    }
  }

  function battleWin() {
    battleState.active = false;
    state.faith += 7;
    state.str += 1;
    setStoryLog("ì „íˆ¬ì—ì„œ ì™„ì „íˆ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ì‹ ì•™ì‹¬ +7, í˜ +1");
    renderHeader();
    saveGame(true);
    gotoRandomStoryInBranch(state.branch || 1);
  }

  function battleLose() {
    battleState.active = false;
    const defProb = getDefenseChance();

    if (chance(defProb)) {
      setStoryLog("ì „íˆ¬ì—ì„œëŠ” ì¡Œì§€ë§Œ, ë°©ì–´ì— ì„±ê³µí•˜ì—¬ HPê°€ ê°ì†Œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");
      renderHeader();
      saveGame(true);
      gotoRandomStoryInBranch(state.branch || 1);
      return;
    }

    setStoryLog("ì „íˆ¬ì—ì„œ íŒ¨ë°°í•˜ì—¬ HPê°€ 6 ê°ì†Œí–ˆìŠµë‹ˆë‹¤.");
    applyDamage(6);
    gotoRandomStoryInBranch(state.branch || 1);
  }

  /* ---------------- 1-1ì—ì„œì˜ 'ë„ë§ê°„ë‹¤' ì„ íƒ ---------------- */

  function attemptEncounterEscape() {
    const runProb = getRunChanceEncounter();

    if (chance(runProb)) {
      setStoryLog("ë„ë§ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ë‹¤ë¥¸ ì‚¬ê±´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      saveGame(true);
      gotoRandomStoryInBranch(state.branch || 1);
    } else {
      setStoryLog("ë„ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤... HPê°€ 1 ê°ì†Œí•©ë‹ˆë‹¤.");
      applyDamage(1);
      // ë‹¤ì‹œ 1-1 ìƒí™©ìœ¼ë¡œ ëŒì•„ê°„ë‹¤
      gotoScene("1-1");
    }
  }

  /* ---------------- ìƒë‹¨ ì •ë³´ ë Œë” ---------------- */

  function renderHeader() {
    document.getElementById("playerName").textContent = "Player: " + playerName;
    document.getElementById("statLine").textContent =
      `ëŠ¥ë ¥ì¹˜ â€“ STR:${state.str} | HP:${state.hp}/${state.maxHp} | ` +
      `DEX:${state.dex} | DEF:${state.def} | LIFE:${state.life} | FAITH:${state.faith}`;
  }

  /* ---------------- ìƒì  ---------------- */

  const shopItems = [
    { label:"í˜ +1",   stat:"str",  amount:1, cost:10 },
    { label:"ì²´ë ¥ +1", stat:"hp",   amount:1, cost:5 },
    { label:"íšŒí”¼ +1", stat:"dex",  amount:1, cost:5 },
    { label:"ë°©ì–´ +1", stat:"def",  amount:1, cost:5 },
    { label:"ëª©ìˆ¨ +1", stat:"life", amount:1, cost:50 }
  ];

  function openShop() {
    document.getElementById("shopBackdrop").style.display = "flex";
    updateShopFaithText();
    buildShopGrid();
    updateRandomLogUI();
  }

  function closeShop() {
    document.getElementById("shopBackdrop").style.display = "none";
  }

  function updateShopFaithText() {
    document.getElementById("shopFaithText").textContent =
      `í˜„ì¬ ì‹ ì•™ì‹¬(Faith): ${state.faith}F`;
  }

  function buildShopGrid() {
    const box = document.getElementById("shopGrid");
    box.innerHTML = "";
    shopItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "shop-item";

      div.innerHTML = `
        <div class="shop-item-title">${item.label}</div>
        <div class="shop-item-cost">${item.cost}F</div>
        <button class="shop-buy-btn">êµ¬ì…</button>
      `;

      div.querySelector("button").onclick = () => buyItem(item);
      box.appendChild(div);
    });
  }

  function buyItem(item) {
    if (state.faith < item.cost) {
      showToast("ì‹ ì•™ì‹¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
      return;
    }
    state.faith -= item.cost;

    if (item.stat === "hp") {
      // ì²´ë ¥ ì—…ê·¸ë ˆì´ë“œ: ìµœëŒ€ HPì™€ í˜„ì¬ HP ëª¨ë‘ ìƒìŠ¹
      state.maxHp += item.amount;
      state.hp += item.amount;
      if (state.hp > state.maxHp) state.hp = state.maxHp;
    } else {
      state[item.stat] += item.amount;
    }

    renderHeader();
    updateShopFaithText();
    saveGame(true);
    showToast(`êµ¬ì… ì™„ë£Œ: ${item.label}`);
  }

  /* ---------------- ëœë¤ ë½‘ê¸° ---------------- */

  const gachaCost = 50;

  const gachaTable = [
    { text:"í˜ +1",      apply:()=>{ state.str+=1; },  weight:7 },
    { text:"í˜ +5",      apply:()=>{ state.str+=5; },  weight:7 },
    { text:"í˜ +10",     apply:()=>{ state.str+=10; }, weight:3 },

    { text:"ì²´ë ¥ +1",    apply:()=>{ state.maxHp+=1; state.hp+=1; if(state.hp>state.maxHp)state.hp=state.maxHp; }, weight:7 },
    { text:"ì²´ë ¥ +5",    apply:()=>{ state.maxHp+=5; state.hp+=5; if(state.hp>state.maxHp)state.hp=state.maxHp; }, weight:7 },
    { text:"ì²´ë ¥ +10",   apply:()=>{ state.maxHp+=10; state.hp+=10; if(state.hp>state.maxHp)state.hp=state.maxHp; }, weight:3 },

    { text:"íšŒí”¼ +1",    apply:()=>{ state.dex+=1; },  weight:7 },
    { text:"íšŒí”¼ +5",    apply:()=>{ state.dex+=5; },  weight:7 },
    { text:"íšŒí”¼ +10",   apply:()=>{ state.dex+=10; }, weight:3 },

    { text:"ë°©ì–´ +1",    apply:()=>{ state.def+=1; },  weight:7 },
    { text:"ë°©ì–´ +5",    apply:()=>{ state.def+=5; },  weight:7 },
    { text:"ë°©ì–´ +10",   apply:()=>{ state.def+=10; }, weight:3 },

    { text:"ì‹ ì•™ì‹¬ +50", apply:()=>{ state.faith+=50; },  weight:5 },
    { text:"ì‹ ì•™ì‹¬ +100",apply:()=>{ state.faith+=100; }, weight:1 },

    { text:"ëª©ìˆ¨ +1",    apply:()=>{ state.life+=1; }, weight:2 },
    { text:"ëª©ìˆ¨ +2",    apply:()=>{ state.life+=2; }, weight:1 },
    { text:"ëª©ìˆ¨ +3",    apply:()=>{ state.life+=3; }, weight:1.82 },

    { text:"Starbucks Gift Card $5",  apply:()=>{}, weight:0.05 },
    { text:"Starbucks Gift Card $10", apply:()=>{}, weight:0.005 },
    { text:"Starbucks Gift Card $20", apply:()=>{}, weight:0.001 },

    { text:"Amazon Gift Card $10",    apply:()=>{}, weight:0.005 },
    { text:"Amazon Gift Card $20",    apply:()=>{}, weight:0.001 },

    { text:"Google Play Gift Card $5",  apply:()=>{}, weight:0.05 },
    { text:"Google Play Gift Card $10", apply:()=>{}, weight:0.005 },
    { text:"Google Play Gift Card $20", apply:()=>{}, weight:0.001 },

    { text:"ê½", apply:()=>{}, weight:20 }
  ];

  function rollGacha() {
    if (state.faith < gachaCost) {
      showToast("ì‹ ì•™ì‹¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (50F í•„ìš”)");
      return;
    }

    state.faith -= gachaCost;

    let total = gachaTable.reduce((s,x)=>s+x.weight, 0);
    let r = Math.random() * total;

    let chosen = gachaTable[gachaTable.length-1];
    for (const entry of gachaTable) {
      if (r < entry.weight) {
        chosen = entry;
        break;
      }
      r -= entry.weight;
    }

    // ë¡œê·¸ ì¶”ê°€ (ìµœê·¼ ìˆœ)
    const time = new Date().toLocaleTimeString("ko-KR", {hour:"2-digit", minute:"2-digit"});
    randomLog.unshift(`${time} â†’ ${chosen.text}`);
    if (randomLog.length > 20) randomLog.pop();
    updateRandomLogUI();

    // Gift Cardë©´ íŒì—…
    if (chosen.text.includes("Gift Card")) {
      showGiftPopup(chosen.text);
      renderHeader();
      updateShopFaithText();
      saveGame(true);
      return;
    }

    // ì¼ë°˜ ë³´ìƒ
    chosen.apply();
    renderHeader();
    updateShopFaithText();
    saveGame(true);

    confettiEffect();
    showToast("ëœë¤ ë½‘ê¸° ê²°ê³¼: " + chosen.text);
  }

  function updateRandomLogUI() {
    const box = document.getElementById("randomLogBox");
    if (!randomLog.length) {
      box.innerHTML = "<p style='margin:0;color:#999;'>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      return;
    }
    box.innerHTML = randomLog
      .map(item=>`<div>â€¢ ${item}</div>`)
      .join("");
  }

  /* Gift Card ë‹¹ì²¨ íŒì—… + ìŠ¤í¬ë¦°ìƒ· ì•ˆë‚´ */
  function showGiftPopup(itemName){
    confettiEffect();

    const back = document.createElement("div");
    back.style = `
      position:fixed; inset:0; 
      background:rgba(0,0,0,0.75);
      display:flex; align-items:center; justify-content:center;
      z-index:200;
    `;

    const card = document.createElement("div");
    card.style = `
      background:white; width:80%; max-width:420px;
      padding:30px; border-radius:20px;
      text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5);
    `;

    card.innerHTML = `
      <h2 style="font-size:28px; color:#d33; margin-bottom:10px;">ğŸ‰ CONGRATULATIONS! ğŸ‰</h2>
      <div style="font-size:22px; margin-bottom:20px;">
        You won:<br><strong style="font-size:26px; color:#2a6;">${itemName}</strong>
      </div>
      <p style="font-size:15px; margin-bottom:6px;">
        ğŸ“¸ ìŠ¤í¬ë¦°ìƒ·ì„ ì°ì–´ì„œ ì´ì¬ê´€ ëª©ì‚¬ë‹˜ê»˜ ì¹´í†¡ìœ¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”!
      </p>
      <p style="font-size:13px; color:#666; margin-bottom:10px;">
        ğŸ“¸ Please take a screenshot and send it to Pastor Jaegwan via KakaoTalk!
      </p>
      <button id="fakeShotBtn"
        style="margin-top:4px; background:#f0f0f0; color:#333;
               padding:8px 16px; border-radius:8px; border:1px solid #ccc; cursor:pointer;">
        (ì˜ˆì‹œ) ìŠ¤í¬ë¦°ìƒ· ë²„íŠ¼
      </button>
      <br/>
      <button style="margin-top:16px; background:#444; color:white;
                     padding:10px 20px; border-radius:8px; border:none; cursor:pointer;">
        ë‹«ê¸° Close
      </button>
    `;

    card.querySelector("button:last-of-type").onclick = () => back.remove();

    // ì‹¤ì œë¡œ í™”ë©´ ìº¡ì³ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ìë™ìœ¼ë¡œ ëª»í•˜ì§€ë§Œ,
    // ì´ ë²„íŠ¼ì€ "ìŠ¤í¬ë¦°ìƒ·ì„ ì§ì ‘ ì°ì–´ì£¼ì„¸ìš”!" ì•ˆë‚´ìš©.
    const fakeBtn = card.querySelector("#fakeShotBtn");
    fakeBtn.onclick = () => {
      alert("ê¸°ê¸°ì—ì„œ ìŠ¤í¬ë¦°ìƒ·ì„ ì§ì ‘ ì°ì–´ì£¼ì„¸ìš”! (ì˜ˆ: íœ´ëŒ€í° ìº¡ì³ ë²„íŠ¼)");
    };

    back.appendChild(card);
    document.body.appendChild(back);
  }

  /* ---------------- ì €ì¥ ---------------- */

  async function saveGame(silent=false){
    if (!playerId) {
      if (!silent) alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. index.htmlì—ì„œ ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
      return;
    }
    localStorage.setItem("pilgrimSaveData", JSON.stringify(state));

    try {
      const r = await fetch(API_URL, {
        method:"POST",
        body:JSON.stringify({
          type:"save",
          id:playerId,
          saveData:state
        })
      });
      const t = await r.text();
      if(!silent){
        if(t==="saved") showToast("ì €ì¥ ì™„ë£Œ!");
        else showToast("ì €ì¥ ì‹¤íŒ¨: " + t);
      }
    } catch(e){
      if(!silent) alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /* ---------------- í† ìŠ¤íŠ¸ & í­ì£½ ---------------- */

  function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2000);
  }

  function confettiEffect() {
    const duration = 1200;
    const end = Date.now() + duration;

    (function frame(){
      const colors = ["#ffcc00","#ff6699","#66ccff","#99ff66","#ff9966"];
      const div = document.createElement("div");
      div.style = `
        position:fixed; top:${Math.random()*40}%; left:${Math.random()*80+10}%;
        width:8px; height:14px;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        opacity:0.95; transform:rotate(${Math.random()*360}deg);
        transition: transform 1s ease-out, top 1s ease-out, opacity 1s;
        z-index:300;
      `;
      document.body.appendChild(div);
      setTimeout(()=>{
        div.style.top="100%";
        div.style.opacity="0";
        div.style.transform+=" rotate(720deg)";
      },10);
      setTimeout(()=>div.remove(),1500);
      if(Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  /* ---------------- ì´ˆê¸° ì‹¤í–‰ ---------------- */

  renderHeader();
  gotoScene(state.storyKey || "0-0");
</script>

</body>
</html>

