<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Pilgrim's Journey – Game</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Georgia", system-ui, sans-serif;
      background: url('bg_game.png') center/cover no-repeat fixed;
    }

    .overlay {
      background: rgba(0,0,0,0.35);
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
      padding: 16px;
    }

    /* 상단 바 */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(60,60,60,0.95);
      color: #f5f5f5;
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
      margin-bottom: 24px;
    }

    .player-info {
      font-size: 14px;
      white-space: nowrap;
    }

    .player-info strong {
      font-size: 16px;
      margin-right: 6px;
    }

    .stats {
      font-size: 13px;
      opacity: 0.9;
    }

    .top-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-top {
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      background: #8e5b32;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    }
    .btn-top.save {
      background: #407a3b;
    }
    .btn-top:hover {
      filter: brightness(1.05);
    }

    /* 스토리 카드 */
    .story-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 40px;
    }

    .story-card {
      width: min(900px, 90vw);
      background: rgba(255,255,255,0.92);
      border-radius: 18px;
      padding: 26px 32px 32px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
      border: 1px solid rgba(230,230,230,0.9);
    }

    .story-ko {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #333;
    }

    .story-en {
      font-size: 14px;
      color: #666;
      margin-bottom: 24px;
    }

    .next-btn {
      display: inline-block;
      margin-top: 8px;
      padding: 10px 24px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      background: #8e5b32;
      color: #fff;
      box-shadow: 0 3px 8px rgba(0,0,0,0.35);
    }
    .next-btn:hover {
      filter: brightness(1.05);
    }

    /* 상점 모달 */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .modal {
      background: #f8f4ec;
      border-radius: 18px;
      padding: 20px 24px 24px;
      width: min(640px, 95vw);
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      border: 2px solid #b7935d;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #54351c;
    }

    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
    }

    .shop-faith {
      font-size: 13px;
      color: #333;
      margin-bottom: 8px;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    .shop-item {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: 1px solid #e2d2b4;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 80px;
    }

    .shop-item-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #3b2615;
    }

    .shop-item-cost {
      font-size: 12px;
      color: #7a5b34;
      margin-bottom: 6px;
    }

    .shop-buy-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      align-self: flex-end;
      background: #8e5b32;
      color: #fff;
    }

    .shop-buy-btn:hover {
      filter: brightness(1.05);
    }

    .gacha-section {
      border-top: 1px dashed #c7b08a;
      padding-top: 10px;
      margin-top: 6px;
      text-align: center;
    }

    .gacha-btn {
      margin-top: 6px;
      padding: 10px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      background: linear-gradient(90deg,#f2a93b,#ff6f61);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }

    .gacha-btn:hover {
      filter: brightness(1.05);
    }

    .gacha-desc {
      font-size: 12px;
      color: #7a5b34;
    }

    /* 간단한 토스트 */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out;
      z-index: 20;
    }
    .toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
<div class="overlay">

  <!-- 상단 바 -->
  <div class="top-bar">
    <div class="player-info">
      <strong id="playerName">Player: 로그인</strong>
      <span class="stats" id="statLine"></span>
    </div>
    <div class="top-buttons">
      <button class="btn-top" onclick="openShop()">상점</button>
      <button class="btn-top save" onclick="saveGame()">저장</button>
    </div>
  </div>

  <!-- 스토리 카드 -->
  <div class="story-wrapper">
    <div class="story-card">
      <div class="story-ko" id="storyKo">여기에 스토리 한국어가 표시됩니다.</div>
      <div class="story-en" id="storyEn">Here the English translation will appear.</div>
      <button class="next-btn" onclick="nextStory()">다음 진행</button>
    </div>
  </div>

  <!-- 상점 모달 -->
  <div class="modal-backdrop" id="shopBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>Pilgrim 상점</h2>
        <button class="modal-close" onclick="closeShop()">×</button>
      </div>
      <div class="shop-faith" id="shopFaithText"></div>

      <div class="shop-grid" id="shopGrid">
        <!-- JS로 채움 -->
      </div>

      <div class="gacha-section">
        <div class="gacha-desc">랜덤 뽑기 (100F) – 큰 보상 또는 꽝!</div>
        <button class="gacha-btn" onclick="rollGacha()">✨ 랜덤 뽑기 ✨</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwUqF_7np5AgJTygWKEn8diNyiFmvAnHaSsY0Xz3zVMuw5bGnn6y2Wr35zmq-w_ZuHyTQ/exec";

  // ====== 기본 상태 ======
  let playerId = localStorage.getItem("pilgrimPlayerId") || "";
  let playerName = localStorage.getItem("pilgrimPlayerName") || "로그인";
  let state = {
    str: 1,
    hp: 10,
    dex: 1,
    def: 1,
    life: 1,
    faith: 0,
    storyIndex: 0
  };

  // 로컬 저장된 saveData 불러오기
  try {
    const saved = JSON.parse(localStorage.getItem("pilgrimSaveData") || "null");
    if (saved) {
      state = Object.assign(state, saved);
    }
  } catch (e) {}

  // ====== 스토리 예시 (원하면 나중에 실제 내용으로 교체) ======
  const stories = [
    {
      ko: "오늘도 너의 신앙의 여정이 시작됩니다.",
      en: "Today, your journey of faith begins again."
    },
    {
      ko: "하나님은 작은 믿음도 소중히 여기십니다.",
      en: "God treasures even a small amount of faith."
    },
    {
      ko: "기도와 말씀으로 힘을 얻어 앞으로 나아가 보세요.",
      en: "Gain strength through prayer and the Word, and move forward."
    }
  ];

  function renderStory() {
    const idx = Math.min(state.storyIndex || 0, stories.length - 1);
    const s = stories[idx] || stories[0];
    document.getElementById("storyKo").textContent = s.ko;
    document.getElementById("storyEn").textContent = s.en;
  }

  function nextStory() {
    if (state.storyIndex < stories.length - 1) {
      state.storyIndex++;
      renderStory();
    } else {
      showToast("마지막 스토리입니다. 추후 업데이트 예정!");
    }
  }

  // ====== 상단 정보 렌더 ======
  function renderHeader() {
    document.getElementById("playerName").textContent =
      "Player: " + playerName;
    document.getElementById("statLine").textContent =
      `능력치 – STR:${state.str} | HP:${state.hp} | DEX:${state.dex} | DEF:${state.def} | LIFE:${state.life} | FAITH:${state.faith}`;
  }

  // ====== 상점 ======
  const shopItems = [
    { key: "str",  label: "힘 +1",   stat: "str",  amount: 1, cost: 10 },
    { key: "hp",   label: "체력 +1", stat: "hp",   amount: 1, cost: 5 },
    { key: "dex",  label: "회피 +1", stat: "dex", amount: 1, cost: 5 },
    { key: "def",  label: "방어 +1", stat: "def", amount: 1, cost: 5 },
    // LIFE 가격은 임의로 50F로 설정 (필요하면 숫자만 바꿔도 됨)
    { key: "life", label: "목숨 +1", stat: "life", amount: 1, cost: 50 }
  ];

  function buildShopGrid() {
    const container = document.getElementById("shopGrid");
    container.innerHTML = "";

    shopItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "shop-item";

      const title = document.createElement("div");
      title.className = "shop-item-title";
      title.textContent = item.label;

      const cost = document.createElement("div");
      cost.className = "shop-item-cost";
      cost.textContent = `${item.cost}F`;

      const btn = document.createElement("button");
      btn.className = "shop-buy-btn";
      btn.textContent = "구입";
      btn.onclick = () => buyItem(item);

      div.appendChild(title);
      div.appendChild(cost);
      div.appendChild(btn);

      container.appendChild(div);
    });
  }

  function openShop() {
    buildShopGrid();
    updateShopFaithText();
    document.getElementById("shopBackdrop").style.display = "flex";
  }

  function closeShop() {
    document.getElementById("shopBackdrop").style.display = "none";
  }

  function updateShopFaithText() {
    document.getElementById("shopFaithText").textContent =
      `현재 신앙심(Faith): ${state.faith}F`;
  }

  function buyItem(item) {
    if (state.faith < item.cost) {
      showToast("신앙심이 부족합니다!");
      return;
    }
    state.faith -= item.cost;
    state[item.stat] += item.amount;

    renderHeader();
    updateShopFaithText();
    saveGame(true); // true = 조용히 저장

    showToast(`구입 완료: ${item.label}`);
  }

  // ====== 랜덤 뽑기 ======
  const gachaCost = 100;

  const gachaTable = [
    { text: "힘 +1",      apply: () => { state.str += 1; },  weight: 7 },
    { text: "힘 +5",      apply: () => { state.str += 5; },  weight: 7 },
    { text: "힘 +10",     apply: () => { state.str += 10; }, weight: 3 },

    { text: "체력 +1",    apply: () => { state.hp += 1; },   weight: 7 },
    { text: "체력 +5",    apply: () => { state.hp += 5; },   weight: 7 },
    { text: "체력 +10",   apply: () => { state.hp += 10; },  weight: 3 },

    { text: "회피 +1",    apply: () => { state.dex += 1; },  weight: 7 },
    { text: "회피 +5",    apply: () => { state.dex += 5; },  weight: 7 },
    { text: "회피 +10",   apply: () => { state.dex += 10; }, weight: 3 },

    { text: "방어 +1",    apply: () => { state.def += 1; },  weight: 7 },
    { text: "방어 +5",    apply: () => { state.def += 5; },  weight: 7 },
    { text: "방어 +10",   apply: () => { state.def += 10; }, weight: 3 },

    { text: "신앙심 +50", apply: () => { state.faith += 50; }, weight: 5 },
    { text: "신앙심 +100",apply: () => { state.faith += 100; },weight: 1 },

    { text: "목숨 +1",    apply: () => { state.life += 1; }, weight: 2 },
    { text: "목숨 +2",    apply: () => { state.life += 2; }, weight: 1 },
    { text: "목숨 +3",    apply: () => { state.life += 3; }, weight: 1.82 },

    { text: "Starbucks Gift Card $5",  apply: () => {}, weight: 0.5 },
    { text: "Starbucks Gift Card $10", apply: () => {}, weight: 0.05 },
    { text: "Starbucks Gift Card $20", apply: () => {}, weight: 0.01 },

    { text: "Amazon Gift Card $10",    apply: () => {}, weight: 0.05 },
    { text: "Amazon Gift Card $20",    apply: () => {}, weight: 0.01 },

    { text: "Google Play Gift Card $5",  apply: () => {}, weight: 0.5 },
    { text: "Google Play Gift Card $10", apply: () => {}, weight: 0.05 },
    { text: "Google Play Gift Card $20", apply: () => {}, weight: 0.01 },

    { text: "꽝", apply: () => {}, weight: 20 }
  ];

  function rollGacha() {
    if (state.faith < gachaCost) {
      showToast("신앙심이 부족합니다! (100F 필요)");
      return;
    }

    state.faith -= gachaCost;

    // 가중치 랜덤
    const total = gachaTable.reduce((s, x) => s + x.weight, 0);
    let r = Math.random() * total;
    let chosen = gachaTable[gachaTable.length - 1];

    for (const entry of gachaTable) {
      if (r < entry.weight) {
        chosen = entry;
        break;
      }
      r -= entry.weight;
    }

    // 효과 적용
    chosen.apply();
    renderHeader();
    updateShopFaithText();

    // 폭죽 + 알림
    confettiEffect();
    showToast("랜덤 뽑기 결과: " + chosen.text);

    saveGame(true); // 조용히 자동 저장
  }

  // ====== 저장 ======
  async function saveGame(silent = false) {
    if (!playerId) {
      if (!silent) alert("로그인 정보가 없습니다. index.html에서 다시 로그인 해주세요.");
      return;
    }

    // 로컬에도 업데이트
    localStorage.setItem("pilgrimSaveData", JSON.stringify(state));

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          type: "save",
          id: playerId,
          saveData: state
        })
      });

      const text = await res.text();
      if (!silent) {
        if (text === "saved") {
          showToast("저장 완료!");
        } else {
          showToast("저장 실패: " + text);
        }
      }
    } catch (err) {
      if (!silent) alert("저장 중 오류가 발생했습니다.");
    }
  }

  // ====== 간단한 토스트 & 폭죽 ======
  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
  }

  function confettiEffect() {
    const duration = 1500;
    const end = Date.now() + duration;

    (function frame() {
      const colors = ["#ffcc00", "#ff6699", "#66ccff", "#99ff66", "#ff9966"];
      const conf = document.createElement("div");
      conf.style.position = "fixed";
      conf.style.top = (Math.random() * 40) + "%";
      conf.style.left = (Math.random() * 80 + 10) + "%";
      conf.style.width = "8px";
      conf.style.height = "14px";
      conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      conf.style.opacity = "0.95";
      conf.style.transform = "rotate(" + (Math.random()*360) + "deg)";
      conf.style.transition = "transform 1s ease-out, top 1s ease-out, opacity 1s";
      conf.style.zIndex = 30;
      document.body.appendChild(conf);

      setTimeout(() => {
        conf.style.top = "100%";
        conf.style.opacity = "0";
        conf.style.transform += " translateY(20px) rotate(720deg)";
      }, 10);

      setTimeout(() => conf.remove(), 1800);

      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  // ====== 초기 실행 ======
  renderHeader();
  renderStory();
</script>
</body>
</html>
