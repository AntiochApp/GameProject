<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Pilgrim's Journey ‚Äì Game</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Georgia", system-ui, sans-serif;
      background: url('bg_game.png') center/cover no-repeat fixed;
    }

    .overlay {
      background: rgba(0,0,0,0.35);
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
      padding: 16px;
      position: relative;
    }

    /* ÏÉÅÎã® Î∞î */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(30,30,30,0.95);
      color: #f5f5f5;
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
      margin-bottom: 10px;
    }

    .player-info {
      font-size: 14px;
      white-space: nowrap;
    }

    .player-info strong {
      font-size: 16px;
      margin-right: 6px;
    }

    .stats {
      font-size: 13px;
      opacity: 0.9;
    }

    .top-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-top {
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      background: #8e5b32;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    }
    .btn-top.chat { background: #5c6bc0; }
    .btn-top.save { background: #407a3b; }
    .btn-top:hover { filter: brightness(1.05); }

    /* ÎØ∏Îãà Ï±ÑÌåÖ Î∞î */
    .chat-mini-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .chat-mini {
      width: min(900px, 90vw);
      background: rgba(20, 20, 20, 0.9);
      border-radius: 14px;
      padding: 6px 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.06);
      font-size: 12px;
      color: #f5f2e9;
    }
    .chat-mini-line {
      display: flex;
      gap: 6px;
      align-items: baseline;
      line-height: 1.3;
    }
    .chat-mini-name {
      color: #ffe082;
      font-weight: 700;
      white-space: nowrap;
    }
    .chat-mini-text {
      color: #fefefe;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .chat-mini-empty {
      color: #999;
      font-style: italic;
      text-align: center;
    }

    /* Ïä§ÌÜ†Î¶¨ Ïπ¥Îìú Ï†ÑÏ≤¥ */
    .story-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 8px;
    }

    .story-card {
      width: min(900px, 90vw);
      background: rgba(255,255,245,0.96);
      border-radius: 18px;
      padding: 20px 26px 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
      border: 1px solid rgba(220,200,160,0.9);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .story-inner {
      position: relative;
      z-index: 1;
      min-height: 140px;
    }

    /* Ïä§ÌÜ†Î¶¨ VIEW */
    #storyView {
      display: block;
    }
    #battleView {
      display: none;
    }

    .story-ko {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #3a2a16;
      white-space: pre-line;
    }

    .story-en {
      font-size: 14px;
      color: #665544;
      margin-bottom: 16px;
      white-space: pre-line;
    }

    .choice-container {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .choice-btn {
      text-align: left;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #c9b289;
      background: linear-gradient(90deg, #fdf5e6, #f5e4c6);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .choice-btn::before {
      content: "‚ñ∂";
      margin-right: 6px;
      color: #b07a3b;
    }
    .choice-btn:hover {
      filter: brightness(1.04);
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }

    /* Ï†ÑÌà¨ VIEW (Í≥†Ï†Ñ RPG ÎäêÎÇå) */
    .battle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .battle-title {
      font-size: 18px;
      font-weight: 700;
      color: #3b2615;
    }
    .battle-turn {
      font-size: 12px;
      color: #7a5b34;
    }

    .battle-stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-bottom: 8px;
    }
    .battle-box {
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid #d8c6a4;
      font-size: 13px;
    }
    .battle-name {
      font-weight: 700;
      margin-bottom: 4px;
      color: #4b2d16;
    }
    .hp-bar-wrap {
      width: 100%;
      height: 10px;
      background: #eee0c7;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 2px;
      margin-bottom: 4px;
    }
    .hp-bar {
      height: 100%;
      background: linear-gradient(90deg,#e53935,#ffb74d);
      width: 100%;
    }
    .battle-line {
      font-size: 12px;
      color: #5d4037;
    }

    .battle-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 4px;
    }
    .battle-btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.25);
    }
    .battle-btn.attack { background:#8e5b32; color:#fff; }
    .battle-btn.run    { background:#b0bec5; color:#263238; }
    .battle-btn.pray   { background:#5c6bc0; color:#fff; }
    .battle-btn:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    .battle-log {
      margin-top: 6px;
      background: #fff8e1;
      border-radius: 10px;
      border: 1px solid #e0c38a;
      padding: 8px 10px;
      font-size: 12px;
      max-height: 120px;
      overflow-y: auto;
    }

    /* Í≥µÌÜµ Î°úÍ∑∏ Ìå®ÎÑê (Ïä§ÌÜ†Î¶¨/Ï†ÑÌà¨ ÏöîÏïΩ) */
    .log-panel {
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      border: 1px solid rgba(214,189,135,0.9);
      padding: 6px 10px;
      font-size: 12px;
      color: #4a3a1e;
      max-height: 80px;
      overflow-y: auto;
    }
    .log-empty {
      color: #a1887f;
      font-style: italic;
    }

    /* Í≥µÌÜµ Î™®Îã¨ Î∞∞Í≤Ω */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    /* ÏÉÅÏ†ê Î™®Îã¨ */
    .modal {
      background: #f8f4ec;
      border-radius: 18px;
      padding: 20px 24px 24px;
      width: min(640px, 95vw);
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      border: 2px solid #b7935d;
      overflow-y: auto;
      max-height: 90vh;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #54351c;
    }

    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 22px;
      font-weight: bold;
    }

    .shop-faith {
      font-size: 13px;
      color: #333;
      margin-bottom: 8px;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 14px;
    }

    .shop-item {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: 1px solid #e2d2b4;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 80px;
    }

    .shop-item-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #3b2615;
    }

    .shop-item-cost {
      font-size: 12px;
      color: #7a5b34;
      margin-bottom: 6px;
    }

    .shop-buy-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      align-self: flex-end;
      background: #8e5b32;
      color: #fff;
    }
    .shop-buy-btn:hover { filter: brightness(1.05); }

    .gacha-section {
      border-top: 1px dashed #c7b08a;
      padding-top: 8px;
      margin-top: 6px;
      text-align: center;
    }

    .gacha-btn {
      margin-top: 6px;
      padding: 10px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      background: linear-gradient(90deg,#f2a93b,#ff6f61);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }
    .gacha-btn:hover { filter: brightness(1.05); }

    .gacha-desc {
      font-size: 12px;
      color: #7a5b34;
    }

    .gacha-log-box {
      margin-top: 10px;
      margin-bottom: 10px;
      background:#fff7e0;
      padding:10px;
      border-radius:10px;
      border:1px solid #d8c6a4;
      max-height:100px;
      overflow-y:auto;
      font-size:13px;
    }

    /* Ï±ÑÌåÖ Î™®Îã¨ */
    .chat-modal {
      background: radial-gradient(circle at top, #f9f0dc 0%, #e6d4b2 40%, #d0b58a 100%);
      border-radius: 20px;
      padding: 20px 22px 18px;
      width: min(640px, 95vw);
      box-shadow: 0 12px 32px rgba(0,0,0,0.7);
      border: 2px solid #8d6e3c;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .chat-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .chat-modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #4a2c12;
      letter-spacing: 1px;
    }

    .chat-modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-height: 260px;
    }

    .chat-messages {
      flex: 1;
      background: rgba(255,255,255,0.65);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(139,87,42,0.35);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .chat-row {
      display: flex;
      flex-direction: column;
      max-width: 80%;
    }
    .chat-row.me {
      align-self: flex-end;
      text-align: right;
    }
    .chat-row.other {
      align-self: flex-start;
      text-align: left;
    }

    .chat-name {
      font-size: 11px;
      color: #6d4c41;
      margin-bottom: 2px;
      opacity: 0.9;
    }

    .chat-bubble {
      padding: 6px 10px;
      border-radius: 12px;
      line-height: 1.3;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      word-break: break-word;
    }

    .chat-row.me .chat-bubble {
      background: #8e5b32;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .chat-row.other .chat-bubble {
      background: rgba(255,255,255,0.95);
      color: #3e2723;
      border-bottom-left-radius: 4px;
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .chat-input-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #b19063;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      background: rgba(255,255,255,0.9);
    }
    .chat-input-row input:focus {
      border-color: #8e5b32;
      box-shadow: 0 0 0 2px rgba(142,91,50,0.2);
    }

    .chat-send-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #8e5b32;
      color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    }
    .chat-send-btn:hover { filter: brightness(1.05); }

    .chat-empty {
      font-size: 12px;
      color: #8d6e63;
      text-align: center;
      margin-top: 12px;
    }

    /* Í≤åÏûÑ Ïò§Î≤Ñ Ïò§Î≤ÑÎ†àÏù¥ */
    .gameover-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .gameover-card {
      text-align: center;
      color: #fff;
    }
    .gameover-title {
      font-size: 48px;
      font-weight: 900;
      letter-spacing: 4px;
      margin-bottom: 10px;
    }
    .gameover-sub {
      font-size: 18px;
      opacity: 0.85;
    }

    /* ÌÜ†Ïä§Ìä∏ */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out;
      z-index: 50;
    }
    .toast.show { opacity: 1; }
  </style>
</head>

<body>
<div class="overlay">

  <!-- ÏÉÅÎã® Î∞î -->
  <div class="top-bar">
    <div class="player-info">
      <strong id="playerName">Player: Î°úÍ∑∏Ïù∏</strong>
      <span class="stats" id="statLine"></span>
    </div>
    <div class="top-buttons">
      <button class="btn-top chat" onclick="openChat()">Ï±ÑÌåÖ</button>
      <button class="btn-top" onclick="openShop()">ÏÉÅÏ†ê</button>
      <button class="btn-top save" onclick="saveGame()">Ï†ÄÏû•</button>
    </div>
  </div>

  <!-- ÎØ∏Îãà Ï±ÑÌåÖ Î∞î -->
  <div class="chat-mini-wrapper">
    <div class="chat-mini" id="chatMini">
      <div class="chat-mini-empty">Ï±ÑÌåÖÏù¥ ÏïÑÏßÅ ÏóÜÏäµÎãàÎã§. ÏπúÍµ¨Îì§ÏóêÍ≤å Î®ºÏ†Ä ÎßêÏùÑ Í±∏Ïñ¥Î≥¥ÏÑ∏Ïöî!</div>
    </div>
  </div>

  <!-- Ïä§ÌÜ†Î¶¨ + Ï†ÑÌà¨ Ïπ¥Îìú -->
  <div class="story-wrapper">
    <div class="story-card">

      <div class="story-inner">

        <!-- Ïä§ÌÜ†Î¶¨ VIEW -->
        <div id="storyView">
          <div class="story-ko" id="storyKo">Ïä§ÌÜ†Î¶¨Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</div>
          <div class="story-en" id="storyEn">The story text will appear here.</div>
          <div id="choiceContainer" class="choice-container"></div>
        </div>

        <!-- Ï†ÑÌà¨ VIEW (Í≥†Ï†Ñ RPG Ïä§ÌÉÄÏùº) -->
        <div id="battleView">
          <div class="battle-header">
            <div class="battle-title" id="battleTitle">Ï†ÑÌà¨</div>
            <div class="battle-turn" id="battleTurnText">Turn 1</div>
          </div>

          <div class="battle-stats">
            <div class="battle-box">
              <div class="battle-name" id="playerBattleName">Player</div>
              <div class="battle-line" id="playerBattleHpText">HP 10 / 10</div>
              <div class="hp-bar-wrap">
                <div class="hp-bar" id="playerHpBar"></div>
              </div>
              <div class="battle-line" id="playerBattleStats">
                STR 1 | DEX 1 | DEF 1 | LIFE 1
              </div>
            </div>

            <div class="battle-box">
              <div class="battle-name" id="enemyBattleName">Enemy</div>
              <div class="battle-line" id="enemyBattleHpText">HP 10 / 10</div>
              <div class="hp-bar-wrap">
                <div class="hp-bar" id="enemyHpBar"></div>
              </div>
              <div class="battle-line" id="enemyBattleStats">
                ATK ? | DEX ? | DEF ?
              </div>
            </div>
          </div>

          <div class="battle-actions">
            <button class="battle-btn attack" onclick="rpgAttack()">‚öî Í≥µÍ≤©</button>
            <button class="battle-btn pray" id="prayBtn" onclick="usePrayerSkill()">üôè Í∏∞ÎèÑ Ïä§ÌÇ¨</button>
            <button class="battle-btn run" onclick="rpgRun()">üèÉ ÎèÑÎßù</button>
          </div>

          <div class="battle-log" id="battleLog">
            Ï†ÑÌà¨Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.
          </div>
        </div>

      </div>

      <!-- ÌïòÎã® Î°úÍ∑∏ Ìå®ÎÑê -->
      <div class="log-panel" id="logPanel">
        <div class="log-empty">ÏïÑÏßÅ Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>
      </div>
    </div>
  </div>

  <!-- ÏÉÅÏ†ê Î™®Îã¨ -->
  <div class="modal-backdrop" id="shopBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>Pilgrim ÏÉÅÏ†ê</h2>
        <button class="modal-close" onclick="closeShop()">√ó</button>
      </div>

      <div class="shop-faith" id="shopFaithText"></div>

      <div id="randomLogBox" class="gacha-log-box">
        <p style="margin:0; color:#999;">ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>
      </div>

      <div class="shop-grid" id="shopGrid"></div>

      <div class="gacha-section">
        <div class="gacha-desc">ÎûúÎç§ ÎΩëÍ∏∞ (50F) ‚Äì ÌÅ∞ Î≥¥ÏÉÅ ÎòêÎäî ÍΩù!</div>
        <button class="gacha-btn" onclick="rollGacha()">‚ú® ÎûúÎç§ ÎΩëÍ∏∞ ‚ú®</button>
      </div>
    </div>
  </div>

  <!-- Ï±ÑÌåÖ Î™®Îã¨ -->
  <div class="modal-backdrop" id="chatBackdrop">
    <div class="chat-modal">
      <div class="chat-modal-header">
        <h2>Prayer Chat</h2>
        <button class="modal-close" onclick="closeChat()">√ó</button>
      </div>
      <div class="chat-modal-body">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-row">
          <input id="chatInput" type="text" maxlength="100"
                 placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÍ≥† EnterÎ•º ÎàåÎü¨Î≥¥ÏÑ∏Ïöî. (ÏµúÎåÄ 100Ïûê)">
          <button class="chat-send-btn" onclick="sendChat()">Î≥¥ÎÇ¥Í∏∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- GAME OVER Ïò§Î≤ÑÎ†àÏù¥ -->
  <div class="gameover-backdrop" id="gameOverOverlay">
    <div class="gameover-card">
      <div class="gameover-title">GAME OVER</div>
      <div class="gameover-sub">3Ï¥à ÌõÑ Ï≤òÏùåÏúºÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§...</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

</div>

<script>
  /* ---------------- Í∏∞Î≥∏ ÏÑ§Ï†ï ---------------- */

  const API_URL = "https://script.google.com/macros/s/AKfycbwUqF_7np5AgJTygWKEn8diNyiFmvAnHaSsY0Xz3zVMuw5bGnn6y2Wr35zmq-w_ZuHyTQ/exec";

  let playerId   = localStorage.getItem("pilgrimPlayerId")   || "";
  let playerName = localStorage.getItem("pilgrimPlayerName") || "Î°úÍ∑∏Ïù∏";

  const defaultState = {
    str: 1,
    hp: 10,
    maxHp: 10,
    dex: 1,
    def: 1,
    life: 1,
    faith: 0,
    storyKey: "0-0",
    branch: 0
  };

  let state = { ...defaultState };

  try {
    const saved = JSON.parse(localStorage.getItem("pilgrimSaveData") || "null");
    if (saved) {
      state = Object.assign({}, defaultState, saved);
    }
  } catch(e){}

  if (!state.maxHp) state.maxHp = state.hp || 10;
  if (!state.storyKey) state.storyKey = "0-0";
  if (state.life == null) state.life = 1;

  /* ---------------- Î°úÍ∑∏ ---------------- */

  const logLines = [];

  function addLog(msg){
    const time = new Date().toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"});
    logLines.unshift(`${time} - ${msg}`);
    if (logLines.length > 40) logLines.pop();

    const box = document.getElementById("logPanel");
    if (!logLines.length) {
      box.innerHTML = `<div class="log-empty">ÏïÑÏßÅ Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>`;
      return;
    }
    box.innerHTML = logLines.map(line=>`<div>‚Ä¢ ${line}</div>`).join("");
  }

  /* ---------------- Ïä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ ---------------- */

  const scenes = {
    "0-0": {
      id: "0-0",
      branch: 0,
      random: false,
      ko: `ÏÑ∏ÏÉÅÏóêÎäî Ï£ÑÍ∞Ä ÎßåÏó∞ÌïòÍ≥† ÏûàÎã§. Î¨¥ÏóáÏù¥ Ï£ÑÏù∏Í∞Ä? Î¨¥ÏóáÏù¥ ÎèÑÎçïÏù∏Í∞Ä? ÏÇ¨ÎûåÎì§ÏùÄ Ïù∏Í∂åÏù¥ÎùºÎäî ÎØ∏Î™Ö ÏïÑÎûò, ÏÑúÏÑúÌûà ÌÉÄÎùΩÌïòÍ≥† ÏûàÎã§.
Ïù¥Îü¨Ìïú ÏÑ∏ÏÉÅ ÏÜçÏóêÏÑú‚Ä¶ ÎÇòÎäî ÎåÄÏ≤¥ Ïñ¥ÎñªÍ≤å Ìï¥Ïïº ÌïòÎäîÍ∞Ä?

{name}Îãò, ÎãπÏã†ÏùÄ ÌòÑÏû¨ 'ÏÜåÎèî'Ïù¥ÎùºÎäî ÌÉÄÎùΩÌïú ÎèÑÏãúÏóê Í±∞Ï£ºÌïòÍ≥† ÏûàÏäµÎãàÎã§.
ÎãπÏã†ÏùÄ ÏÜåÎèîÏóê Í≥ÑÏÜç Î®∏Î¨¥ÏãúÍ≤†ÏäµÎãàÍπå? ÏïÑÎãàÎ©¥ Îñ†ÎÇòÏãúÍ≤†ÏäµÎãàÍπå?`,
      en: `Sin is everywhere in this world. People slowly fall into darkness in the name of "human rights."
In this world, what should I do?

{name}, you are now living in the corrupted city of Sodom.
Will you stay in Sodom, or will you leave?`,
      choices: [
        {
          text: "1. ÏÜåÎèîÏóê ÎÇ®ÎäîÎã§ (Stay in Sodom)",
          action: () => {
            state.branch = 1;
            addLog("ÎãπÏã†ÏùÄ ÏÜåÎèîÏóê ÎÇ®Í∏∞Î°ú Í≤∞Ï†ïÌñàÏäµÎãàÎã§.");
            gotoScene("1-1");
          }
        },
        {
          text: "2. ÏÜåÎèîÏùÑ Îñ†ÎÇúÎã§ (Leave Sodom)",
          action: () => {
            state.branch = 2;
            addLog("ÎãπÏã†ÏùÄ ÏÜåÎèîÏùÑ Îñ†ÎÇòÍ∏∞Î°ú Í≤∞Ï†ïÌñàÏäµÎãàÎã§.");
            gotoScene("2-1");
          }
        }
      ]
    },

    "1-1": {
      id: "1-1",
      branch: 1,
      random: false,
      ko: `ÏßëÏóê ÏùåÏãùÏù¥ ÏóÜÏñ¥ÏÑú, ÎßàÌä∏Î°ú Ìñ•ÌïòÍ≥† ÏûàÏäµÎãàÎã§.
Í∑∏Îü∞Îç∞ ÏïûÏóêÏÑú ÎßàÏ£º Ïò§Îçò Í∞ôÏùÄ ÏÑ±Î≥ÑÏùò ÏÇ¨ÎûåÏù¥ {name}ÎãòÏùÑ Î≥¥ÎçîÎãà,
ÏúôÌÅ¨Î•º ÌïòÎ©∞ Îã§Í∞ÄÏôÄ Ïú†ÌòπÌïòÍ∏∞ ÏãúÏûëÌï©ÎãàÎã§.

{player}Îãò, Ïñ¥ÎñªÍ≤å ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`,
      en: `You are heading to the market because there is no food at home.
Suddenly, someone of the same gender walks toward you,
winks at you, and tries to tempt you.

What will you do, {player}?`,
      choices: [
        {
          text: "1. Ìï®ÍªòÌïúÎã§ (Go with them)",
          action: () => {
            addLog("Ïú†ÌòπÏóê Îî∞ÎùºÍ∞îÏäµÎãàÎã§... ÏòÅÏ†Å, Ïú°Ï†ÅÏúºÎ°ú ÏßÄÏ≥ê HPÍ∞Ä 10 Í∞êÏÜåÌï©ÎãàÎã§.");
            applyDamage(10, "Ïú†ÌòπÏóê ÎÑòÏñ¥Í∞ê");
            gotoRandomStoryInBranch(1);
          }
        },
        {
          text: "2. Ïã∏Ïö¥Îã§ (Fight ‚Äì Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥)",
          action: () => {
            addLog("Ïã∏Ïö∞Í∏∞Î°ú Í≤∞Ïã¨ÌñàÏäµÎãàÎã§. Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ Ï†ÑÌà¨Í∞Ä ÏãúÏûëÎê©ÎãàÎã§.");
            startRpsBattle();
          }
        },
        {
          text: "3. ÎèÑÎßùÍ∞ÑÎã§ (Run away)",
          action: () => {
            attemptEncounterEscape();
          }
        }
      ]
    },

    "2-1": {
      id: "2-1",
      branch: 2,
      random: false,
      ko: `ÎãπÏã†ÏùÄ ÏÜåÎèîÏùÑ Îñ†ÎÇò Í¥ëÏïº Í∏∏ÏùÑ Í±∑Í∏∞ ÏãúÏûëÌñàÏäµÎãàÎã§.
Îí§Î•º ÎèåÏïÑÎ≥¥Î©¥ Ïó¨Ï†ÑÌûà Î∂àÎπõÍ≥º ÏÜåÏùåÏù¥ Í∞ÄÎìùÌïú ÎèÑÏãúÍ∞Ä Î≥¥ÏûÖÎãàÎã§.
Í∑∏Îü¨ÎÇò ÎßàÏùå ÌïúÌé∏ÏóêÎäî Ïù¥ÏÉÅÌïú ÌèâÏïàÏù¥ Ï∞æÏïÑÏòµÎãàÎã§.

Ïù¥Ï†ú Ïñ¥ÎîîÎ°ú Í∞ÄÏïº Ìï†ÍπåÏöî?`,
      en: `You leave Sodom and begin walking through the wilderness.
Behind you, the city is still full of noise and lights,
but deep in your heart, a strange peace begins to grow.

Where will you go now?`,
      choices: [
        {
          text: "1. ÌïòÎÇòÎãòÍªò Í∏∞ÎèÑÌïòÎ©∞ Í∏∏ÏùÑ Î¨ªÎäîÎã§ (Pray and ask God for direction)",
          action: () => {
            state.faith += 5;
            addLog("ÌïòÎÇòÎãòÍªò Í∏∞ÎèÑÌñàÏäµÎãàÎã§. Ïã†ÏïôÏã¨ +5");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(2);
          }
        },
        {
          text: "2. Í∑∏ÎÉ• ÏïûÏóê Î≥¥Ïù¥Îäî Í∏∏Î°ú Í∞ÑÎã§ (Just follow the road)",
          action: () => {
            addLog("ÏïÑÎ¨¥ Í≥ÑÌöç ÏóÜÏù¥ Í∏∏ÏùÑ Îî∞Îùº Í±∑ÏäµÎãàÎã§...");
            gotoRandomStoryInBranch(2);
          }
        }
      ]
    },

    /* Î∏åÎûúÏπò 1 ÎûúÎç§ ÏòàÏãú */
    "1-R1": {
      id: "1-R1",
      branch: 1,
      random: true,
      ko: `ÏÜåÎèîÏùò Î∞§Í±∞Î¶¨Î•º Í±∏ÏúºÎ©∞, {name}ÎãòÏùÄ ÌïòÎäòÏùò Î≥ÑÏùÑ Ïò¨Î†§Îã§Î¥ÖÎãàÎã§.
Ïù¥ ÎèÑÏãúÏùò Ï£ÑÏïÖ Í∞ÄÏö¥Îç∞ÏÑúÎèÑ, ÌïòÎÇòÎãòÏùÄ Ïó¨Ï†ÑÌûà ÌïòÎäòÏóêÏÑú Îã§ Î≥¥Í≥† Í≥ÑÏã≠ÎãàÎã§.`,
      en: `{name} walks through the night streets of Sodom and looks up at the stars.
Even in this sinful city, God is still watching from heaven.`,
      choices: [
        {
          text: "Í∏∞ÎèÑÌïòÎ©∞ ÌöåÍ∞úÌïúÎã§ (Pray and repent)",
          action: () => {
            state.faith += 3;
            addLog("ÌöåÍ∞úÏùò Í∏∞ÎèÑÎ•º ÎìúÎ†∏ÏäµÎãàÎã§. Ïã†ÏïôÏã¨ +3");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(1);
          }
        }
      ]
    },

    "1-R2": {
      id: "1-R2",
      branch: 1,
      random: true,
      ko: `ÏπúÍµ¨Îì§Ïù¥ {name}ÎãòÏùÑ Î∂àÎü¨ Ïà†ÏûêÎ¶¨Ïóê Ï¥àÎåÄÌñàÏäµÎãàÎã§.
Î∂ÑÏúÑÍ∏∞Îäî Ï†êÏ†ê Í≥ºÍ≤©Ìï¥ÏßÄÍ≥†, ÌïòÎÇòÎãòÏùÑ Ï°∞Î°±ÌïòÎäî ÎßêÍπåÏßÄ ÎÇòÏòµÎãàÎã§.`,
      en: `Some friends invite {name} to a drinking party.
The atmosphere gets wilder, and they even begin to mock God.`,
      choices: [
        {
          text: "Ï°∞Ïö©Ìûà ÏûêÎ¶¨Î•º Îñ†ÎÇúÎã§ (Quietly leave)",
          action: () => {
            state.faith += 2;
            addLog("Ïú†ÌòπÏùÑ ÎøåÎ¶¨ÏπòÍ≥† ÏûêÎ¶¨Î•º Îñ†ÎÇ¨ÏäµÎãàÎã§. Ïã†ÏïôÏã¨ +2");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(1);
          }
        },
        {
          text: "Í∞ôÏù¥ Ïà†ÏùÑ ÎßàÏã†Îã§ (Drink with them)",
          action: () => {
            addLog("ÏòÅÏ†ÅÏúºÎ°ú ÏßÄÏ≥ê Í∞ëÎãàÎã§... HP 2 Í∞êÏÜå.");
            applyDamage(2, "Ïà†ÏûêÎ¶¨ÏóêÏÑú ÏßÄÏπ®");
            gotoRandomStoryInBranch(1);
          }
        }
      ]
    },

    /* Î∏åÎûúÏπò 2 ÎûúÎç§ ÏòàÏãú */
    "2-R1": {
      id: "2-R1",
      branch: 2,
      random: true,
      ko: `Í¥ëÏïºÏóêÏÑú Í∏∏ÏùÑ ÏûÉÏùÄ Í≤ÉÎßå Í∞ôÏßÄÎßå,
{surname}ÎãòÏùÄ ÎßàÏùåÏÜçÏúºÎ°ú Ï°∞Ïö©Ìûà ÏãúÌé∏ 23Ìé∏ÏùÑ Îñ†Ïò¨Î¶ΩÎãàÎã§.`,
      en: `You seem lost in the wilderness,
but quietly in your heart, you recall Psalm 23.`,
      choices: [
        {
          text: "‚ÄúÏó¨Ìò∏ÏôÄÎäî ÎÇòÏùò Î™©ÏûêÏãúÎãà‚Ä¶‚ÄùÎ•º Î¨µÏÉÅÌïúÎã§",
          action: () => {
            state.faith += 4;
            addLog("ÎßêÏîÄÏùÑ Î¨µÏÉÅÌïòÎ©∞ ÏúÑÎ°úÎ•º Î∞õÏïòÏäµÎãàÎã§. Ïã†ÏïôÏã¨ +4");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(2);
          }
        }
      ]
    },

    "2-R2": {
      id: "2-R2",
      branch: 2,
      random: true,
      ko: `Î©ÄÎ¶¨ÏÑú ÏûëÏùÄ ÎßàÏùÑ ÌïòÎÇòÍ∞Ä Î≥¥ÏûÖÎãàÎã§.
Í∑∏Í≥≥ÏóêÎäî ÌïòÎÇòÎãòÏùÑ ÏòàÎ∞∞ÌïòÎäî Í≥µÎèôÏ≤¥Í∞Ä ÏûàÎã§Îäî ÏÜåÎ¨∏ÏùÑ Îì§ÏóàÏäµÎãàÎã§.`,
      en: `In the distance, you see a small village.
You heard that there is a community there that worships God.`,
      choices: [
        {
          text: "ÎßàÏùÑÎ°ú Îì§Ïñ¥Í∞Ä Î≥∏Îã§",
          action: () => {
            addLog("ÏÉàÎ°úÏö¥ ÎØøÏùåÏùò Í≥µÎèôÏ≤¥Î•º Ìñ•Ìï¥ Í±∏ÏùåÏùÑ ÏòÆÍπÅÎãàÎã§.");
            gotoRandomStoryInBranch(2);
          }
        }
      ]
    },

    /* ÏòàÏãú: RPG Ï†ÑÌà¨ ÌÖåÏä§Ìä∏Ïö© Ïä§ÌÜ†Î¶¨ (ÎÇòÏ§ëÏóê JSONÏóêÏÑú Ìò∏Ï∂ú Í∞ÄÎä•) */
    "2-BATTLE-TEST": {
      id: "2-BATTLE-TEST",
      branch: 2,
      random: true,
      ko: `Í¥ëÏïº ÌïúÍ∞ÄÏö¥Îç∞, Ïù¥ÏÉÅÌïòÍ≤åÎèÑ Ïñ¥ÎëêÏö¥ Í∑∏Î¶ºÏûêÍ∞Ä Îã§Í∞ÄÏòµÎãàÎã§.
{name}Îãò ÏïûÏóê Ïïå Ïàò ÏóÜÎäî Ï†ÅÏù¥ ÏÑú ÏûàÏäµÎãàÎã§.`,
      en: `In the middle of the wilderness, a strange shadow appears.
An unknown enemy stands before {name}.`,
      choices: [
        {
          text: "‚öî Ïã∏Ïö¥Îã§ (Start RPG Battle)",
          action: () => {
            // JSONÏóêÏÑúÎäî Ïó¨Í∏∞Ï≤òÎüº startRpgBattleWithName('Enemy Name') Îßå Ìò∏Ï∂úÌï¥ Ï£ºÎ©¥ Îê®
            startRpgBattleWithName("Ïñ¥ÎëêÏö¥ Í∑∏Î¶ºÏûê");
          }
        },
        {
          text: "üèÉ ÎèÑÎßùÍ∞ÑÎã§",
          action: () => {
            attemptEncounterEscape();
          }
        }
      ]
    }
  };

  /* ---------------- Ïä§ÌÜ†Î¶¨ Î†åÎçîÎßÅ ---------------- */

  function replaceName(text) {
    if (!text) return "";
    return text
      .replace(/\{name\}/g, playerName)
      .replace(/\{player\}/g, playerName)
      .replace(/\{surname\}/g, playerName);
  }

  function showStoryView() {
    document.getElementById("storyView").style.display = "block";
    document.getElementById("battleView").style.display = "none";
  }

  function showBattleView() {
    document.getElementById("storyView").style.display = "none";
    document.getElementById("battleView").style.display = "block";
  }

  function renderScene(scene) {
    showStoryView();
    document.getElementById("storyKo").textContent = replaceName(scene.ko);
    document.getElementById("storyEn").textContent = replaceName(scene.en);

    const choiceBox = document.getElementById("choiceContainer");
    choiceBox.innerHTML = "";

    if (scene.choices && scene.choices.length) {
      scene.choices.forEach((choice) => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = choice.text;
        btn.onclick = () => choice.action();
        choiceBox.appendChild(btn);
      });
    } else {
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = "Í≥ÑÏÜç ÏßÑÌñâ";
      btn.onclick = () => gotoRandomStoryInBranch(state.branch || 1);
      choiceBox.appendChild(btn);
    }
  }

  function gotoScene(id) {
    const scene = scenes[id];
    if (!scene) {
      addLog("ÏïÑÏßÅ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏùÄ Ïä§ÌÜ†Î¶¨ÏûÖÎãàÎã§. (" + id + ")");
      return;
    }
    state.storyKey = id;
    if (scene.branch != null) state.branch = scene.branch;
    renderScene(scene);
    saveGame(true);
  }

  function gotoRandomStoryInBranch(branch) {
    const pool = Object.values(scenes).filter(
      (s) => s.branch === branch && s.random
    );
    if (!pool.length) {
      const fallback = branch === 1 ? "1-1" : "2-1";
      gotoScene(fallback);
      return;
    }
    const idx = Math.floor(Math.random() * pool.length);
    const chosen = pool[idx];
    gotoScene(chosen.id);
  }

  /* ---------------- HP / LIFE / GAME OVER ---------------- */

  function updateHpBars() {
    const playerHpBar = document.getElementById("playerHpBar");
    const playerHpText = document.getElementById("playerBattleHpText");
    const playerStats = document.getElementById("playerBattleStats");

    if (playerHpBar && state.maxHp > 0) {
      const ratio = Math.max(0, Math.min(1, state.hp / state.maxHp));
      playerHpBar.style.width = (ratio * 100) + "%";
    }
    if (playerHpText) {
      playerHpText.textContent = `HP ${state.hp} / ${state.maxHp}`;
    }
    if (playerStats) {
      playerStats.textContent =
        `STR ${state.str} | DEX ${state.dex} | DEF ${state.def} | LIFE ${state.life}`;
    }
  }

  function applyDamage(amount, reason) {
    amount = Math.max(0, Math.floor(amount));
    if (amount <= 0) return;

    state.hp -= amount;
    if (state.hp < 0) state.hp = 0;
    addLog(`HP ${amount} Í∞êÏÜå (${reason || "ÌîºÌï¥"}) ‚Äì ÌòÑÏû¨ HP ${state.hp}/${state.maxHp}`);

    updateHpBars();
    renderHeader();
    saveGame(true);

    if (state.hp <= 0) {
      handleHpZero();
    }
  }

  function healHp(amount, reason) {
    amount = Math.max(0, Math.floor(amount));
    if (amount <= 0) return;
    const old = state.hp;
    state.hp += amount;
    if (state.hp > state.maxHp) state.hp = state.maxHp;
    const real = state.hp - old;
    addLog(`HP ${real} ÌöåÎ≥µ (${reason || "ÌöåÎ≥µ"}) ‚Äì ÌòÑÏû¨ HP ${state.hp}/${state.maxHp}`);
    updateHpBars();
    renderHeader();
    saveGame(true);
  }

  function handleHpZero() {
    state.life -= 1;
    renderHeader();

    if (state.life <= 0) {
      handleGameOver();
      return;
    }

    addLog("HPÍ∞Ä 0Ïù¥ ÎêòÏñ¥ Ìïú Î™©Ïà®ÏùÑ ÏûÉÏóàÏßÄÎßå, Îã§Ïãú ÏùºÏñ¥ÎÇ¨ÏäµÎãàÎã§. (LIFE -1)");
    state.hp = state.maxHp;
    updateHpBars();
    renderHeader();
    saveGame(true);

    // Ï†ÑÌà¨ Ï§ëÏù¥ÏóàÏúºÎ©¥ Ï†ÑÌà¨ Ï¢ÖÎ£å ÌõÑ ÎûúÎç§ Ïä§ÌÜ†Î¶¨Î°ú
    if (battleState.active) {
      battleState.active = false;
      showStoryView();
      gotoRandomStoryInBranch(state.branch || 1);
    }
  }

  function handleGameOver() {
    addLog("GAME OVER ‚Äì Îä•Î†•ÏπòÎäî Ï¥àÍ∏∞ÌôîÎêòÍ≥†, Ïã†ÏïôÏã¨Îßå Ïú†ÏßÄÎê©ÎãàÎã§.");
    const overlay = document.getElementById("gameOverOverlay");
    if (overlay) overlay.style.display = "flex";

    setTimeout(() => {
      const keptFaith = state.faith || 0;
      state = {
        ...defaultState,
        faith: keptFaith
      };
      localStorage.setItem("pilgrimSaveData", JSON.stringify(state));
      renderHeader();
      updateHpBars();
      showStoryView();
      gotoScene("0-0");
      const ov = document.getElementById("gameOverOverlay");
      if (ov) ov.style.display = "none";
      saveGame(true);
    }, 3000);
  }

  /* ---------------- RPG Ï†ÑÌà¨ ÏãúÏä§ÌÖú ---------------- */

  const battleState = {
    active: false,
    turn: 1,
    enemy: null,
    prayerUsed: false,
    prayerBuff: null,
    prayerBuffTurns: 0
  };

  const battleLogLines = [];

  function addBattleLog(msg) {
    battleLogLines.push(msg);
    if (battleLogLines.length > 50) battleLogLines.shift();
    const box = document.getElementById("battleLog");
    if (!box) return;
    box.innerHTML = battleLogLines.map(line => `<div>${line}</div>`).join("");
    box.scrollTop = box.scrollHeight;
  }

  function startRpgBattleWithName(enemyName) {
    // ÌîåÎ†àÏù¥Ïñ¥ Îä•Î†•Ïπò Í∏∞Î∞òÏúºÎ°ú Ï†Å Ïä§ÌÉØ ÏÉùÏÑ±
    const baseStr = Math.max(1, state.str);
    const baseDex = Math.max(1, state.dex);
    const baseDef = Math.max(0, state.def);
    const baseHp  = Math.max(5, state.maxHp);

    const enemyMaxHp = Math.max(5, Math.floor(baseHp * (0.7 + Math.random()*0.6)));
    const enemyAtk   = Math.max(1, Math.floor(baseStr * (0.7 + Math.random()*0.8)));
    const enemyDex   = Math.max(1, Math.floor(baseDex * (0.7 + Math.random()*0.8)));
    const enemyDef   = Math.max(0, Math.floor(baseDef * (0.5 + Math.random()*0.7)));

    battleState.active = true;
    battleState.turn = 1;
    battleState.enemy = {
      name: enemyName || "Ïïå Ïàò ÏóÜÎäî Ï†Å",
      hp: enemyMaxHp,
      maxHp: enemyMaxHp,
      atk: enemyAtk,
      dex: enemyDex,
      def: enemyDef
    };
    battleState.prayerUsed = false;
    battleState.prayerBuff = null;
    battleState.prayerBuffTurns = 0;
    battleLogLines.length = 0;

    document.getElementById("battleTitle").textContent = "Ï†ÑÌà¨ ‚Äì " + enemyName;
    document.getElementById("battleTurnText").textContent = "Turn 1";
    document.getElementById("enemyBattleName").textContent = enemyName;
    document.getElementById("enemyBattleStats").textContent =
      `ATK ${enemyAtk} | DEX ${enemyDex} | DEF ${enemyDef}`;

    const prayBtn = document.getElementById("prayBtn");
    if (prayBtn) prayBtn.disabled = false;

    addBattleLog("Ï†ÑÌà¨Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. (" + enemyName + ")");
    addLog("RPG Ï†ÑÌà¨ ÏãúÏûë ‚Äì " + enemyName);

    updateBattleHud();
    showBattleView();
  }

  function updateBattleHud() {
    const enemy = battleState.enemy;
    updateHpBars(); // ÌîåÎ†àÏù¥Ïñ¥ Ï™Ω

    if (!enemy) return;
    const enemyHpBar = document.getElementById("enemyHpBar");
    const enemyHpText = document.getElementById("enemyBattleHpText");

    if (enemyHpBar && enemy.maxHp > 0) {
      const ratio = Math.max(0, Math.min(1, enemy.hp / enemy.maxHp));
      enemyHpBar.style.width = (ratio * 100) + "%";
    }
    if (enemyHpText) {
      enemyHpText.textContent = `HP ${enemy.hp} / ${enemy.maxHp}`;
    }
  }

  function endBattleAndReturn(message) {
    if (message) addBattleLog(message);
    battleState.active = false;
    showStoryView();
    gotoRandomStoryInBranch(state.branch || 1);
  }

  function rpgAttack() {
    if (!battleState.active || !battleState.enemy) return;

    const enemy = battleState.enemy;

    // --- ÌîåÎ†àÏù¥Ïñ¥ Í≥µÍ≤© ---
    let dmgMin = Math.max(1, Math.floor(state.str * 0.7));
    let dmgMax = Math.max(dmgMin + 1, Math.floor(state.str * 1.3 + 2));
    let damage = dmgMin + Math.floor(Math.random() * (dmgMax - dmgMin + 1));

    // Í∏∞ÎèÑ Î≤ÑÌîÑ: Í≥µÍ≤©Î†• Ï¶ùÍ∞Ä
    if (battleState.prayerBuff && battleState.prayerBuff.type === "atkUp") {
      const bonusRate = battleState.prayerBuff.rate;
      damage = Math.floor(damage * (1 + bonusRate));
    }

    // Ï†Å Î∞©Ïñ¥ Î∞òÏòÅ
    const reducedByDef = Math.floor(enemy.def * 0.4);
    damage = Math.max(1, damage - reducedByDef);

    enemy.hp -= damage;
    if (enemy.hp < 0) enemy.hp = 0;
    addBattleLog(`ÎãπÏã†Ïùò Í≥µÍ≤©! ${enemy.name}ÏóêÍ≤å ${damage} ÌîºÌï¥Î•º ÏûÖÌòîÏäµÎãàÎã§.`);
    addLog(`Ï†ÑÌà¨: Ï†ÅÏóêÍ≤å ${damage} ÌîºÌï¥Î•º ÏûÖÌòîÏäµÎãàÎã§.`);

    updateBattleHud();

    // Ï†Å ÏÇ¨Îßù Ï≤¥ÌÅ¨
    if (enemy.hp <= 0) {
      addBattleLog(`${enemy.name}ÏùÑ(Î•º) Ïì∞Îü¨Îú®Î†∏ÏäµÎãàÎã§!`);
      addLog(`${enemy.name}Í≥ºÏùò Ï†ÑÌà¨ÏóêÏÑú ÏäπÎ¶¨ÌñàÏäµÎãàÎã§! Ïã†ÏïôÏã¨ +7, Ìûò +1`);
      state.faith += 7;
      state.str += 1;
      renderHeader();
      saveGame(true);
      const prayBtn = document.getElementById("prayBtn");
      if (prayBtn) prayBtn.disabled = true;
      return endBattleAndReturn("Ï†ÑÌà¨ÏóêÏÑú ÏäπÎ¶¨ÌñàÏäµÎãàÎã§.");
    }

    // --- Ï†Å ÌÑ¥ (ÌîåÎ†àÏù¥Ïñ¥ Î∞©Ïñ¥/ÌöåÌîº) ---
    enemyTurn();
  }

  function enemyTurn() {
    if (!battleState.active || !battleState.enemy) return;
    const enemy = battleState.enemy;

    // Í∏∞Î≥∏ ÌöåÌîº ÌôïÎ•†
    let dodgeChance = 0.05 + state.dex * 0.01; // Í∏∞Î≥∏ 5% + DEX*1%
    // Í∏∞ÎèÑ Î≤ÑÌîÑ: ÌöåÌîº Ï¶ùÍ∞Ä
    if (battleState.prayerBuff && battleState.prayerBuff.type === "dodgeUp") {
      dodgeChance += battleState.prayerBuff.bonus;
    }
    if (dodgeChance > 0.9) dodgeChance = 0.9;

    if (Math.random() < dodgeChance) {
      addBattleLog(`ÎãπÏã†ÏùÄ ÎØºÏ≤©ÌïòÍ≤å ÏõÄÏßÅÏó¨ ${enemy.name}Ïùò Í≥µÍ≤©ÏùÑ ÌöåÌîºÌñàÏäµÎãàÎã§!`);
      addLog("Ï†ÑÌà¨ Ï§ë Í≥µÍ≤©ÏùÑ ÌöåÌîºÌñàÏäµÎãàÎã§.");
      nextBattleTurn();
      return;
    }

    // Ï†Å Í≥µÍ≤© Í≥ÑÏÇ∞
    let dmgMin = Math.max(1, Math.floor(enemy.atk * 0.7));
    let dmgMax = Math.max(dmgMin + 1, Math.floor(enemy.atk * 1.3 + 2));
    let damage = dmgMin + Math.floor(Math.random() * (dmgMax - dmgMin + 1));

    // Í∏∞ÎèÑ Î≤ÑÌîÑ: Î∞õÎäî ÌîºÌï¥ Í∞êÏÜå
    if (battleState.prayerBuff && battleState.prayerBuff.type === "dmgDown") {
      damage = Math.floor(damage * (1 - battleState.prayerBuff.rate));
    }

    // ÌîåÎ†àÏù¥Ïñ¥ DEF Î∞òÏòÅ
    const reducedByDef = Math.floor(state.def * 0.5);
    damage = Math.max(1, damage - reducedByDef);

    addBattleLog(`${enemy.name}Ïùò Í≥µÍ≤©! ÎãπÏã†ÏùÄ ${damage} ÌîºÌï¥Î•º Î∞õÏïòÏäµÎãàÎã§.`);
    applyDamage(damage, `${enemy.name}Ïùò Í≥µÍ≤©`);
    updateBattleHud();

    if (state.life <= 0) {
      // GameOverÍ∞Ä Ïù¥ÎØ∏ Ï≤òÎ¶¨Îê®
      const prayBtn = document.getElementById("prayBtn");
      if (prayBtn) prayBtn.disabled = true;
      return;
    }

    if (!battleState.active) {
      // HP 0 ‚Üí Î™©Ïà® 1 Ï§ÑÍ≥† ÎûúÎç§ Ïä§ÌÜ†Î¶¨Î°ú ÎÑòÏñ¥Í∞îÏùÑ Ïàò ÏûàÏùå
      return;
    }

    nextBattleTurn();
  }

  function nextBattleTurn() {
    battleState.turn += 1;
    document.getElementById("battleTurnText").textContent = "Turn " + battleState.turn;

    // Í∏∞ÎèÑ Î≤ÑÌîÑ ÌÑ¥ Í∞êÏÜå
    if (battleState.prayerBuff && battleState.prayerBuffTurns > 0) {
      battleState.prayerBuffTurns -= 1;
      if (battleState.prayerBuffTurns <= 0) {
        addBattleLog("Í∏∞ÎèÑÏùò ÌäπÎ≥ÑÌïú Ìö®Í≥ºÍ∞Ä ÏÇ¨ÎùºÏ°åÏäµÎãàÎã§.");
        battleState.prayerBuff = null;
      }
    }
  }

  function usePrayerSkill() {
    if (!battleState.active) return;
    if (battleState.prayerUsed) return;

    battleState.prayerUsed = true;
    const prayBtn = document.getElementById("prayBtn");
    if (prayBtn) prayBtn.disabled = true;

    // 4Í∞ÄÏßÄ Ï§ë ÎûúÎç§: Í≥µÍ≤©Î†•, Î∞õÎäî ÌîºÌï¥ Í∞êÏÜå, ÌöåÌîº ÌôïÎ•†, Ï¶âÏãú HP ÌöåÎ≥µ
    const roll = Math.floor(Math.random() * 4);

    if (roll === 0) {
      // Í≥µÍ≤©Î†• ÏóÖ
      const rate = 0.3 + Math.random() * 0.4; // 30~70%
      battleState.prayerBuff = { type: "atkUp", rate };
      battleState.prayerBuffTurns = 2;
      addBattleLog(`Í∏∞ÎèÑÏùò Ìûò! Îã§Ïùå ${battleState.prayerBuffTurns}ÌÑ¥ ÎèôÏïà Í≥µÍ≤©Î†•Ïù¥ ${Math.round(rate*100)}% Ï¶ùÍ∞ÄÌï©ÎãàÎã§.`);
      addLog("Í∏∞ÎèÑ Ïä§ÌÇ¨ ÏÇ¨Ïö© ‚Äì Í≥µÍ≤©Î†• Ï¶ùÍ∞Ä Î≤ÑÌîÑ Î∞úÎèô");
    } else if (roll === 1) {
      // Î∞õÎäî ÌîºÌï¥ Í∞êÏÜå
      const rate = 0.3 + Math.random() * 0.4; // 30~70%
      battleState.prayerBuff = { type: "dmgDown", rate };
      battleState.prayerBuffTurns = 2;
      addBattleLog(`Í∏∞ÎèÑÏùò Î≥¥Ìò∏! Îã§Ïùå ${battleState.prayerBuffTurns}ÌÑ¥ ÎèôÏïà Î∞õÎäî ÌîºÌï¥Í∞Ä ${Math.round(rate*100)}% Í∞êÏÜåÌï©ÎãàÎã§.`);
      addLog("Í∏∞ÎèÑ Ïä§ÌÇ¨ ÏÇ¨Ïö© ‚Äì ÌîºÌï¥ Í∞êÏÜå Î≤ÑÌîÑ Î∞úÎèô");
    } else if (roll === 2) {
      // ÌöåÌîº ÌôïÎ•† Ï¶ùÍ∞Ä
      const bonus = 0.2 + Math.random() * 0.3; // +20~50%
      battleState.prayerBuff = { type: "dodgeUp", bonus };
      battleState.prayerBuffTurns = 2;
      addBattleLog(`Í∏∞ÎèÑÏùò ÎØºÏ≤©! Îã§Ïùå ${battleState.prayerBuffTurns}ÌÑ¥ ÎèôÏïà ÌöåÌîº ÌôïÎ•†Ïù¥ ÌÅ¨Í≤å Ï¶ùÍ∞ÄÌï©ÎãàÎã§.`);
      addLog("Í∏∞ÎèÑ Ïä§ÌÇ¨ ÏÇ¨Ïö© ‚Äì ÌöåÌîº Ï¶ùÍ∞Ä Î≤ÑÌîÑ Î∞úÎèô");
    } else {
      // Ï¶âÏãú HP ÌöåÎ≥µ
      const healAmount = Math.max(1, Math.floor(state.maxHp * (0.25 + Math.random()*0.35))); // 25~60%
      healHp(healAmount, "Í∏∞ÎèÑÎ°ú ÌöåÎ≥µ");
      addBattleLog(`Í∏∞ÎèÑ ÏùëÎãµ! Ï¶âÏãú HPÍ∞Ä ${healAmount} ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§.`);
      addLog("Í∏∞ÎèÑ Ïä§ÌÇ¨ ÏÇ¨Ïö© ‚Äì Ï¶âÏãú HP ÌöåÎ≥µ");
      // ÌûêÏùÄ Î≤ÑÌîÑ ÏóÜÏùå
    }
  }

  function rpgRun() {
    if (!battleState.active || !battleState.enemy) return;

    // ÌöåÌîº Ïä§ÌÉØ Í∏∞Î∞ò ÎèÑÎßù ÌôïÎ•†
    let runChance = 0.3 + state.dex * 0.01; // Í∏∞Î≥∏ 30% + DEX*1
    if (runChance > 0.8) runChance = 0.8;

    if (Math.random() < runChance) {
      addBattleLog("ÎãπÏã†ÏùÄ Í∞ÑÏã†Ìûà Ï†ÑÌà¨ÏóêÏÑú ÎèÑÎßùÏπòÎäî Îç∞ ÏÑ±Í≥µÌñàÏäµÎãàÎã§!");
      addLog("RPG Ï†ÑÌà¨ÏóêÏÑú ÎèÑÎßù ÏÑ±Í≥µ");
      battleState.active = false;
      showStoryView();
      gotoRandomStoryInBranch(state.branch || 1);
    } else {
      addBattleLog("ÎèÑÎßùÏπòÎ†§ ÌñàÏßÄÎßå Ïã§Ìå®ÌñàÏäµÎãàÎã§! Ï†ÅÏù¥ Î∞òÍ≤©Ìï©ÎãàÎã§.");
      addLog("RPG Ï†ÑÌà¨ÏóêÏÑú ÎèÑÎßù Ïã§Ìå® ‚Äì Ï†ÅÏùò Í≥µÍ≤©");
      enemyTurn();
    }
  }

  /* ---------------- Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ Ï†ÑÌà¨ (Ïö¥Îπ® Ï†ÑÏö©) ---------------- */

  const rpsState = {
    active: false,
    wins: 0,
    losses: 0
  };

  function startRpsBattle() {
    rpsState.active = true;
    rpsState.wins = 0;
    rpsState.losses = 0;

    const scene = {
      ko: `Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ Ï†ÑÌà¨Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!
3Î≤à Ïù¥Í∏∞Î©¥ ÏäπÎ¶¨, 3Î≤à ÏßÄÎ©¥ Ìå®Î∞∞ÏûÖÎãàÎã§.
(ÏôÑÏ†Ñ Ïö¥Îπ® Ï†ÑÌà¨ÏûÖÎãàÎã§ üòä)`,
      en: `Rock‚ÄìPaper‚ÄìScissors Battle has begun!
Win 3 rounds to win the battle, lose 3 rounds and you are defeated.
(This battle is purely based on luck.)`,
      choices: [
        { text: "‚úå Í∞ÄÏúÑ (Scissors)", action: () => rpsRound("Í∞ÄÏúÑ") },
        { text: "‚úä Î∞îÏúÑ (Rock)",     action: () => rpsRound("Î∞îÏúÑ") },
        { text: "‚úã Î≥¥ (Paper)",      action: () => rpsRound("Î≥¥") },
        { text: "üèÉ ÎèÑÎßù (Run away)", action: () => rpsRun() }
      ]
    };

    renderScene({ ...scene, choices: scene.choices });
    addLog("Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ Ï†ÑÌà¨ ÏãúÏûë");
  }

  function rpsRound(playerChoice) {
    if (!rpsState.active) return;

    // Í≤∞Í≥ºÎäî ÏôÑÏ†Ñ ÎûúÎç§: 0=Ïäπ,1=Ìå®,2=Î¨¥ÏäπÎ∂Ä
    const roll = Math.floor(Math.random()*3);
    let resultText = "";
    if (roll === 0) {
      rpsState.wins++;
      resultText = `ÎãπÏã†Ïù¥ (${playerChoice})Î•º ÎÉàÍ≥†... Ïö¥Î™ÖÏùò Í≤∞Í≥ºÎäî 'ÏäπÎ¶¨'ÏûÖÎãàÎã§! (ÏäπÎ¶¨ ${rpsState.wins}/3, Ìå®Î∞∞ ${rpsState.losses}/3)`;
    } else if (roll === 1) {
      rpsState.losses++;
      resultText = `ÎãπÏã†Ïù¥ (${playerChoice})Î•º ÎÉàÍ≥†... Ïö¥Î™ÖÏùò Í≤∞Í≥ºÎäî 'Ìå®Î∞∞'ÏûÖÎãàÎã§... (ÏäπÎ¶¨ ${rpsState.wins}/3, Ìå®Î∞∞ ${rpsState.losses}/3)`;
    } else {
      resultText = `ÎãπÏã†Ïù¥ (${playerChoice})Î•º ÎÉàÍ≥†... 'Î¨¥ÏäπÎ∂Ä'ÏûÖÎãàÎã§. (ÏäπÎ¶¨ ${rpsState.wins}/3, Ìå®Î∞∞ ${rpsState.losses}/3)`;
    }

    addLog(resultText);

    // Ïä§ÌÜ†Î¶¨ ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
    document.getElementById("storyKo").textContent =
      "Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ Ï†ÑÌà¨ Ï§ë...\n" + resultText;
    document.getElementById("storyEn").textContent =
      "Rock-Paper-Scissors Battle...\n" + resultText;

    if (rpsState.wins >= 3) {
      return rpsWin();
    }
    if (rpsState.losses >= 3) {
      return rpsLose();
    }
  }

  function rpsWin() {
    rpsState.active = false;
    addLog("Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ Ï†ÑÌà¨ÏóêÏÑú ÏäπÎ¶¨ÌñàÏäµÎãàÎã§! Ïã†ÏïôÏã¨ +5");
    state.faith += 5;
    renderHeader();
    saveGame(true);
    gotoRandomStoryInBranch(state.branch || 1);
  }

  function rpsLose() {
    rpsState.active = false;
    const dmg = 6;
    addLog(`Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ Ï†ÑÌà¨ÏóêÏÑú Ìå®Î∞∞ÌñàÏäµÎãàÎã§... HP ${dmg} Í∞êÏÜå.`);
    applyDamage(dmg, "Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ Ìå®Î∞∞");
    gotoRandomStoryInBranch(state.branch || 1);
  }

  function rpsRun() {
    if (!rpsState.active) return;
    rpsState.active = false;
    addLog("Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ Ï†ÑÌà¨ÏóêÏÑú ÎèÑÎßùÏ≥§ÏäµÎãàÎã§.");
    gotoRandomStoryInBranch(state.branch || 1);
  }

  /* ---------------- 1-1ÏóêÏÑúÏùò 'ÎèÑÎßùÍ∞ÑÎã§' ---------------- */

  function attemptEncounterEscape() {
    // ÌöåÌîº DEX Í∏∞Î∞ò
    let runProb = 0.5 + state.dex * 0.01; // Í∏∞Î≥∏ 50% + DEX*1
    if (runProb > 0.9) runProb = 0.9;

    if (Math.random() < runProb) {
      addLog("ÎèÑÎßùÏóê ÏÑ±Í≥µÌñàÏäµÎãàÎã§! Îã§Î•∏ ÏÇ¨Í±¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.");
      saveGame(true);
      gotoRandomStoryInBranch(state.branch || 1);
    } else {
      addLog("ÎèÑÎßùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§... HPÍ∞Ä 1 Í∞êÏÜåÌï©ÎãàÎã§.");
      applyDamage(1, "ÎèÑÎßù Ïã§Ìå®");
      gotoScene("1-1");
    }
  }

  /* ---------------- ÏÉÅÎã® Ï†ïÎ≥¥ Î†åÎçî ---------------- */

  function renderHeader() {
    document.getElementById("playerName").textContent = "Player: " + playerName;
    document.getElementById("statLine").textContent =
      `Îä•Î†•Ïπò ‚Äì STR:${state.str} | HP:${state.hp}/${state.maxHp} | ` +
      `DEX:${state.dex} | DEF:${state.def} | LIFE:${state.life} | FAITH:${state.faith}`;
    updateHpBars();
    if (battleState.enemy) updateBattleHud();
  }

  /* ---------------- ÏÉÅÏ†ê ---------------- */

  const shopItems = [
    { label:"Ìûò +1",   stat:"str",  amount:1, cost:10 },
    { label:"Ï≤¥Î†• +1", stat:"hp",   amount:1, cost:5 },
    { label:"ÌöåÌîº +1", stat:"dex",  amount:1, cost:5 },
    { label:"Î∞©Ïñ¥ +1", stat:"def",  amount:1, cost:5 },
    { label:"Î™©Ïà® +1", stat:"life", amount:1, cost:50 }
  ];

  let randomLog = [];

  function openShop() {
    document.getElementById("shopBackdrop").style.display = "flex";
    updateShopFaithText();
    buildShopGrid();
    updateRandomLogUI();
  }

  function closeShop() {
    document.getElementById("shopBackdrop").style.display = "none";
  }

  function updateShopFaithText() {
    document.getElementById("shopFaithText").textContent =
      `ÌòÑÏû¨ Ïã†ÏïôÏã¨(Faith): ${state.faith}F`;
  }

  function buildShopGrid() {
    const box = document.getElementById("shopGrid");
    box.innerHTML = "";
    shopItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "shop-item";

      div.innerHTML = `
        <div class="shop-item-title">${item.label}</div>
        <div class="shop-item-cost">${item.cost}F</div>
        <button class="shop-buy-btn">Íµ¨ÏûÖ</button>
      `;

      div.querySelector("button").onclick = () => buyItem(item);
      box.appendChild(div);
    });
  }

  function buyItem(item) {
    if (state.faith < item.cost) {
      showToast("Ïã†ÏïôÏã¨Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§!");
      return;
    }
    state.faith -= item.cost;

    if (item.stat === "hp") {
      state.maxHp += item.amount;
      state.hp += item.amount;
      if (state.hp > state.maxHp) state.hp = state.maxHp;
    } else {
      state[item.stat] += item.amount;
    }

    addLog(`ÏÉÅÏ†êÏóêÏÑú '${item.label}'ÏùÑ(Î•º) Íµ¨ÏûÖÌñàÏäµÎãàÎã§.`);
    renderHeader();
    updateShopFaithText();
    saveGame(true);
    showToast(`Íµ¨ÏûÖ ÏôÑÎ£å: ${item.label}`);
  }

  /* ---------------- ÎûúÎç§ ÎΩëÍ∏∞ ---------------- */

  const gachaCost = 50;

  const gachaTable = [
    { text:"Ìûò +1",      apply:()=>{ state.str+=1; },  weight:7 },
    { text:"Ìûò +5",      apply:()=>{ state.str+=5; },  weight:7 },
    { text:"Ìûò +10",     apply:()=>{ state.str+=10; }, weight:3 },

    { text:"Ï≤¥Î†• +1",    apply:()=>{ state.maxHp+=1; state.hp+=1; if(state.hp>state.maxHp)state.hp=state.maxHp; }, weight:7 },
    { text:"Ï≤¥Î†• +5",    apply:()=>{ state.maxHp+=5; state.hp+=5; if(state.hp>state.maxHp)state.hp=state.maxHp; }, weight:7 },
    { text:"Ï≤¥Î†• +10",   apply:()=>{ state.maxHp+=10; state.hp+=10; if(state.hp>state.maxHp)state.hp=state.maxHp; }, weight:3 },

    { text:"ÌöåÌîº +1",    apply:()=>{ state.dex+=1; },  weight:7 },
    { text:"ÌöåÌîº +5",    apply:()=>{ state.dex+=5; },  weight:7 },
    { text:"ÌöåÌîº +10",   apply:()=>{ state.dex+=10; }, weight:3 },

    { text:"Î∞©Ïñ¥ +1",    apply:()=>{ state.def+=1; },  weight:7 },
    { text:"Î∞©Ïñ¥ +5",    apply:()=>{ state.def+=5; },  weight:7 },
    { text:"Î∞©Ïñ¥ +10",   apply:()=>{ state.def+=10; }, weight:3 },

    { text:"Ïã†ÏïôÏã¨ +50", apply:()=>{ state.faith+=50; },  weight:5 },
    { text:"Ïã†ÏïôÏã¨ +100",apply:()=>{ state.faith+=100; }, weight:1 },

    { text:"Î™©Ïà® +1",    apply:()=>{ state.life+=1; }, weight:2 },
    { text:"Î™©Ïà® +2",    apply:()=>{ state.life+=2; }, weight:1 },
    { text:"Î™©Ïà® +3",    apply:()=>{ state.life+=3; }, weight:1.82 },

    { text:"Starbucks Gift Card $5",  apply:()=>{}, weight:0.05 },
    { text:"Starbucks Gift Card $10", apply:()=>{}, weight:0.005 },
    { text:"Starbucks Gift Card $20", apply:()=>{}, weight:0.001 },

    { text:"Amazon Gift Card $10",    apply:()=>{}, weight:0.005 },
    { text:"Amazon Gift Card $20",    apply:()=>{}, weight:0.001 },

    { text:"Google Play Gift Card $5",  apply:()=>{}, weight:0.05 },
    { text:"Google Play Gift Card $10", apply:()=>{}, weight:0.005 },
    { text:"Google Play Gift Card $20", apply:()=>{}, weight:0.001 },

    { text:"ÍΩù", apply:()=>{}, weight:20 }
  ];

  function rollGacha() {
    if (state.faith < gachaCost) {
      showToast("Ïã†ÏïôÏã¨Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§! (50F ÌïÑÏöî)");
      return;
    }

    state.faith -= gachaCost;

    let total = gachaTable.reduce((s,x)=>s+x.weight, 0);
    let r = Math.random() * total;

    let chosen = gachaTable[gachaTable.length-1];
    for (const entry of gachaTable) {
      if (r < entry.weight) {
        chosen = entry;
        break;
      }
      r -= entry.weight;
    }

    const time = new Date().toLocaleTimeString("ko-KR", {hour:"2-digit", minute:"2-digit"});
    randomLog.unshift(`${time} ‚Üí ${chosen.text}`);
    if (randomLog.length > 20) randomLog.pop();
    updateRandomLogUI();

    if (chosen.text.includes("Gift Card")) {
      addLog("ÎûúÎç§ ÎΩëÍ∏∞ÏóêÏÑú Gift CardÏóê ÎãπÏ≤®ÎêòÏóàÏäµÎãàÎã§! ("+chosen.text+")");
      showGiftPopup(chosen.text);
      updateShopFaithText();
      renderHeader();
      saveGame(true);
      return;
    }

    chosen.apply();
    addLog("ÎûúÎç§ ÎΩëÍ∏∞ Í≤∞Í≥º: " + chosen.text);
    renderHeader();
    updateShopFaithText();
    saveGame(true);

    confettiEffect();
    showToast("ÎûúÎç§ ÎΩëÍ∏∞: " + chosen.text);
  }

  function updateRandomLogUI() {
    const box = document.getElementById("randomLogBox");
    if (!randomLog.length) {
      box.innerHTML = "<p style='margin:0;color:#999;'>ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>";
      return;
    }
    box.innerHTML = randomLog
      .map(item=>`<div>‚Ä¢ ${item}</div>`)
      .join("");
  }

  function showGiftPopup(itemName){
    confettiEffect();

    const back = document.createElement("div");
    back.style = `
      position:fixed; inset:0; 
      background:rgba(0,0,0,0.75);
      display:flex; align-items:center; justify-content:center;
      z-index:200;
    `;

    const card = document.createElement("div");
    card.style = `
      background:white; width:80%; max-width:420px;
      padding:30px; border-radius:20px;
      text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5);
    `;

    card.innerHTML = `
      <h2 style="font-size:28px; color:#d33; margin-bottom:10px;">üéâ CONGRATULATIONS! üéâ</h2>
      <div style="font-size:22px; margin-bottom:20px;">
        You won:<br><strong style="font-size:26px; color:#2a6;">${itemName}</strong>
      </div>
      <p style="font-size:15px; margin-bottom:6px;">
        üì∏ Ïä§ÌÅ¨Î¶∞ÏÉ∑ÏùÑ Ï∞çÏñ¥ÏÑú Ïù¥Ïû¨Í¥Ä Î™©ÏÇ¨ÎãòÍªò Ïπ¥ÌÜ°ÏúºÎ°ú Î≥¥ÎÇ¥Ï£ºÏÑ∏Ïöî!
      </p>
      <p style="font-size:13px; color:#666; margin-bottom:10px;">
        üì∏ Please take a screenshot and send it to Pastor Jaegwan via KakaoTalk!
      </p>
      <button id="fakeShotBtn"
        style="margin-top:4px; background:#f0f0f0; color:#333;
               padding:8px 16px; border-radius:8px; border:1px solid #ccc; cursor:pointer;">
        (ÏòàÏãú) Ïä§ÌÅ¨Î¶∞ÏÉ∑ Î≤ÑÌäº
      </button>
      <br/>
      <button style="margin-top:16px; background:#444; color:white;
                     padding:10px 20px; border-radius:8px; border:none; cursor:pointer;">
        Îã´Í∏∞ Close
      </button>
    `;

    card.querySelector("button:last-of-type").onclick = () => back.remove();

    const fakeBtn = card.querySelector("#fakeShotBtn");
    fakeBtn.onclick = () => {
      alert("Í∏∞Í∏∞ÏóêÏÑú Ïä§ÌÅ¨Î¶∞ÏÉ∑ÏùÑ ÏßÅÏ†ë Ï∞çÏñ¥Ï£ºÏÑ∏Ïöî! (Ïòà: Ìú¥ÎåÄÌè∞ Ï∫°Ï≥ê Î≤ÑÌäº)");
    };

    back.appendChild(card);
    document.body.appendChild(back);
  }

  /* ---------------- Ï±ÑÌåÖ Í∏∞Îä• ---------------- */

  let chatMessages = [];
  let chatPollTimer = null;

  function openChat() {
    document.getElementById("chatBackdrop").style.display = "flex";
    fetchChat(true);
    setTimeout(() => {
      const input = document.getElementById("chatInput");
      if (input) input.focus();
    }, 100);
  }

  function closeChat() {
    document.getElementById("chatBackdrop").style.display = "none";
  }

  async function fetchChat(silent = true) {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "chatList" })
      });
      const text = await res.text();
      let list = [];
      try {
        list = JSON.parse(text);
      } catch (e) {
        list = [];
      }
      chatMessages = Array.isArray(list) ? list : [];
      renderChatMini();
      renderChatModalMessages();
    } catch (err) {
      if (!silent) console.error(err);
    }
  }

  function renderChatMini() {
    const box = document.getElementById("chatMini");
    if (!chatMessages.length) {
      box.innerHTML = "<div class='chat-mini-empty'>Ï±ÑÌåÖÏù¥ ÏïÑÏßÅ ÏóÜÏäµÎãàÎã§. ÏπúÍµ¨Îì§ÏóêÍ≤å Î®ºÏ†Ä ÎßêÏùÑ Í±∏Ïñ¥Î≥¥ÏÑ∏Ïöî!</div>";
      return;
    }

    const lastTwo = chatMessages.slice(-2);
    box.innerHTML = lastTwo.map(msg => {
      const name = escapeHtml(msg.name || "ÎàÑÍµ∞Í∞Ä");
      const text = escapeHtml(msg.message || "");
      return `
        <div class="chat-mini-line">
          <span class="chat-mini-name">${name} :</span>
          <span class="chat-mini-text">${text}</span>
        </div>
      `;
    }).join("");
  }

  function renderChatModalMessages() {
    const wrap = document.getElementById("chatMessages");
    if (!wrap) return;
    if (!chatMessages.length) {
      wrap.innerHTML = `<div class="chat-empty">ÏïÑÏßÅ Ï±ÑÌåÖÏù¥ ÏóÜÏäµÎãàÎã§. Ï≤´ Î≤àÏß∏ Î©îÏãúÏßÄÎ•º ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</div>`;
      return;
    }

    wrap.innerHTML = chatMessages.map(msg => {
      const isMe = (msg.name === playerName);
      const cls = isMe ? "me" : "other";
      const name = escapeHtml(msg.name || "Player");
      const text = escapeHtml(msg.message || "");
      return `
        <div class="chat-row ${cls}">
          <div class="chat-name">${name}</div>
          <div class="chat-bubble">${text}</div>
        </div>
      `;
    }).join("");

    wrap.scrollTop = wrap.scrollHeight;
  }

  async function sendChat() {
    const input = document.getElementById("chatInput");
    if (!input) return;
    const msg = (input.value || "").trim();
    if (!msg) return;
    if (!playerId) {
      alert("Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.");
      return;
    }

    input.value = "";
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          type: "chatSend",
          id: playerId,
          name: playerName,
          message: msg
        })
      });
      const text = await res.text();
      if (text !== "ok") {
        showToast("Ï±ÑÌåÖ Ï†ÑÏÜ° Ïã§Ìå®: " + text);
      }
    } catch (e) {
      showToast("Ï±ÑÌåÖ Ï†ÑÏÜ° Ïò§Î•ò");
    }

    fetchChat(true);
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const chatInput = document.getElementById("chatInput");
      if (document.activeElement === chatInput) {
        e.preventDefault();
        sendChat();
      }
    }
  });

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  /* ---------------- Ï†ÄÏû• & Ïú†Ìã∏ ---------------- */

  async function saveGame(silent=false){
    if (!playerId) {
      if (!silent) alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§. index.htmlÏóêÏÑú Îã§Ïãú Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.");
      return;
    }
    localStorage.setItem("pilgrimSaveData", JSON.stringify(state));

    try {
      const r = await fetch(API_URL, {
        method:"POST",
        body:JSON.stringify({
          type:"save",
          id:playerId,
          saveData:state
        })
      });
      const t = await r.text();
      if(!silent){
        if(t==="saved") showToast("Ï†ÄÏû• ÏôÑÎ£å!");
        else showToast("Ï†ÄÏû• Ïã§Ìå®: " + t);
      }
    } catch(e){
      if(!silent) alert("Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2000);
  }

  function confettiEffect() {
    const duration = 1200;
    const end = Date.now() + duration;

    (function frame(){
      const colors = ["#ffcc00","#ff6699","#66ccff","#99ff66","#ff9966"];
      const div = document.createElement("div");
      div.style = `
        position:fixed; top:${Math.random()*40}%; left:${Math.random()*80+10}%;
        width:8px; height:14px;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        opacity:0.95; transform:rotate(${Math.random()*360}deg);
        transition: transform 1s ease-out, top 1s ease-out, opacity 1s;
        z-index:300;
      `;
      document.body.appendChild(div);
      setTimeout(()=>{
        div.style.top="100%";
        div.style.opacity="0";
        div.style.transform+=" rotate(720deg)";
      },10);
      setTimeout(()=>div.remove(),1500);
      if(Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  /* ---------------- Ï¥àÍ∏∞ Ïã§Ìñâ ---------------- */

  renderHeader();
  gotoScene(state.storyKey || "0-0");
  fetchChat(true);
  chatPollTimer = setInterval(fetchChat, 5000);

</script>

</body>
</html>
