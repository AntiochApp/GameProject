<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Pilgrim's Journey â€“ Game</title>

  <!-- ì™¸ë¶€ ìŠ¤í† ë¦¬(JSON) íŒŒì„œ (Option Cìš©, ë‚˜ì¤‘ì— storyEngine.js ë§Œë“¤ë©´ ë¨) -->
  <script src="storyEngine.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Georgia", system-ui, sans-serif;
      background: url('bg_game.png') center/cover no-repeat fixed;
    }

    .overlay {
      background: rgba(0,0,0,0.35);
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
      padding: 16px;
    }

    /* ìƒë‹¨ ë°” */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(60,60,60,0.95);
      color: #f5f5f5;
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
      margin-bottom: 10px;
    }

    .player-info {
      font-size: 14px;
      white-space: nowrap;
    }

    .player-info strong {
      font-size: 16px;
      margin-right: 6px;
    }

    .stats {
      font-size: 13px;
      opacity: 0.9;
    }

    .top-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-top {
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      background: #8e5b32;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    }
    .btn-top.chat {
      background: #5c6bc0;
    }
    .btn-top.save {
      background: #407a3b;
    }
    .btn-top:hover {
      filter: brightness(1.05);
    }

    /* ë¯¸ë‹ˆ ì±„íŒ… ë°” (ìµœê·¼ 2ê°œ ë©”ì‹œì§€) */
    .chat-mini-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .chat-mini {
      width: min(900px, 90vw);
      background: rgba(30, 30, 30, 0.85);
      border-radius: 14px;
      padding: 6px 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.07);
      font-size: 12px;
      color: #f5f2e9;
      font-family: "Georgia", system-ui, sans-serif;
    }
    .chat-mini-line {
      display: flex;
      gap: 6px;
      align-items: baseline;
      line-height: 1.3;
      opacity: 0.95;
    }
    .chat-mini-name {
      color: #ffe082;
      font-weight: 700;
      white-space: nowrap;
    }
    .chat-mini-text {
      color: #fefefe;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .chat-mini-empty {
      color: #999;
      font-style: italic;
      text-align: center;
    }

    /* ìŠ¤í† ë¦¬ ì¹´ë“œ ë˜í¼ */
    .story-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }

    .story-card {
      width: min(900px, 90vw);
      background: rgba(255,255,245,0.94);
      border-radius: 18px;
      padding: 24px 30px 26px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
      border: 1px solid rgba(220,200,160,0.9);
      position: relative;
      overflow: hidden;
    }

    /* ì–‘í”¼ì§€ ëŠë‚Œ ì¥ì‹ */
    .story-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.5), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(230,210,170,0.35), transparent 60%);
      pointer-events: none;
    }

    .story-content {
      position: relative;
      z-index: 1;
    }

    .story-ko {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #3a2a16;
      white-space: pre-line;
    }

    .story-en {
      font-size: 14px;
      color: #665544;
      margin-bottom: 18px;
      white-space: pre-line;
    }

    /* ì„ íƒì§€ (RPG ìŠ¤íƒ€ì¼) */
    .choice-container {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .choice-btn {
      text-align: left;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #c9b289;
      background: linear-gradient(90deg, #fdf5e6, #f5e4c6);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .choice-btn::before {
      content: "â–¶";
      margin-right: 6px;
      color: #b07a3b;
    }

    .choice-btn:hover {
      filter: brightness(1.04);
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }

    /* ìŠ¤í† ë¦¬/ì „íˆ¬ ë¡œê·¸ (í•œ ì¤„) */
    .story-log {
      margin-top: 14px;
      padding: 6px 10px;
      border-radius: 9px;
      background: rgba(255,248,224,0.9);
      border: 1px solid rgba(214,189,135,0.9);
      font-size: 13px;
      color: #4a3a1e;
      min-height: 18px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ê³µí†µ ëª¨ë‹¬ ë°°ê²½ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    /* ìƒì  ëª¨ë‹¬ */
    .modal {
      background: #f8f4ec;
      border-radius: 18px;
      padding: 20px 24px 24px;
      width: min(640px, 95vw);
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      border: 2px solid #b7935d;
      overflow-y: auto;
      max-height: 90vh;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #54351c;
    }

    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 22px;
      font-weight: bold;
    }

    .shop-faith {
      font-size: 13px;
      color: #333;
      margin-bottom: 8px;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
      margin-top: 6px;
    }

    .shop-item {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: 1px solid #e2d2b4;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 80px;
    }

    .shop-item-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #3b2615;
    }

    .shop-item-cost {
      font-size: 12px;
      color: #7a5b34;
      margin-bottom: 6px;
    }

    .shop-buy-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      align-self: flex-end;
      background: #8e5b32;
      color: #fff;
    }
    .shop-buy-btn:hover {
      filter: brightness(1.05);
    }

    .gacha-section {
      border-top: 1px dashed #c7b08a;
      padding-top: 10px;
      margin-top: 6px;
      text-align: center;
    }

    .gacha-btn {
      margin-top: 6px;
      padding: 10px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      background: linear-gradient(90deg,#f2a93b,#ff6f61);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }
    .gacha-btn:hover {
      filter: brightness(1.05);
    }

    .gacha-desc {
      font-size: 12px;
      color: #7a5b34;
    }

    .gacha-log-box {
      margin-top: 15px;
      background:#fff7e0;
      padding:10px;
      border-radius:10px;
      border:1px solid #d8c6a4;
      max-height:140px;
      overflow-y:auto;
      font-size:13px;
    }

    /* ì±„íŒ… ëª¨ë‹¬ */
    .chat-modal {
      background: radial-gradient(circle at top, #f9f0dc 0%, #e6d4b2 40%, #d0b58a 100%);
      border-radius: 20px;
      padding: 20px 22px 18px;
      width: min(640px, 95vw);
      box-shadow: 0 12px 32px rgba(0,0,0,0.7);
      border: 2px solid #8d6e3c;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .chat-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .chat-modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #4a2c12;
      letter-spacing: 1px;
    }

    .chat-modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-height: 260px;
    }

    .chat-messages {
      flex: 1;
      background: rgba(255,255,255,0.65);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(139,87,42,0.35);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .chat-row {
      display: flex;
      flex-direction: column;
      max-width: 80%;
    }
    .chat-row.me {
      align-self: flex-end;
      text-align: right;
    }
    .chat-row.other {
      align-self: flex-start;
      text-align: left;
    }

    .chat-name {
      font-size: 11px;
      color: #6d4c41;
      margin-bottom: 2px;
      opacity: 0.9;
    }

    .chat-bubble {
      padding: 6px 10px;
      border-radius: 12px;
      line-height: 1.3;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      word-break: break-word;
    }

    .chat-row.me .chat-bubble {
      background: #8e5b32;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .chat-row.other .chat-bubble {
      background: rgba(255,255,255,0.95);
      color: #3e2723;
      border-bottom-left-radius: 4px;
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .chat-input-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #b19063;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      background: rgba(255,255,255,0.9);
    }
    .chat-input-row input:focus {
      border-color: #8e5b32;
      box-shadow: 0 0 0 2px rgba(142,91,50,0.2);
    }

    .chat-send-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #8e5b32;
      color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    }
    .chat-send-btn:hover {
      filter: brightness(1.05);
    }

    .chat-empty {
      font-size: 12px;
      color: #8d6e63;
      text-align: center;
      margin-top: 12px;
    }

    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out;
      z-index: 50;
    }
    .toast.show {
      opacity: 1;
    }
  </style>
</head>

<body>
<div class="overlay">

  <!-- ìƒë‹¨ ë°” -->
  <div class="top-bar">
    <div class="player-info">
      <strong id="playerName">Player: ë¡œê·¸ì¸</strong>
      <span class="stats" id="statLine"></span>
    </div>
    <div class="top-buttons">
      <button class="btn-top chat" onclick="openChat()">ì±„íŒ…</button>
      <button class="btn-top" onclick="openShop()">ìƒì </button>
      <button class="btn-top save" onclick="saveGame()">ì €ì¥</button>
    </div>
  </div>

  <!-- ë¯¸ë‹ˆ ì±„íŒ… ë°” (ìµœê·¼ 2ê°œ) -->
  <div class="chat-mini-wrapper">
    <div class="chat-mini" id="chatMini">
      <div class="chat-mini-empty">ì±„íŒ…ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ì¹œêµ¬ë“¤ì—ê²Œ ë¨¼ì € ë§ì„ ê±¸ì–´ë³´ì„¸ìš”!</div>
    </div>
  </div>

  <!-- ìŠ¤í† ë¦¬ ì¹´ë“œ -->
  <div class="story-wrapper">
    <div class="story-card">
      <div class="story-content">
        <div class="story-ko" id="storyKo">ìŠ¤í† ë¦¬ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        <div class="story-en" id="storyEn">The story text will appear here.</div>

        <!-- ì„ íƒì§€ ì˜ì—­ -->
        <div id="choiceContainer" class="choice-container"></div>

        <!-- ì „íˆ¬/ë„ë§/ê²°ê³¼ ë“± í•œ ì¤„ ë¡œê·¸ -->
        <div class="story-log" id="storyLog"></div>
      </div>
    </div>
  </div>

  <!-- ìƒì  ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="shopBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>Pilgrim ìƒì </h2>
        <button class="modal-close" onclick="closeShop()">Ã—</button>
      </div>

      <div class="shop-faith" id="shopFaithText"></div>

      <!-- ëœë¤ë½‘ê¸° ê¸°ë¡ì°½ -->
      <div id="randomLogBox" class="gacha-log-box">
        <p style="margin:0; color:#999;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>

      <div class="shop-grid" id="shopGrid"></div>

      <div class="gacha-section">
        <div class="gacha-desc">ëœë¤ ë½‘ê¸° (50F) â€“ í° ë³´ìƒ ë˜ëŠ” ê½!</div>
        <button class="gacha-btn" onclick="rollGacha()">âœ¨ ëœë¤ ë½‘ê¸° âœ¨</button>
      </div>
    </div>
  </div>

  <!-- ì±„íŒ… ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="chatBackdrop">
    <div class="chat-modal">
      <div class="chat-modal-header">
        <h2>Prayer Chat</h2>
        <button class="modal-close" onclick="closeChat()">Ã—</button>
      </div>
      <div class="chat-modal-body">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-row">
          <input id="chatInput" type="text" maxlength="100"
                 placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”. (ìµœëŒ€ 100ì)">
          <button class="chat-send-btn" onclick="sendChat()">ë³´ë‚´ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwUqF_7np5AgJTygWKEn8diNyiFmvAnHaSsY0Xz3zVMuw5bGnn6y2Wr35zmq-w_ZuHyTQ/exec";

  let playerId = localStorage.getItem("pilgrimPlayerId") || "";
  let playerName = localStorage.getItem("pilgrimPlayerName") || "ë¡œê·¸ì¸";

  /* ---- ê¸°ë³¸ ëŠ¥ë ¥ì¹˜/ìƒíƒœ ---- */
  const defaultState = {
    str: 1,
    hp: 10,
    maxHp: 10,
    dex: 1,
    def: 1,
    life: 1,
    faith: 0,
    storyKey: "0-0",
    branch: 0        // 0: ì‹œì‘, 1: ì†Œë”ì— ë‚¨ìŒ, 2: ì†Œë”ì„ ë– ë‚¨
  };

  let state = { ...defaultState };

  try {
    const saved = JSON.parse(localStorage.getItem("pilgrimSaveData") || "null");
    if (saved) {
      state = Object.assign({}, defaultState, saved);
    }
  } catch(e){}

  if (!state.maxHp) state.maxHp = state.hp || 10;
  if (!state.storyKey) state.storyKey = "0-0";
  if (state.life == null) state.life = 1;

  /* ëœë¤ë½‘ê¸° ë¡œê·¸ */
  let randomLog = [];

  /* ì±„íŒ… ë°ì´í„° */
  let chatMessages = [];
  let chatPollTimer = null;

  /* ì „íˆ¬ ìƒíƒœ (ê°€ìœ„ë°”ìœ„ë³´ - ìˆœìˆ˜ ìš´) */
  let battleState = {
    active: false,
    wins: 0,
    losses: 0
  };

  /* storyEngine.jsì—ì„œ ì±„ì›Œì¤„ ìˆ˜ ìˆëŠ” ì™¸ë¶€ ìŠ¤í† ë¦¬ ê³µê°„ (Option C) */
  window.externalScenes = window.externalScenes || {};

  /* ---------------- ìŠ¤í† ë¦¬ ë°ì´í„° (ë‚´ì¥) ---------------- */

  // branch: 1 = ì†Œë”ì— ë‚¨ëŠ”ë‹¤, 2 = ì†Œë”ì„ ë– ë‚œ ê¸¸
  const scenes = {
    /* 0-0 : ê²Œì„ ì‹œì‘ */
    "0-0": {
      id: "0-0",
      branch: 0,
      random: false,
      ko: `ì„¸ìƒì—ëŠ” ì£„ê°€ ë§Œì—°í•˜ê³  ìˆë‹¤. ë¬´ì—‡ì´ ì£„ì¸ê°€? ë¬´ì—‡ì´ ë„ë•ì¸ê°€? ì‚¬ëŒë“¤ì€ ì¸ê¶Œì´ë¼ëŠ” ë¯¸ëª… ì•„ë˜, ì„œì„œíˆ íƒ€ë½í•˜ê³  ìˆë‹¤.
ì´ëŸ¬í•œ ì„¸ìƒ ì†ì—ì„œâ€¦ ë‚˜ëŠ” ëŒ€ì²´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ëŠ”ê°€?

{name}ë‹˜, ë‹¹ì‹ ì€ í˜„ì¬ 'ì†Œë”'ì´ë¼ëŠ” íƒ€ë½í•œ ë„ì‹œì— ê±°ì£¼í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ë‹¹ì‹ ì€ ì†Œë”ì— ê³„ì† ë¨¸ë¬´ì‹œê² ìŠµë‹ˆê¹Œ? ì•„ë‹ˆë©´ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
      en: `Sin is everywhere in this world. People slowly fall into darkness in the name of "human rights."
In this world, what should I do?

{name}, you are now living in the corrupted city of Sodom.
Will you stay in Sodom, or will you leave?`,
      choices: [
        {
          text: "1. ì†Œë”ì— ë‚¨ëŠ”ë‹¤ (Stay in Sodom)",
          action: () => {
            state.branch = 1;
            setStoryLog("ë‹¹ì‹ ì€ ì†Œë”ì— ë‚¨ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.");
            gotoScene("1-1");
          }
        },
        {
          text: "2. ì†Œë”ì„ ë– ë‚œë‹¤ (Leave Sodom)",
          action: () => {
            state.branch = 2;
            setStoryLog("ë‹¹ì‹ ì€ ì†Œë”ì„ ë– ë‚˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.");
            gotoScene("2-1");
          }
        }
      ]
    },

    /* 1-1 : ì†Œë”ì— ë‚¨ì•˜ì„ ë•Œ, ìœ í˜¹ ì´ë²¤íŠ¸ (ì „íˆ¬ ì—†ìŒ) */
    "1-1": {
      id: "1-1",
      branch: 1,
      random: false,
      ko: `ì§‘ì— ìŒì‹ì´ ì—†ì–´ì„œ, ë§ˆíŠ¸ë¡œ í–¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ê·¸ëŸ°ë° ì•ì—ì„œ ë§ˆì£¼ ì˜¤ë˜ ê°™ì€ ì„±ë³„ì˜ ì‚¬ëŒì´ {name}ë‹˜ì„ ë³´ë”ë‹ˆ,
ìœ™í¬ë¥¼ í•˜ë©° ë‹¤ê°€ì™€ ìœ í˜¹í•˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤.

{player}ë‹˜, ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
      en: `You are heading to the market because there is no food at home.
Suddenly, someone of the same gender walks toward you,
winks at you, and tries to tempt you.

What will you do, {player}?`,
      choices: [
        {
          text: "1. í•¨ê»˜í•œë‹¤ (Go with them)",
          action: () => {
            const dmg = 10;
            setStoryLog("ìœ í˜¹ì— ë”°ë¼ê°”ìŠµë‹ˆë‹¤... ì˜ì , ìœ¡ì ìœ¼ë¡œ ì§€ì³ HPê°€ 10 ê°ì†Œí•©ë‹ˆë‹¤.");
            applyDamage(dmg);
            gotoRandomStoryInBranch(1);
          }
        },
        {
          text: "2. ë„ë§ê°„ë‹¤ (Run away)",
          action: () => {
            attemptEncounterEscape();
          }
        }
      ]
    },

    /* 2-1 : ì†Œë”ì„ ë– ë‚œ ì‚¬ëŒ, ê´‘ì•¼ ì²« ì¥ë©´ (ì—¬ê¸°ì„œ ì „íˆ¬ í•„ìˆ˜ ë°œìƒ) */
    "2-1": {
      id: "2-1",
      branch: 2,
      random: false,
      ko: `ë‹¹ì‹ ì€ ì†Œë”ì„ ë– ë‚˜ ê´‘ì•¼ ê¸¸ì„ ê±·ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.
ë’¤ë¥¼ ëŒì•„ë³´ë©´ ì—¬ì „íˆ ë¶ˆë¹›ê³¼ ì†ŒìŒì´ ê°€ë“í•œ ë„ì‹œê°€ ë³´ì…ë‹ˆë‹¤.
ê·¸ëŸ¬ë‚˜ ë§ˆìŒ í•œí¸ì—ëŠ” ì´ìƒí•œ í‰ì•ˆì´ ì°¾ì•„ì˜µë‹ˆë‹¤.

ê·¸ë•Œ, ë©€ë¦¬ì„œ ì–´ë‘ìš´ ê·¸ë¦¼ìê°€ ë‹¤ê°€ì˜µë‹ˆë‹¤.
ì£„ì˜ ë„ì‹œì—ì„œ ì«“ê²¨ë‚œ ì•…í•œ ì˜ì´, ë‹¹ì‹ ì˜ ë°œê±¸ìŒì„ ë§‰ìœ¼ë ¤ í•©ë‹ˆë‹¤.

ì´ì œ ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
      en: `You leave Sodom and begin walking through the wilderness.
Behind you, the city is still full of noise and lights,
but deep in your heart, a strange peace begins to grow.

Then, from a distance, a dark shadow approaches.
An evil spirit driven out from the city tries to block your path.

What will you do now?`,
      choices: [
        {
          text: "1. í•˜ë‚˜ë‹˜ê»˜ ê¸°ë„í•˜ê³  ë§ì„ ë‹¤ (Pray and stand firm)",
          action: () => {
            state.faith += 5;
            setStoryLog("í•˜ë‚˜ë‹˜ê»˜ ê¸°ë„í–ˆìŠµë‹ˆë‹¤. ì‹ ì•™ì‹¬ +5, ì „íˆ¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤.");
            renderHeader();
            saveGame(true);
            startBattle();
          }
        },
        {
          text: "2. ë‘ë µì§€ë§Œ ì‹¸ìš´ë‹¤ (Fight even in fear)",
          action: () => {
            setStoryLog("ë‘ë ¤ì›€ ì†ì—ì„œë„ ì‹¸ìš°ê¸°ë¡œ ê²°ì‹¬í–ˆìŠµë‹ˆë‹¤. ì „íˆ¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤.");
            startBattle();
          }
        }
      ]
    },

    /* ---- ë¸Œëœì¹˜ 1 ëœë¤ ìŠ¤í† ë¦¬ ì˜ˆì‹œë“¤ ---- */
    "1-R1": {
      id: "1-R1",
      branch: 1,
      random: true,
      ko: `ì†Œë”ì˜ ë°¤ê±°ë¦¬ë¥¼ ê±¸ìœ¼ë©°, {name}ë‹˜ì€ í•˜ëŠ˜ì˜ ë³„ì„ ì˜¬ë ¤ë‹¤ë´…ë‹ˆë‹¤.
ì´ ë„ì‹œì˜ ì£„ì•… ê°€ìš´ë°ì„œë„, í•˜ë‚˜ë‹˜ì€ ì—¬ì „íˆ í•˜ëŠ˜ì—ì„œ ë‹¤ ë³´ê³  ê³„ì‹­ë‹ˆë‹¤.`,
      en: `{name} walks through the night streets of Sodom and looks up at the stars.
Even in this sinful city, God is still watching from heaven.`,
      choices: [
        {
          text: "ê¸°ë„í•˜ë©° íšŒê°œí•œë‹¤ (Pray and repent)",
          action: () => {
            state.faith += 3;
            setStoryLog("íšŒê°œì˜ ê¸°ë„ë¥¼ ë“œë ¸ìŠµë‹ˆë‹¤. ì‹ ì•™ì‹¬ +3");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(1);
          }
        }
      ]
    },
    "1-R2": {
      id: "1-R2",
      branch: 1,
      random: true,
      ko: `ì¹œêµ¬ë“¤ì´ {name}ë‹˜ì„ ë¶ˆëŸ¬ ìˆ ìë¦¬ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤.
ë¶„ìœ„ê¸°ëŠ” ì ì  ê³¼ê²©í•´ì§€ê³ , í•˜ë‚˜ë‹˜ì„ ì¡°ë¡±í•˜ëŠ” ë§ê¹Œì§€ ë‚˜ì˜µë‹ˆë‹¤.`,
      en: `Some friends invite {name} to a drinking party.
The atmosphere gets wilder, and they even begin to mock God.`,
      choices: [
        {
          text: "ì¡°ìš©íˆ ìë¦¬ë¥¼ ë– ë‚œë‹¤ (Quietly leave)",
          action: () => {
            state.faith += 2;
            setStoryLog("ìœ í˜¹ì„ ë¿Œë¦¬ì¹˜ê³  ìë¦¬ë¥¼ ë– ë‚¬ìŠµë‹ˆë‹¤. ì‹ ì•™ì‹¬ +2");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(1);
          }
        },
        {
          text: "ê°™ì´ ìˆ ì„ ë§ˆì‹ ë‹¤ (Drink with them)",
          action: () => {
            setStoryLog("ì˜ì ìœ¼ë¡œ ì§€ì³ ê°‘ë‹ˆë‹¤... HP 2 ê°ì†Œ.");
            applyDamage(2);
            gotoRandomStoryInBranch(1);
          }
        }
      ]
    },

    /* ---- ë¸Œëœì¹˜ 2 ëœë¤ ìŠ¤í† ë¦¬ ì˜ˆì‹œë“¤ ---- */
    "2-R1": {
      id: "2-R1",
      branch: 2,
      random: true,
      ko: `ê´‘ì•¼ì—ì„œ ê¸¸ì„ ìƒì€ ê²ƒë§Œ ê°™ì§€ë§Œ,
{surname}ë‹˜ì€ ë§ˆìŒì†ìœ¼ë¡œ ì¡°ìš©íˆ ì‹œí¸ 23í¸ì„ ë– ì˜¬ë¦½ë‹ˆë‹¤.`,
      en: `You seem lost in the wilderness,
but quietly in your heart, you recall Psalm 23.`,
      choices: [
        {
          text: "â€œì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆâ€¦â€ë¥¼ ë¬µìƒí•œë‹¤",
          action: () => {
            state.faith += 4;
            setStoryLog("ë§ì”€ì„ ë¬µìƒí•˜ë©° ìœ„ë¡œë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. ì‹ ì•™ì‹¬ +4");
            renderHeader();
            saveGame(true);
            gotoRandomStoryInBranch(2);
          }
        }
      ]
    },
    "2-R2": {
      id: "2-R2",
      branch: 2,
      random: true,
      ko: `ë©€ë¦¬ì„œ ì‘ì€ ë§ˆì„ í•˜ë‚˜ê°€ ë³´ì…ë‹ˆë‹¤.
ê·¸ê³³ì—ëŠ” í•˜ë‚˜ë‹˜ì„ ì˜ˆë°°í•˜ëŠ” ê³µë™ì²´ê°€ ìˆë‹¤ëŠ” ì†Œë¬¸ì„ ë“¤ì—ˆìŠµë‹ˆë‹¤.`,
      en: `In the distance, you see a small village.
You heard that there is a community there that worships God.`,
      choices: [
        {
          text: "ë§ˆì„ë¡œ ë“¤ì–´ê°€ ë³¸ë‹¤",
          action: () => {
            setStoryLog("ìƒˆë¡œìš´ ë¯¿ìŒì˜ ê³µë™ì²´ë¥¼ í–¥í•´ ê±¸ìŒì„ ì˜®ê¹ë‹ˆë‹¤.");
            gotoRandomStoryInBranch(2);
          }
        }
      ]
    }
  };

  /* ---------------- ìŠ¤í† ë¦¬ ì—”ì§„ ---------------- */

  function replaceName(text) {
    if (!text) return "";
    return text
      .replace(/\{name\}/g, playerName)
      .replace(/\{player\}/g, playerName)
      .replace(/\{surname\}/g, playerName);
  }

  function getScene(id) {
    // ë‚´ë¶€ scenes ìš°ì„ , ì—†ìœ¼ë©´ ì™¸ë¶€ JSONì—ì„œ ë¡œë“œëœ externalScenes ì‚¬ìš©
    return scenes[id] || window.externalScenes[id];
  }

  function renderScene(scene) {
    document.getElementById("storyKo").textContent = replaceName(scene.ko);
    document.getElementById("storyEn").textContent = replaceName(scene.en);

    const choiceBox = document.getElementById("choiceContainer");
    choiceBox.innerHTML = "";

    if (scene.choices && scene.choices.length) {
      scene.choices.forEach((choice) => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = choice.text;
        btn.onclick = () => choice.action();
        choiceBox.appendChild(btn);
      });
    } else {
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = "ê³„ì† ì§„í–‰";
      btn.onclick = () => gotoRandomStoryInBranch(state.branch || 1);
      choiceBox.appendChild(btn);
    }
  }

  function gotoScene(id) {
    const scene = getScene(id);
    if (!scene) {
      setStoryLog("ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì€ ìŠ¤í† ë¦¬ì…ë‹ˆë‹¤. (id: " + id + ")");
      return;
    }
    state.storyKey = id;
    if (scene.branch != null) state.branch = scene.branch;
    renderScene(scene);
    saveGame(true);
  }

  function gotoRandomStoryInBranch(branch) {
    const internalPool = Object.values(scenes).filter(
      (s) => s.branch === branch && s.random
    );
    const externalPool = Object.values(window.externalScenes || {}).filter(
      (s) => s.branch === branch && s.random
    );
    const pool = internalPool.concat(externalPool);

    if (!pool.length) {
      const fallback = branch === 1 ? "1-1" : "2-1";
      gotoScene(fallback);
      return;
    }
    const idx = Math.floor(Math.random() * pool.length);
    const chosen = pool[idx];
    gotoScene(chosen.id);
  }

  function setStoryLog(msg) {
    document.getElementById("storyLog").textContent = msg || "";
  }

  /* ---------------- HP / LIFE / ë¶€í™œ / ê²Œì„ì˜¤ë²„ ---------------- */

  function applyDamage(dmg) {
    state.hp -= dmg;
    if (state.hp < 0) state.hp = 0;

    if (state.hp <= 0) {
      state.life -= 1;

      if (state.life <= 0) {
        handleGameOver();
        return;
      }

      state.hp = state.maxHp;
      setStoryLog("HPê°€ 0ì´ ë˜ì–´ í•œ ëª©ìˆ¨ì„ ìƒì—ˆì§€ë§Œ, ë‹¤ì‹œ ì¼ì–´ë‚¬ìŠµë‹ˆë‹¤! ë‹¤ë¥¸ ì‚¬ê±´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      renderHeader();
      saveGame(true);
      gotoRandomStoryInBranch(state.branch || 1);
      return;
    }

    renderHeader();
    saveGame(true);
  }

  function handleGameOver() {
    const keptFaith = state.faith;
    setStoryLog("Game Over... ëŠ¥ë ¥ì¹˜ëŠ” ì´ˆê¸°í™”ë˜ê³ , ì‹ ì•™ì‹¬ë§Œ ìœ ì§€ë©ë‹ˆë‹¤.");

    state = {
      ...defaultState,
      faith: keptFaith
    };

    renderHeader();
    saveGame(true);
    gotoScene("0-0");
  }

  /* ---------------- ì „íˆ¬ ì‹œìŠ¤í…œ (ê°€ìœ„ë°”ìœ„ë³´, ìˆœìˆ˜ ìš´) ---------------- */

  function startBattle() {
    battleState = {
      active: true,
      wins: 0,
      losses: 0
    };

    const battleScene = {
      id: "battle",
      branch: state.branch,
      random: false,
      ko: `ì „íˆ¬ ëª¨ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!
ê°€ìœ„, ë°”ìœ„, ë³´ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.
3ë²ˆ ì´ê¸°ë©´ ìŠ¹ë¦¬, 3ë²ˆ ì§€ë©´ íŒ¨ë°°ì…ë‹ˆë‹¤.

(ëŠ¥ë ¥ì¹˜ì™€ ìƒê´€ì—†ì´, ì™„ì „íˆ 'ìš´'ìœ¼ë¡œë§Œ ìŠ¹íŒ¨ê°€ ê²°ì •ë©ë‹ˆë‹¤.)`,
      en: `Battle mode has begun!
Choose rock, paper, or scissors.
Win 3 times to win the battle. Lose 3 times and you are defeated.

The result is pure luck, not based on your stats.`,
      choices: [
        { text: "âœŒ ê°€ìœ„ (Scissors)", action: () => battleRound() },
        { text: "âœŠ ë°”ìœ„ (Rock)",     action: () => battleRound() },
        { text: "âœ‹ ë³´ (Paper)",      action: () => battleRound() },
        { text: "ğŸƒ ë„ë§ (Run away)", action: () => battleRun() }
      ]
    };

    renderScene(battleScene);
    setStoryLog("ê°€ìœ„ë°”ìœ„ë³´ì—ì„œ 3ë²ˆ ì´ê¸°ë©´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤. (ì™„ì „ ëœë¤)");
  }

  function battleRound() {
    if (!battleState.active) return;

    const r = Math.random();   // 0~1
    if (r < 1/3) {
      // ìŠ¹ë¦¬
      battleState.wins++;
      setStoryLog(`ì „íˆ¬ì—ì„œ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! (í˜„ì¬ ìŠ¹ë¦¬: ${battleState.wins}/3)`);

      if (battleState.wins >= 3) {
        battleWin();
      }
    } else if (r < 2/3) {
      // íŒ¨ë°°
      battleState.losses++;
      setStoryLog(`ì „íˆ¬ì—ì„œ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤... (í˜„ì¬ íŒ¨ë°°: ${battleState.losses}/3)`);

      if (battleState.losses >= 3) {
        battleLose();
      }
    } else {
      // ë¹„ê¹€
      setStoryLog("ë¹„ê²¼ìŠµë‹ˆë‹¤! ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.");
    }
  }

  function getRunChanceInBattle() {
    // ì „íˆ¬ ì¤‘ ë„ë§ í™•ë¥  (ì ë‹¹íˆ 40%)
    return 0.4;
  }

  function battleRun() {
    if (!battleState.active) return;
    const runProb = getRunChanceInBattle();

    if (Math.random() < runProb) {
      battleState.active = false;
      setStoryLog("ì „íˆ¬ì—ì„œ ë„ë§ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!");
      saveGame(true);
      gotoRandomStoryInBranch(state.branch || 1);
    } else {
      battleState.losses++;
      setStoryLog(`ë„ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤! (íŒ¨ë°° ì¹´ìš´íŠ¸ +1 â†’ ${battleState.losses}/3)`);

      if (battleState.losses >= 3) {
        battleLose();
      }
    }
  }

  function battleWin() {
    battleState.active = false;
    state.faith += 7;
    state.str += 1;
    setStoryLog("ì „íˆ¬ì—ì„œ ì™„ì „íˆ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ì‹ ì•™ì‹¬ +7, í˜ +1");
    renderHeader();
    saveGame(true);
    gotoRandomStoryInBranch(state.branch || 1);
  }

  function battleLose() {
    battleState.active = false;

    setStoryLog("ì „íˆ¬ì—ì„œ íŒ¨ë°°í•˜ì—¬ HPê°€ 6 ê°ì†Œí–ˆìŠµë‹ˆë‹¤.");
    applyDamage(6);
    gotoRandomStoryInBranch(state.branch || 1);
  }

  /* ---------------- 1-1ì—ì„œì˜ 'ë„ë§ê°„ë‹¤' ì„ íƒ ---------------- */

  function getRunChanceEncounter() {
    // ì¼ë°˜ ìƒí™©ì—ì„œì˜ ë„ë§ í™•ë¥  (50%)
    return 0.5;
  }

  function attemptEncounterEscape() {
    const runProb = getRunChanceEncounter();

    if (Math.random() < runProb) {
      setStoryLog("ë„ë§ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ë‹¤ë¥¸ ì‚¬ê±´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      saveGame(true);
      gotoRandomStoryInBranch(state.branch || 1);
    } else {
      setStoryLog("ë„ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤... HPê°€ 1 ê°ì†Œí•©ë‹ˆë‹¤.");
      applyDamage(1);
      gotoScene("1-1");
    }
  }

  /* ---------------- ìƒë‹¨ ì •ë³´ ë Œë” ---------------- */

  function renderHeader() {
    document.getElementById("playerName").textContent = "Player: " + playerName;
    document.getElementById("statLine").textContent =
      `ëŠ¥ë ¥ì¹˜ â€“ STR:${state.str} | HP:${state.hp}/${state.maxHp} | ` +
      `DEX:${state.dex} | DEF:${state.def} | LIFE:${state.life} | FAITH:${state.faith}`;
  }

  /* ---------------- ìƒì  ---------------- */

  const shopItems = [
    { label:"í˜ +1",   stat:"str",  amount:1, cost:10 },
    { label:"ì²´ë ¥ +1", stat:"hp",   amount:1, cost:5 },
    { label:"íšŒí”¼ +1", stat:"dex",  amount:1, cost:5 },
    { label:"ë°©ì–´ +1", stat:"def",  amount:1, cost:5 },
    { label:"ëª©ìˆ¨ +1", stat:"life", amount:1, cost:50 }
  ];

  function openShop() {
    document.getElementById("shopBackdrop").style.display = "flex";
    updateShopFaithText();
    buildShopGrid();
    updateRandomLogUI();
  }

  function closeShop() {
    document.getElementById("shopBackdrop").style.display = "none";
  }

  function updateShopFaithText() {
    document.getElementById("shopFaithText").textContent =
      `í˜„ì¬ ì‹ ì•™ì‹¬(Faith): ${state.faith}F`;
  }

  function buildShopGrid() {
    const box = document.getElementById("shopGrid");
    box.innerHTML = "";
    shopItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "shop-item";

      div.innerHTML = `
        <div class="shop-item-title">${item.label}</div>
        <div class="shop-item-cost">${item.cost}F</div>
        <button class="shop-buy-btn">êµ¬ì…</button>
      `;

      div.querySelector("button").onclick = () => buyItem(item);
      box.appendChild(div);
    });
  }

  function buyItem(item) {
    if (state.faith < item.cost) {
      showToast("ì‹ ì•™ì‹¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
      return;
    }
    state.faith -= item.cost;

    if (item.stat === "hp") {
      state.maxHp += item.amount;
      state.hp += item.amount;
      if (state.hp > state.maxHp) state.hp = state.maxHp;
    } else {
      state[item.stat] += item.amount;
    }

    renderHeader();
    updateShopFaithText();
    saveGame(true);
    showToast(`êµ¬ì… ì™„ë£Œ: ${item.label}`);
  }

  /* ---------------- ëœë¤ ë½‘ê¸° ---------------- */

  const gachaCost = 50;

  const gachaTable = [
    { text:"í˜ +1",      apply:()=>{ state.str+=1; },  weight:7 },
    { text:"í˜ +5",      apply:()=>{ state.str+=5; },  weight:7 },
    { text:"í˜ +10",     apply:()=>{ state.str+=10; }, weight:3 },

    { text:"ì²´ë ¥ +1",    apply:()=>{ state.maxHp+=1; state.hp+=1; if(state.hp>state.maxHp)state.hp=state.maxHp; }, weight:7 },
    { text:"ì²´ë ¥ +5",    apply:()=>{ state.maxHp+=5; state.hp+=5; if(state.hp>state.maxHp)state.hp=state.maxHp; }, weight:7 },
    { text:"ì²´ë ¥ +10",   apply:()=>{ state.maxHp+=10; state.hp+=10; if(state.hp>state.maxHp)state.hp=state.maxHp; }, weight:3 },

    { text:"íšŒí”¼ +1",    apply:()=>{ state.dex+=1; },  weight:7 },
    { text:"íšŒí”¼ +5",    apply:()=>{ state.dex+=5; },  weight:7 },
    { text:"íšŒí”¼ +10",   apply:()=>{ state.dex+=10; }, weight:3 },

    { text:"ë°©ì–´ +1",    apply:()=>{ state.def+=1; },  weight:7 },
    { text:"ë°©ì–´ +5",    apply:()=>{ state.def+=5; },  weight:7 },
    { text:"ë°©ì–´ +10",   apply:()=>{ state.def+=10; }, weight:3 },

    { text:"ì‹ ì•™ì‹¬ +50", apply:()=>{ state.faith+=50; },  weight:5 },
    { text:"ì‹ ì•™ì‹¬ +100",apply:()=>{ state.faith+=100; }, weight:1 },

    { text:"ëª©ìˆ¨ +1",    apply:()=>{ state.life+=1; }, weight:2 },
    { text:"ëª©ìˆ¨ +2",    apply:()=>{ state.life+=2; }, weight:1 },
    { text:"ëª©ìˆ¨ +3",    apply:()=>{ state.life+=3; }, weight:1.82 },

    { text:"Starbucks Gift Card $5",  apply:()=>{}, weight:0.05 },
    { text:"Starbucks Gift Card $10", apply:()=>{}, weight:0.005 },
    { text:"Starbucks Gift Card $20", apply:()=>{}, weight:0.001 },

    { text:"Amazon Gift Card $10",    apply:()=>{}, weight:0.005 },
    { text:"Amazon Gift Card $20",    apply:()=>{}, weight:0.001 },

    { text:"Google Play Gift Card $5",  apply:()=>{}, weight:0.05 },
    { text:"Google Play Gift Card $10", apply:()=>{}, weight:0.005 },
    { text:"Google Play Gift Card $20", apply:()=>{}, weight:0.001 },

    { text:"ê½", apply:()=>{}, weight:20 }
  ];

  function rollGacha() {
    if (state.faith < gachaCost) {
      showToast("ì‹ ì•™ì‹¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (50F í•„ìš”)");
      return;
    }

    state.faith -= gachaCost;

    let total = gachaTable.reduce((s,x)=>s+x.weight, 0);
    let r = Math.random() * total;

    let chosen = gachaTable[gachaTable.length-1];
    for (const entry of gachaTable) {
      if (r < entry.weight) {
        chosen = entry;
        break;
      }
      r -= entry.weight;
    }

    const time = new Date().toLocaleTimeString("ko-KR", {hour:"2-digit", minute:"2-digit"});
    randomLog.unshift(`${time} â†’ ${chosen.text}`);
    if (randomLog.length > 20) randomLog.pop();
    updateRandomLogUI();

    if (chosen.text.includes("Gift Card")) {
      showGiftPopup(chosen.text);
      renderHeader();
      updateShopFaithText();
      saveGame(true);
      return;
    }

    chosen.apply();
    renderHeader();
    updateShopFaithText();
    saveGame(true);

    confettiEffect();
    showToast("ëœë¤ ë½‘ê¸° ê²°ê³¼: " + chosen.text);
  }

  function updateRandomLogUI() {
    const box = document.getElementById("randomLogBox");
    if (!randomLog.length) {
      box.innerHTML = "<p style='margin:0;color:#999;'>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      return;
    }
    box.innerHTML = randomLog.map(item => `<div>â€¢ ${item}</div>`).join("");
  }

  /* Gift Card ë‹¹ì²¨ íŒì—… */
  function showGiftPopup(itemName){
    confettiEffect();

    const back = document.createElement("div");
    back.style = `
      position:fixed; inset:0; 
      background:rgba(0,0,0,0.75);
      display:flex; align-items:center; justify-content:center;
      z-index:200;
    `;

    const card = document.createElement("div");
    card.style = `
      background:white; width:80%; max-width:420px;
      padding:30px; border-radius:20px;
      text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5);
    `;

    card.innerHTML = `
      <h2 style="font-size:28px; color:#d33; margin-bottom:10px;">ğŸ‰ CONGRATULATIONS! ğŸ‰</h2>
      <div style="font-size:22px; margin-bottom:20px;">
        You won:<br><strong style="font-size:26px; color:#2a6;">${itemName}</strong>
      </div>
      <p style="font-size:15px; margin-bottom:6px;">
        ğŸ“¸ ìŠ¤í¬ë¦°ìƒ·ì„ ì°ì–´ì„œ ì´ì¬ê´€ ëª©ì‚¬ë‹˜ê»˜ ì¹´í†¡ìœ¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”!
      </p>
      <p style="font-size:13px; color:#666;">
        ğŸ“¸ Please take a screenshot and send it to Pastor Jaegwan via KakaoTalk!
      </p>
      <button style="margin-top:20px; background:#444; color:white;
                     padding:10px 20px; border-radius:8px; border:none; cursor:pointer;">
        ë‹«ê¸° Close
      </button>
    `;

    card.querySelector("button").onclick = () => back.remove();
    back.appendChild(card);
    document.body.appendChild(back);
  }

  /* ---------------- ì €ì¥ ---------------- */

  async function saveGame(silent=false){
    if (!playerId) {
      if (!silent) alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. index.htmlì—ì„œ ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
      return;
    }
    localStorage.setItem("pilgrimSaveData", JSON.stringify(state));

    try {
      const r = await fetch(API_URL, {
        method:"POST",
        body:JSON.stringify({
          type:"save",
          id:playerId,
          saveData:state
        })
      });
      const t = await r.text();
      if(!silent){
        if(t==="saved") showToast("ì €ì¥ ì™„ë£Œ!");
        else showToast("ì €ì¥ ì‹¤íŒ¨: " + t);
      }
    } catch(e){
      if(!silent) alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /* ---------------- ì±„íŒ… ê¸°ëŠ¥ ---------------- */

  function openChat() {
    document.getElementById("chatBackdrop").style.display = "flex";
    fetchChat(true);
    setTimeout(() => {
      const input = document.getElementById("chatInput");
      if (input) input.focus();
    }, 100);
  }

  function closeChat() {
    document.getElementById("chatBackdrop").style.display = "none";
  }

  async function fetchChat(silent = true) {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "chatList" })
      });
      const text = await res.text();
      let list = [];
      try {
        list = JSON.parse(text);
      } catch (e) {
        list = [];
      }
      chatMessages = Array.isArray(list) ? list : [];
      renderChatMini();
      renderChatModalMessages();
    } catch (err) {
      if (!silent) console.error(err);
    }
  }

  function renderChatMini() {
    const box = document.getElementById("chatMini");
    if (!chatMessages.length) {
      box.innerHTML = "<div class='chat-mini-empty'>ì±„íŒ…ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ì¹œêµ¬ë“¤ì—ê²Œ ë¨¼ì € ë§ì„ ê±¸ì–´ë³´ì„¸ìš”!</div>";
      return;
    }

    const lastTwo = chatMessages.slice(-2);
    box.innerHTML = lastTwo.map(msg => {
      const name = escapeHtml(msg.name || "ëˆ„êµ°ê°€");
      const text = escapeHtml(msg.message || "");
      return `
        <div class="chat-mini-line">
          <span class="chat-mini-name">${name} :</span>
          <span class="chat-mini-text">${text}</span>
        </div>
      `;
    }).join("");
  }

  function renderChatModalMessages() {
    const wrap = document.getElementById("chatMessages");
    if (!chatMessages.length) {
      wrap.innerHTML = `<div class="chat-empty">ì•„ì§ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</div>`;
      return;
    }

    wrap.innerHTML = chatMessages.map(msg => {
      const isMe = (msg.name === playerName);
      const cls = isMe ? "me" : "other";
      const name = escapeHtml(msg.name || "Player");
      const text = escapeHtml(msg.message || "");
      return `
        <div class="chat-row ${cls}">
          <div class="chat-name">${name}</div>
          <div class="chat-bubble">${text}</div>
        </div>
      `;
    }).join("");

    wrap.scrollTop = wrap.scrollHeight;
  }

  async function sendChat() {
    const input = document.getElementById("chatInput");
    if (!input) return;
    const msg = (input.value || "").trim();
    if (!msg) return;
    if (!playerId) {
      alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
      return;
    }

    input.value = "";
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          type: "chatSend",
          id: playerId,
          name: playerName,
          message: msg
        })
      });
      const text = await res.text();
      if (text !== "ok") {
        showToast("ì±„íŒ… ì „ì†¡ ì‹¤íŒ¨: " + text);
      }
    } catch (e) {
      showToast("ì±„íŒ… ì „ì†¡ ì˜¤ë¥˜");
    }

    fetchChat(true);
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const chatInput = document.getElementById("chatInput");
      if (document.activeElement === chatInput) {
        e.preventDefault();
        sendChat();
      }
    }
  });

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  /* ---------------- í† ìŠ¤íŠ¸ & í­ì£½ ---------------- */

  function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2000);
  }

  function confettiEffect() {
    const duration = 1200;
    const end = Date.now() + duration;

    (function frame(){
      const colors = ["#ffcc00","#ff6699","#66ccff","#99ff66","#ff9966"];
      const div = document.createElement("div");
      div.style = `
        position:fixed; top:${Math.random()*40}%; left:${Math.random()*80+10}%;
        width:8px; height:14px;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        opacity:0.95; transform:rotate(${Math.random()*360}deg);
        transition: transform 1s ease-out, top 1s ease-out, opacity 1s;
        z-index:300;
      `;
      document.body.appendChild(div);
      setTimeout(()=>{
        div.style.top="100%";
        div.style.opacity="0";
        div.style.transform+=" rotate(720deg)";
      },10);
      setTimeout(()=>div.remove(),1500);
      if(Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  /* ---------------- ì´ˆê¸° ì‹¤í–‰ ---------------- */

  renderHeader();
  gotoScene(state.storyKey || "0-0");
  fetchChat(true);
  chatPollTimer = setInterval(fetchChat, 5000); // 5ì´ˆë§ˆë‹¤ ì±„íŒ… ê°±ì‹ 
</script>

</body>
</html>
