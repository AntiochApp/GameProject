<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Pilgrim's Journey â€“ Game</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Georgia", system-ui, sans-serif;
      background: url('bg_game.png') center/cover no-repeat fixed;
    }

    .overlay {
      background: rgba(0,0,0,0.35);
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
      padding: 16px;
    }

    /* ìƒë‹¨ ë°” */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(60,60,60,0.95);
      color: #f5f5f5;
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
      margin-bottom: 24px;
    }

    .player-info {
      font-size: 14px;
      white-space: nowrap;
    }

    .player-info strong {
      font-size: 16px;
      margin-right: 6px;
    }

    .stats {
      font-size: 13px;
      opacity: 0.9;
    }

    .top-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-top {
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      background: #8e5b32;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    }
    .btn-top.save {
      background: #407a3b;
    }
    .btn-top:hover {
      filter: brightness(1.05);
    }

    /* ìŠ¤í† ë¦¬ ì¹´ë“œ */
    .story-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 40px;
    }

    .story-card {
      width: min(900px, 90vw);
      background: rgba(255,255,255,0.92);
      border-radius: 18px;
      padding: 26px 32px 32px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
      border: 1px solid rgba(230,230,230,0.9);
      position: relative;
    }

    /* ì–‘í”¼ì§€ ëŠë‚Œ */
    .story-card::before {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 14px;
      border: 2px solid rgba(180,150,100,0.7);
      pointer-events: none;
      box-shadow: inset 0 0 15px rgba(0,0,0,0.08);
    }

    .story-ko {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #333;
      position: relative;
      z-index: 1;
    }

    .story-en {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
    }

    /* ìŠ¤í† ë¦¬ ë¡œê·¸ (ì•„ë˜ í•œ ì¤„) */
    .story-log {
      font-size: 13px;
      color: #884422;
      margin-bottom: 16px;
      min-height: 20px;
      font-style: italic;
      position: relative;
      z-index: 1;
    }

    /* ì„ íƒì§€ ì»¨í…Œì´ë„ˆ */
    .choice-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    /* RPG ì„ íƒì§€ ìŠ¤íƒ€ì¼ (C ìŠ¤íƒ€ì¼) */
    .choice-btn {
      border: none;
      cursor: pointer;
      text-align: left;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(90deg, #f8e3b8, #f3d09a);
      color: #4b2c17;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
      position: relative;
      overflow: hidden;
    }
    .choice-btn::before {
      content: "";
      position: absolute;
      inset: 2px;
      border-radius: 8px;
      border: 1px solid rgba(120,80,40,0.5);
      pointer-events: none;
    }
    .choice-btn:hover {
      filter: brightness(1.05);
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }

    /* ìƒì  ëª¨ë‹¬ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .modal {
      background: #f8f4ec;
      border-radius: 18px;
      padding: 20px 24px 24px;
      width: min(640px, 95vw);
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      border: 2px solid #b7935d;
      overflow-y: auto;
      max-height: 90vh;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #54351c;
    }

    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 22px;
      font-weight: bold;
    }

    .shop-faith {
      font-size: 13px;
      color: #333;
      margin-bottom: 8px;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 16px;
    }

    .shop-item {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: 1px solid #e2d2b4;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 80px;
    }

    .shop-item-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #3b2615;
    }

    .shop-item-cost {
      font-size: 12px;
      color: #7a5b34;
      margin-bottom: 6px;
    }

    .shop-buy-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      align-self: flex-end;
      background: #8e5b32;
      color: #fff;
    }
    .shop-buy-btn:hover {
      filter: brightness(1.05);
    }

    /* ê°€ì±  ë¡œê·¸ */
    .gacha-log-box {
      margin-top: 10px;
      margin-bottom: 10px;
      background:#fff7e0;
      padding:10px;
      border-radius:10px;
      border:1px solid #d8c6a4;
      max-height:70px; /* ë†’ì´ ì¤„ì„ */
      overflow-y:auto;
      font-size:13px;
    }

    .gacha-section {
      border-top: 1px dashed #c7b08a;
      padding-top: 10px;
      margin-top: 12px; /* ìœ„ìª½ ê°„ê²© ëŠ˜ë¦¼ */
      text-align: center;
    }

    .gacha-btn {
      margin-top: 6px;
      padding: 10px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      background: linear-gradient(90deg,#f2a93b,#ff6f61);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }
    .gacha-btn:hover {
      filter: brightness(1.05);
    }

    .gacha-desc {
      font-size: 12px;
      color: #7a5b34;
    }

    /* ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out;
      z-index: 50;
    }
    .toast.show {
      opacity: 1;
    }
  </style>
</head>

<body>
<div class="overlay">

  <!-- ìƒë‹¨ ë°” -->
  <div class="top-bar">
    <div class="player-info">
      <strong id="playerName">Player: ë¡œê·¸ì¸</strong>
      <span class="stats" id="statLine"></span>
    </div>
    <div class="top-buttons">
      <button class="btn-top" onclick="openShop()">ìƒì </button>
      <button class="btn-top save" onclick="saveGame()">ì €ì¥</button>
    </div>
  </div>

  <!-- ìŠ¤í† ë¦¬ ì¹´ë“œ -->
  <div class="story-wrapper">
    <div class="story-card">
      <div class="story-ko" id="storyKo">ì—¬ê¸°ì— ìŠ¤í† ë¦¬ í•œêµ­ì–´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div class="story-en" id="storyEn">Here the English translation will appear.</div>
      <div class="story-log" id="storyLog"></div>
      <div class="choice-container" id="choiceContainer"></div>
    </div>
  </div>

  <!-- ìƒì  ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="shopBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>Pilgrim ìƒì </h2>
        <button class="modal-close" onclick="closeShop()">Ã—</button>
      </div>

      <div class="shop-faith" id="shopFaithText"></div>

      <!-- ëœë¤ë½‘ê¸° ê¸°ë¡ì°½ -->
      <div id="randomLogBox" class="gacha-log-box">
        <p style="margin:0; color:#999;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>

      <div class="shop-grid" id="shopGrid"></div>

      <div class="gacha-section">
        <div class="gacha-desc">ëœë¤ ë½‘ê¸° (50F) â€“ í° ë³´ìƒ ë˜ëŠ” ê½!</div>
        <button class="gacha-btn" onclick="rollGacha()">âœ¨ ëœë¤ ë½‘ê¸° âœ¨</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwUqF_7np5AgJTygWKEn8diNyiFmvAnHaSsY0Xz3zVMuw5bGnn6y2Wr35zmq-w_ZuHyTQ/exec";

  /* ====== ê¸°ë³¸ ìƒíƒœ ====== */
  let playerId = localStorage.getItem("pilgrimPlayerId") || "";
  let playerName = localStorage.getItem("pilgrimPlayerName") || "ë¡œê·¸ì¸";

  let state = {
    str: 1,
    maxHp: 10,   // ìµœëŒ€ HP
    curHp: 10,   // í˜„ì¬ HP
    dex: 1,
    def: 1,
    life: 1,
    faith: 0,
    storyIndex: 0,
    route: "0",          // 0=ì‹œì‘, 1=ì†Œë”ì— ë‚¨ìŒ, 2=ì†Œë” ë– ë‚¨
    currentStory: "0-0"  // ìŠ¤í† ë¦¬ ID
  };

  // ì €ì¥ëœ ì„¸ì´ë¸Œ ë¶ˆëŸ¬ì˜¤ê¸°
  try {
    const saved = JSON.parse(localStorage.getItem("pilgrimSaveData") || "null");
    if (saved) {
      state = Object.assign(state, saved);
    }
  } catch(e){}

  // ì˜› ë°ì´í„° í˜¸í™˜: hpë§Œ ìˆì„ ê²½ìš°
  if (!state.maxHp) {
    state.maxHp = state.hp || 10;
  }
  if (!state.curHp) {
    state.curHp = state.maxHp;
  }
  // hp í•„ë“œë„ ìµœëŒ€ HPë¡œ ë§ì¶°ì¤Œ
  state.hp = state.maxHp;

  /* ëœë¤ë½‘ê¸° ë¡œê·¸ ì €ì¥ (ì„¸ì…˜ ìœ ì§€) */
  let randomLog = [];

  /* ====== ìŠ¤í† ë¦¬ ë°ì´í„° ======
     ID í˜•ì‹: "0-0", "1-1", "1-R1" ... */

  const STORY_DATA = {
    "0-0": {
      ko: "ì„¸ìƒì—ëŠ” ì£„ê°€ ë§Œì—°í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë¬´ì—‡ì´ ì£„ì¸ê°€? ë¬´ì—‡ì´ ë„ë•ì¸ê°€? ì‚¬ëŒë“¤ì€ ì¸ê¶Œì´ë¼ëŠ” ì´ë¦„ ì•„ë˜ ì„œì„œíˆ íƒ€ë½í•˜ê³  ìˆìŠµë‹ˆë‹¤.\nì´ëŸ¬í•œ ì„¸ìƒ ì†ì—ì„œâ€¦ ë‚˜ëŠ” ëŒ€ì²´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ëŠ”ê°€â€¦\n\në‹¹ì‹ ì€ ì§€ê¸ˆ 'ì†Œë”'ì´ë¼ëŠ” íƒ€ë½í•œ ë„ì‹œì— ê±°ì£¼í•˜ê³  ìˆìŠµë‹ˆë‹¤. ê³„ì† ì´ê³³ì— ë¨¸ë¬¼ê² ìŠµë‹ˆê¹Œ?",
      en: "Sin is overflowing in this world. What is sin? What is morality? Under the name of 'human rights', people are slowly falling into darkness.\nIn this world... what should I do?\n\nYou are now living in a corrupt city called 'Sodom'. Will you stay here?",
      choices: [
        { key: "stay", label: "1. ë‚¨ëŠ”ë‹¤ (ì†Œë”ì— ê³„ì† ë¨¸ë¬¸ë‹¤)" },
        { key: "leave", label: "2. ë– ë‚œë‹¤ (ì†Œë”ì„ ë– ë‚œë‹¤)" }
      ]
    },

    "1-1": {
      ko: "ì§‘ì— ìŒì‹ì´ ì—†ì–´ ë§ˆíŠ¸ë¡œ í–¥í•˜ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ë•Œ, ì•ì—ì„œ ì˜¤ë˜ ê°™ì€ ì„±ë³„ì˜ ì‚¬ëŒì´ ë‹¹ì‹ ì„ í–¥í•´ ìœ™í¬í•˜ë©° ìœ í˜¹í•©ë‹ˆë‹¤.\n\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
      en: "You are heading to the market because there's no food at home. Then, someone of the same gender walks by and winks at you, trying to tempt you.\n\nWhat will you do?",
      choices: [
        { key: "together", label: "1. í•¨ê»˜í•œë‹¤" },
        { key: "fight",    label: "2. ì‹¸ìš´ë‹¤" },
        { key: "run",      label: "3. ë„ë§ê°„ë‹¤" }
      ]
    },

    // 1ë²ˆ ë£¨íŠ¸ì˜ ëœë¤ ìŠ¤í† ë¦¬ ì˜ˆì‹œ (ë‚˜ì¤‘ì— 1-2~1-100ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥)
    "1-R1": {
      ko: "ì†Œë”ì˜ ë°¤ê±°ë¦¬ë¥¼ ì§€ë‚˜ê°€ë©°, ë„ˆëŠ” ì˜¤ëŠ˜ì˜ ì„ íƒì„ ë‹¤ì‹œ ë– ì˜¬ë¦½ë‹ˆë‹¤. í•˜ë‚˜ë‹˜ì€ ì—¬ì „íˆ ë„ˆë¥¼ ë¶€ë¥´ê³  ê³„ì‹­ë‹ˆë‹¤.",
      en: "As you walk through the night streets of Sodom, you recall the choices you made today. God is still calling you.",
      choices: [
        { key: "continue1", label: "ê³„ì† ì§„í–‰í•˜ê¸°" }
      ]
    },

    /* 2ë²ˆ ë£¨íŠ¸: ì†Œë”ì„ ë– ë‚œ ê¸¸ */
    "2-1": {
      ko: "ë‹¹ì‹ ì€ ë¬´ê±°ìš´ ë§ˆìŒìœ¼ë¡œ ì†Œë”ì„ ë– ë‚©ë‹ˆë‹¤. ë„ì‹œì˜ ë¶ˆë¹›ì´ ì ì  ë©€ì–´ì§€ê³ , ì•ì—ëŠ” ê´‘ì•¼ê°€ í¼ì³ì§‘ë‹ˆë‹¤.\n\në‚¯ì„  ê¸¸ì´ì§€ë§Œ, í•˜ë‚˜ë‹˜ê»˜ì„œ ì¸ë„í•´ ì£¼ì‹¤ê¹Œìš”?",
      en: "With a heavy heart, you leave Sodom. The city lights fade behind you, and a vast wilderness stretches before you.\n\nThe road is unfamiliar, but will God guide you?",
      choices: [
        { key: "pray",  label: "1. ê¸°ë„í•˜ë©° í•œ ê±¸ìŒì”© ë‚˜ì•„ê°„ë‹¤" },
        { key: "doubt", label: "2. ë‘ë ¤ì›€ ì†ì—ì„œ ë‹¤ì‹œ ë’¤ë¥¼ ëŒì•„ë³¸ë‹¤" }
      ]
    },

    "2-R1": {
      ko: "ê´‘ì•¼ì˜ ë°”ëŒì´ ì°¨ê°‘ê²Œ ë¶ˆì–´ì˜µë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ í•˜ëŠ˜ì˜ ë³„ë¹›ì€ ì¡°ìš©íˆ ë„ˆë¥¼ ë¹„ì¶”ê³  ìˆìŠµë‹ˆë‹¤.",
      en: "The wind in the wilderness is cold, but the starlight above quietly shines on you.",
      choices: [
        { key: "continue2", label: "ê³„ì† ì§„í–‰í•˜ê¸°" }
      ]
    }
  };

  /* ====== ì „íˆ¬ ê´€ë ¨ ìƒíƒœ ====== */
  let battleMode = false;
  let battleState = {
    wins: 0,
    losses: 0
  };

  /* ====== ìœ í‹¸: ìŠ¤í† ë¦¬ ë Œë” ====== */
  function renderStory() {
    const story = STORY_DATA[state.currentStory] || STORY_DATA["0-0"];

    document.getElementById("storyKo").textContent = story.ko;
    document.getElementById("storyEn").textContent = story.en;

    // ë¡œê·¸ëŠ” ê·¸ëŒ€ë¡œ ë‘ 
    const container = document.getElementById("choiceContainer");
    container.innerHTML = "";

    // ì„ íƒì§€ ë²„íŠ¼ ìƒì„±
    (story.choices || []).forEach(choice => {
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = choice.label;
      btn.onclick = () => handleChoice(state.currentStory, choice.key);
      container.appendChild(btn);
    });
  }

  function setStoryLog(msg) {
    const el = document.getElementById("storyLog");
    if (!el) return;
    el.textContent = msg || "";
  }

  /* ====== ì„ íƒì§€ ì²˜ë¦¬ ====== */
  function handleChoice(storyId, key) {
    // ì „íˆ¬ ëª¨ë“œë©´ ë‹¤ë¥¸ ì„ íƒì§€ ë¬´ì‹œ (ì „íˆ¬ìš© ë²„íŠ¼ì—ì„œë§Œ ì²˜ë¦¬)
    if (battleMode) return;

    if (storyId === "0-0") {
      if (key === "stay") {
        state.route = "1";
        state.currentStory = "1-1";
        setStoryLog("ë‹¹ì‹ ì€ ì†Œë”ì— ë‚¨ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.");
        renderStory();
      } else if (key === "leave") {
        state.route = "2";
        state.currentStory = "2-1";
        setStoryLog("ë‹¹ì‹ ì€ ì†Œë”ì„ ë– ë‚˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.");
        renderStory();
      }
      saveGame(true);
      return;
    }

    if (storyId === "1-1") {
      if (key === "together") {
        // í•¨ê»˜í•œë‹¤ â†’ HP -10
        applyDamage(10, "ì£„ ê°€ìš´ë° í•¨ê»˜í–ˆìŠµë‹ˆë‹¤... HP -10");
        setStoryLog("ë‹¹ì‹ ì€ ìœ í˜¹ì— ë„˜ì–´ê°”ìŠµë‹ˆë‹¤. ì˜í˜¼ê³¼ ëª¸ì´ ì§€ì³ê°‘ë‹ˆë‹¤.");
        gotoRandomStoryForRoute("1");
      } else if (key === "fight") {
        startBattleFrom1_1();
      } else if (key === "run") {
        attemptRunFromEvent();
      }
      return;
    }

    if (storyId === "1-R1") {
      // ê°„ë‹¨íˆ ë‹¤ì‹œ 1ë²ˆ ë£¨íŠ¸ ëœë¤ ìŠ¤í† ë¦¬
      gotoRandomStoryForRoute("1");
      return;
    }

    if (storyId === "2-1") {
      if (key === "pray") {
        setStoryLog("ë‘ë ¤ì›€ ì†ì—ì„œë„ ê¸°ë„í•˜ë©° í•œ ê±¸ìŒì”© ë‚˜ì•„ê°‘ë‹ˆë‹¤.");
        gotoRandomStoryForRoute("2");
      } else if (key === "doubt") {
        setStoryLog("ë§ˆìŒì— í”ë“¤ë¦¼ì´ ì°¾ì•„ì˜¤ì§€ë§Œ, í•˜ë‚˜ë‹˜ì€ ì—¬ì „íˆ ë„ˆë¥¼ ë¶€ë¥´ê³  ê³„ì‹­ë‹ˆë‹¤.");
        gotoRandomStoryForRoute("2");
      }
      saveGame(true);
      return;
    }

    if (storyId === "2-R1") {
      gotoRandomStoryForRoute("2");
      return;
    }
  }

  /* ====== ë£¨íŠ¸ë³„ ëœë¤ ìŠ¤í† ë¦¬ ì„ íƒ (ì§€ê¸ˆì€ 1-R1, 2-R1ë§Œ) ====== */
  function gotoRandomStoryForRoute(route) {
    if (route === "1") {
      state.currentStory = "1-R1";
    } else if (route === "2") {
      state.currentStory = "2-R1";
    } else {
      state.currentStory = "0-0";
    }
    renderStory();
    saveGame(true);
  }

  /* ====== ì „íˆ¬ ëª¨ë“œ (1-1ì˜ 'ì‹¸ìš´ë‹¤') ====== */

  function startBattleFrom1_1() {
    battleMode = true;
    battleState = { wins: 0, losses: 0 };

    document.getElementById("storyKo").textContent =
      "ì „íˆ¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ê°€ìœ„, ë°”ìœ„, ë³´ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.\n3ë²ˆ ì´ê¸°ë©´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.";
    document.getElementById("storyEn").textContent =
      "Battle has begun! Choose rock, paper, or scissors.\nWin 3 times to win the battle.";

    setStoryLog("ì „íˆ¬ ì‹œì‘! STRì´ ë†’ì„ìˆ˜ë¡ ìŠ¹ë¦¬ í™•ë¥ ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤.");

    const container = document.getElementById("choiceContainer");
    container.innerHTML = "";

    ["ê°€ìœ„", "ë°”ìœ„", "ë³´"].forEach(move => {
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = move;
      btn.onclick = () => battleRound();
      container.appendChild(btn);
    });

    // ë„ë§ ë²„íŠ¼
    const runBtn = document.createElement("button");
    runBtn.className = "choice-btn";
    runBtn.textContent = "ë„ë§ì¹˜ê¸° (ì „íˆ¬ ì¤‘)";
    runBtn.onclick = () => battleRun();
    container.appendChild(runBtn);
  }

  // ì „íˆ¬ 1íšŒ ë¼ìš´ë“œ (ì‹¤ì œ ê°€ìœ„ë°”ìœ„ë³´ ëª¨ì–‘ì€ ì•ˆë³´ì´ê³ , í™•ë¥ ë¡œ ìŠ¹íŒ¨ë§Œ ê²°ì •)
  function battleRound() {
    if (!battleMode) return;

    // ìŠ¹ë¦¬ í™•ë¥ : ê¸°ë³¸ 40%, STR+1ë‹¹ 0.01% (0.0001), ìµœëŒ€ 80%
    const baseWin = 0.40;
    const bonusWin = Math.min(state.str * 0.0001, 0.40); // ìµœëŒ€ +40%
    const winChance = Math.min(baseWin + bonusWin, 0.80);

    const roll = Math.random();
    if (roll < winChance) {
      battleState.wins++;
      setStoryLog(`ì´ë²ˆ íŒ ìŠ¹ë¦¬! (${battleState.wins}ìŠ¹ ${battleState.losses}íŒ¨)`);
    } else {
      battleState.losses++;
      setStoryLog(`ì´ë²ˆ íŒ íŒ¨ë°°... (${battleState.wins}ìŠ¹ ${battleState.losses}íŒ¨)`);
    }

    checkBattleEnd();
  }

  function battleRun() {
    if (!battleMode) return;

    // ë„ë§ í™•ë¥ : ê¸°ë³¸ 10%, DEX+1ë‹¹ 0.01%, ìµœëŒ€ 70%
    const base = 0.10;
    const bonus = Math.min(state.dex * 0.0001, 0.60);
    const runChance = Math.min(base + bonus, 0.70);

    if (Math.random() < runChance) {
      setStoryLog("ì „íˆ¬ì—ì„œ ë„ë§ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!");
      battleMode = false;
      gotoRandomStoryForRoute("1");
    } else {
      battleState.losses++;
      setStoryLog(`ë„ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤... (íŒ¨ë°° 1íšŒ ëˆ„ì ) / í˜„ì¬ (${battleState.wins}ìŠ¹ ${battleState.losses}íŒ¨)`);
      checkBattleEnd();
    }
  }

  function checkBattleEnd() {
    if (battleState.wins >= 3) {
      // ì „íˆ¬ ìŠ¹ë¦¬: STR +1, FAITH +7
      state.str += 1;
      state.faith += 7;
      battleMode = false;

      renderHeader();
      setStoryLog("ì „íˆ¬ ìŠ¹ë¦¬! í˜ +1, ì‹ ì•™ì‹¬ +7ì„ ì–»ì—ˆìŠµë‹ˆë‹¤.");
      saveGame(true);
      gotoRandomStoryForRoute("1");
      return;
    }

    if (battleState.losses >= 3) {
      // ë°©ì–´ í™•ë¥ : ê¸°ë³¸ 0%, DEF+1ë‹¹ 0.01%, ìµœëŒ€ 80%
      const defChance = Math.min(state.def * 0.0001, 0.80);

      if (Math.random() < defChance) {
        setStoryLog("ë°©ì–´ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤! HPëŠ” ë–¨ì–´ì§€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      } else {
        applyDamage(6, "ì „íˆ¬ íŒ¨ë°°ë¡œ ì¸í•´ HP -6");
      }

      battleMode = false;
      saveGame(true);
      gotoRandomStoryForRoute("1");
    }
  }

  /* ====== 1-1ì—ì„œ 'ë„ë§ê°„ë‹¤' ì„ íƒ (ì „íˆ¬ ì „ ë„ë§) ====== */
  function attemptRunFromEvent() {
    // ë„ë§ í™•ë¥ : ê¸°ë³¸ 50%, DEX+1ë‹¹ 0.01%, ìµœëŒ€ 70%
    const base = 0.50;
    const bonus = Math.min(state.dex * 0.0001, 0.20); // 0.70ê¹Œì§€
    const runChance = Math.min(base + bonus, 0.70);

    if (Math.random() < runChance) {
      setStoryLog("ë„ë§ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ìœ„í—˜í•œ ìƒí™©ì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.");
      gotoRandomStoryForRoute("1");
    } else {
      applyDamage(1, "ë„ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤... HP -1");
      setStoryLog("ë„ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
      // ë‹¤ì‹œ 1-1ë¡œ (ê°™ì€ ì´ë²¤íŠ¸ ë°˜ë³µ)
      state.currentStory = "1-1";
      renderStory();
      saveGame(true);
    }
  }

  /* ====== HP/ëª©ìˆ¨/ë¶€í™œ/ê²Œì„ì˜¤ë²„ ì²˜ë¦¬ ====== */
  function applyDamage(amount, reason) {
    state.curHp -= amount;
    if (state.curHp < 0) state.curHp = 0;
    renderHeader();
    if (reason) {
      setStoryLog(`${reason} (í˜„ì¬ HP: ${state.curHp}/${state.maxHp})`);
    }
    if (state.curHp <= 0) {
      handleDeath();
    }
  }

  function handleDeath() {
    state.life -= 1;
    if (state.life < 0) {
      // Game Over: ëŠ¥ë ¥ì¹˜(STR,HP,DEX,DEF,LIFE,ìŠ¤í† ë¦¬) ì´ˆê¸°í™”, FAITHë§Œ ìœ ì§€
      const keepFaith = state.faith;
      state = {
        str: 1,
        maxHp: 10,
        curHp: 10,
        dex: 1,
        def: 1,
        life: 1,
        faith: keepFaith, // ì‹ ì•™ì‹¬ ìœ ì§€
        storyIndex: 0,
        route: "0",
        currentStory: "0-0",
        hp: 10
      };
      setStoryLog("GAME OVER... ëŠ¥ë ¥ì¹˜ëŠ” ì´ˆê¸°í™”ë˜ì—ˆê³ , ì‹ ì•™ì‹¬ì€ ê·¸ëŒ€ë¡œì…ë‹ˆë‹¤.");
      renderHeader();
      renderStory();
      saveGame(true);
    } else {
      // ë¶€í™œ: í˜„ì¬ ë£¨íŠ¸ ìœ ì§€, HPëŠ” ìµœëŒ€ HPë¡œ íšŒë³µ, ë‹¤ë¥¸ ëœë¤ ìŠ¤í† ë¦¬ë¡œ ì´ë™
      state.curHp = state.maxHp;
      renderHeader();
      setStoryLog("ë‹¹ì‹ ì€ ì“°ëŸ¬ì¡Œì§€ë§Œ ë‹¤ì‹œ ì¼ì–´ë‚¬ìŠµë‹ˆë‹¤. (ëª©ìˆ¨ -1, HP ì™„ì „ íšŒë³µ)");
      saveGame(true);
      if (state.route === "1" || state.route === "2") {
        gotoRandomStoryForRoute(state.route);
      } else {
        state.currentStory = "0-0";
        renderStory();
      }
    }
  }

  /* ====== ìƒë‹¨ ì •ë³´ ë Œë” ====== */
  function renderHeader() {
    document.getElementById("playerName").textContent = "Player: " + playerName;
    document.getElementById("statLine").textContent =
      `ëŠ¥ë ¥ì¹˜ â€“ STR:${state.str} | HP:${state.curHp}/${state.maxHp} | ` +
      `DEX:${state.dex} | DEF:${state.def} | LIFE:${state.life} | FAITH:${state.faith}`;
  }

  /* ====== ìƒì  ====== */
  const shopItems = [
    { label:"í˜ +1",   stat:"str",   amount:1, cost:10 },
    { label:"ì²´ë ¥ +1", stat:"maxHp", amount:1, cost:5 },
    { label:"íšŒí”¼ +1", stat:"dex",   amount:1, cost:5 },
    { label:"ë°©ì–´ +1", stat:"def",   amount:1, cost:5 },
    { label:"ëª©ìˆ¨ +1", stat:"life",  amount:1, cost:50 }
  ];

  function openShop() {
    document.getElementById("shopBackdrop").style.display = "flex";
    updateShopFaithText();
    buildShopGrid();
    updateRandomLogUI();
  }

  function closeShop() {
    document.getElementById("shopBackdrop").style.display = "none";
  }

  function updateShopFaithText() {
    document.getElementById("shopFaithText").textContent =
      `í˜„ì¬ ì‹ ì•™ì‹¬(Faith): ${state.faith}F`;
  }

  function buildShopGrid() {
    const box = document.getElementById("shopGrid");
    box.innerHTML = "";
    shopItems.forEach(item=>{
      const div = document.createElement("div");
      div.className="shop-item";

      div.innerHTML = `
        <div class="shop-item-title">${item.label}</div>
        <div class="shop-item-cost">${item.cost}F</div>
        <button class="shop-buy-btn">êµ¬ì…</button>
      `;
      
      div.querySelector("button").onclick = ()=>buyItem(item);
      box.appendChild(div);
    });
  }

  function buyItem(item) {
    if (state.faith < item.cost) {
      showToast("ì‹ ì•™ì‹¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
      return;
    }
    state.faith -= item.cost;

    if (item.stat === "maxHp") {
      state.maxHp += item.amount;
      state.curHp += item.amount; // ì¡°ê¸ˆ íšŒë³µë„ ê°™ì´
    } else {
      state[item.stat] += item.amount;
    }

    renderHeader();
    updateShopFaithText();
    saveGame(true);
    showToast(`êµ¬ì… ì™„ë£Œ: ${item.label}`);
  }

  /* ====== ëœë¤ë½‘ê¸° ë¡œê·¸ UI ====== */
  function updateRandomLogUI() {
    const box = document.getElementById("randomLogBox");
    if (!randomLog.length) {
      box.innerHTML = "<p style='margin:0;color:#999;'>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      return;
    }
    box.innerHTML = randomLog
      .map(item=>`<div>â€¢ ${item}</div>`)
      .join("");
  }

  /* Gift Card ë‹¹ì²¨ íŒì—… */
  function showGiftPopup(itemName){
    confettiEffect();

    const back = document.createElement("div");
    back.style = `
      position:fixed; inset:0; 
      background:rgba(0,0,0,0.75);
      display:flex; align-items:center; justify-content:center;
      z-index:200;
    `;

    const card = document.createElement("div");
    card.style = `
      background:white; width:80%; max-width:420px;
      padding:30px; border-radius:20px;
      text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5);
    `;

    card.innerHTML = `
      <h2 style="font-size:28px; color:#d33; margin-bottom:10px;">ğŸ‰ CONGRATULATIONS! ğŸ‰</h2>
      <div style="font-size:22px; margin-bottom:20px;">
        You won:<br><strong style="font-size:26px; color:#2a6;">${itemName}</strong>
      </div>
      <p style="font-size:15px; margin-bottom:6px;">
        ğŸ“¸ ìŠ¤í¬ë¦°ìƒ·ì„ ì°ì–´ì„œ ì´ì¬ê´€ ëª©ì‚¬ë‹˜ê»˜ ì¹´í†¡ìœ¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”!
      </p>
      <p style="font-size:13px; color:#666; margin-bottom:16px;">
        ğŸ“¸ Please take a screenshot and send it to Pastor Jaegwan via KakaoTalk!
      </p>
      <button style="margin-top:10px; background:#444; color:white;
                     padding:10px 20px; border-radius:8px; border:none; cursor:pointer;"
              onclick="this.parentElement.parentElement.remove()">
        ë‹«ê¸° Close
      </button>
    `;

    back.appendChild(card);
    document.body.appendChild(back);
  }

  /* ====== ëœë¤ë½‘ê¸° ====== */
  const gachaCost = 50;

  const gachaTable = [
    { text:"í˜ +1",      apply:()=>{state.str+=1;},     weight:7 },
    { text:"í˜ +5",      apply:()=>{state.str+=5;},     weight:7 },
    { text:"í˜ +10",     apply:()=>{state.str+=10;},    weight:3 },

    { text:"ì²´ë ¥ +1",    apply:()=>{state.maxHp+=1; state.curHp+=1;},   weight:7 },
    { text:"ì²´ë ¥ +5",    apply:()=>{state.maxHp+=5; state.curHp+=5;},   weight:7 },
    { text:"ì²´ë ¥ +10",   apply:()=>{state.maxHp+=10; state.curHp+=10;}, weight:3 },

    { text:"íšŒí”¼ +1",    apply:()=>{state.dex+=1;},     weight:7 },
    { text:"íšŒí”¼ +5",    apply:()=>{state.dex+=5;},     weight:7 },
    { text:"íšŒí”¼ +10",   apply:()=>{state.dex+=10;},    weight:3 },

    { text:"ë°©ì–´ +1",    apply:()=>{state.def+=1;},     weight:7 },
    { text:"ë°©ì–´ +5",    apply:()=>{state.def+=5;},     weight:7 },
    { text:"ë°©ì–´ +10",   apply:()=>{state.def+=10;},    weight:3 },

    { text:"ì‹ ì•™ì‹¬ +50", apply:()=>{state.faith+=50;},  weight:5 },
    { text:"ì‹ ì•™ì‹¬ +100",apply:()=>{state.faith+=100;}, weight:1 },

    { text:"ëª©ìˆ¨ +1",    apply:()=>{state.life+=1;},    weight:2 },
    { text:"ëª©ìˆ¨ +2",    apply:()=>{state.life+=2;},    weight:1 },
    { text:"ëª©ìˆ¨ +3",    apply:()=>{state.life+=3;},    weight:1.82 },

    // Gift Card í™•ë¥ : ì „ì²´ í•©ì—ì„œ ë§¤ìš° ì‘ì€ ë¹„ìœ¨(ì›ë˜ ê°’ì˜ 0.1ë°° ìˆ˜ì¤€)
    { text:"Starbucks Gift Card $5",  apply:()=>{}, weight:0.05 },
    { text:"Starbucks Gift Card $10", apply:()=>{}, weight:0.005 },
    { text:"Starbucks Gift Card $20", apply:()=>{}, weight:0.001 },

    { text:"Amazon Gift Card $10",    apply:()=>{}, weight:0.005 },
    { text:"Amazon Gift Card $20",    apply:()=>{}, weight:0.001 },

    { text:"Google Play Gift Card $5",  apply:()=>{}, weight:0.05 },
    { text:"Google Play Gift Card $10", apply:()=>{}, weight:0.005 },
    { text:"Google Play Gift Card $20", apply:()=>{}, weight:0.001 },

    { text:"ê½", apply:()=>{}, weight:20 }
  ];

  function rollGacha() {
    if (state.faith < gachaCost) {
      showToast("ì‹ ì•™ì‹¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (50F í•„ìš”)");
      return;
    }

    state.faith -= gachaCost;

    let total = gachaTable.reduce((s,x)=>s+x.weight, 0);
    let r = Math.random() * total;

    let chosen = gachaTable[gachaTable.length-1];
    for (const entry of gachaTable) {
      if (r < entry.weight) {
        chosen = entry;
        break;
      }
      r -= entry.weight;
    }

    // ë¡œê·¸ ì¶”ê°€
    const time = new Date().toLocaleTimeString("ko-KR", {hour:"2-digit", minute:"2-digit"});
    randomLog.unshift(`${time} â†’ ${chosen.text}`);
    // ìµœê·¼ 20ê°œ ì •ë„ë§Œ ìœ ì§€
    if (randomLog.length > 20) randomLog.length = 20;
    updateRandomLogUI();

    // GiftCardë©´ íŒì—… + ì €ì¥
    if (chosen.text.includes("Gift Card")) {
      showGiftPopup(chosen.text);
      saveGame(true);
      return;
    }

    // ì¼ë°˜ ë³´ìƒ
    chosen.apply();
    renderHeader();
    updateShopFaithText();
    saveGame(true);

    confettiEffect();
    showToast("ëœë¤ ë½‘ê¸°: " + chosen.text);
  }

  /* ====== ì €ì¥ ====== */
  async function saveGame(silent=false){
    if (!playerId) {
      if (!silent) alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }
    // hp í•„ë“œëŠ” maxHpë¡œ ë™ê¸°í™”
    state.hp = state.maxHp;

    localStorage.setItem("pilgrimSaveData", JSON.stringify(state));

    try {
      const r = await fetch(API_URL,{
        method:"POST",
        body:JSON.stringify({
          type:"save",
          id:playerId,
          saveData:state
        })
      });
      const t = await r.text();
      if(!silent){
        if(t==="saved") showToast("ì €ì¥ë¨!");
        else showToast("ì €ì¥ ì‹¤íŒ¨: " + t);
      }
    } catch(e){
      if(!silent) alert("ì €ì¥ ì˜¤ë¥˜");
    }
  }

  /* ====== í† ìŠ¤íŠ¸ ====== */
  function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2000);
  }

  /* ====== í­ì£½ ====== */
  function confettiEffect() {
    const duration = 1200;
    const end = Date.now() + duration;

    (function frame(){
      const colors = ["#ffcc00","#ff6699","#66ccff","#99ff66","#ff9966"];
      const div = document.createElement("div");
      div.style = `
        position:fixed; top:${Math.random()*40}%; left:${Math.random()*80+10}%;
        width:8px; height:14px;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        opacity:0.95; transform:rotate(${Math.random()*360}deg);
        transition: transform 1s ease-out, top 1s ease-out, opacity 1s;
        z-index:300;
      `;
      document.body.appendChild(div);
      setTimeout(()=>{
        div.style.top="100%";
        div.style.opacity="0";
        div.style.transform+=" rotate(720deg)";
      },10);
      setTimeout(()=>div.remove(),1500);
      if(Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  /* ====== ì´ˆê¸° ì‹¤í–‰ ====== */
  renderHeader();
  renderStory();
</script>

</body>
</html>
