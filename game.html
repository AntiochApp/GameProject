<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Pilgrim's Journey â€“ Game</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Georgia", system-ui, sans-serif;
      background: url('bg_game.png') center/cover no-repeat fixed;
    }

    .overlay {
      background: rgba(0,0,0,0.35);
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
      padding: 16px;
    }

    /* ìƒë‹¨ ë°” */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(60,60,60,0.95);
      color: #f5f5f5;
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
      margin-bottom: 12px;
    }

    .player-info {
      font-size: 14px;
      white-space: nowrap;
    }

    .player-info strong {
      font-size: 16px;
      margin-right: 6px;
    }

    .stats {
      font-size: 13px;
      opacity: 0.9;
    }

    .top-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-top {
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      background: #8e5b32;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    }
    .btn-top.chat {
      background: #5c6bc0;
    }
    .btn-top.save {
      background: #407a3b;
    }
    .btn-top:hover {
      filter: brightness(1.05);
    }

    /* ë¯¸ë‹ˆ ì±„íŒ… ë°” (ìŠ¤í† ë¦¬ ìœ„ 2ì¤„) */
    .chat-mini-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }
    .chat-mini {
      width: min(900px, 90vw);
      background: rgba(30, 30, 30, 0.85);
      border-radius: 14px;
      padding: 6px 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.07);
      font-size: 12px;
      color: #f5f2e9;
      font-family: "Georgia", system-ui, sans-serif;
    }
    .chat-mini-line {
      display: flex;
      gap: 6px;
      align-items: baseline;
      line-height: 1.3;
      opacity: 0.95;
    }
    .chat-mini-name {
      color: #ffe082;
      font-weight: 700;
      white-space: nowrap;
    }
    .chat-mini-text {
      color: #fefefe;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .chat-mini-empty {
      color: #999;
      font-style: italic;
      text-align: center;
    }

    /* ìŠ¤í† ë¦¬ ì¹´ë“œ */
    .story-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 12px;
    }

    .story-card {
      width: min(900px, 90vw);
      background: rgba(255,255,255,0.92);
      border-radius: 18px;
      padding: 26px 32px 32px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
      border: 1px solid rgba(230,230,230,0.9);
    }

    .story-ko {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #333;
    }

    .story-en {
      font-size: 14px;
      color: #666;
      margin-bottom: 24px;
    }

    .next-btn {
      display: inline-block;
      margin-top: 8px;
      padding: 10px 24px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      background: #8e5b32;
      color: #fff;
      box-shadow: 0 3px 8px rgba(0,0,0,0.35);
    }
    .next-btn:hover {
      filter: brightness(1.05);
    }

    /* ê³µí†µ ëª¨ë‹¬ ë°°ê²½ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    /* ìƒì  ëª¨ë‹¬ */
    .modal {
      background: #f8f4ec;
      border-radius: 18px;
      padding: 20px 24px 24px;
      width: min(640px, 95vw);
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      border: 2px solid #b7935d;
      overflow-y: auto;
      max-height: 90vh;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #54351c;
    }

    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 22px;
      font-weight: bold;
    }

    .shop-faith {
      font-size: 13px;
      color: #333;
      margin-bottom: 8px;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    .shop-item {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: 1px solid #e2d2b4;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 80px;
    }

    .shop-item-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #3b2615;
    }

    .shop-item-cost {
      font-size: 12px;
      color: #7a5b34;
      margin-bottom: 6px;
    }

    .shop-buy-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      align-self: flex-end;
      background: #8e5b32;
      color: #fff;
    }
    .shop-buy-btn:hover {
      filter: brightness(1.05);
    }

    .gacha-section {
      border-top: 1px dashed #c7b08a;
      padding-top: 10px;
      margin-top: 6px;
      text-align: center;
    }

    .gacha-btn {
      margin-top: 6px;
      padding: 10px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      background: linear-gradient(90deg,#f2a93b,#ff6f61);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }
    .gacha-btn:hover {
      filter: brightness(1.05);
    }

    .gacha-desc {
      font-size: 12px;
      color: #7a5b34;
    }

    /* ê°€ì±  ë¡œê·¸ */
.gacha-log-box {
  margin-top: 15px;
  margin-bottom: 20px;  /* â† í˜+1 ì¹´ë“œì™€ì˜ ê°„ê²© ì¶”ê°€!! */

  background:#fff7e0;
  padding:10px;
  border-radius:10px;
  border:1px solid #d8c6a4;
  max-height:120px; 
  overflow-y:auto;
  font-size:13px;
}

    /* ì±„íŒ… ëª¨ë‹¬ (RPG ìŠ¤íƒ€ì¼) */
    .chat-modal {
      background: radial-gradient(circle at top, #f9f0dc 0%, #e6d4b2 40%, #d0b58a 100%);
      border-radius: 20px;
      padding: 20px 22px 18px;
      width: min(640px, 95vw);
      box-shadow: 0 12px 32px rgba(0,0,0,0.7);
      border: 2px solid #8d6e3c;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .chat-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .chat-modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #4a2c12;
      letter-spacing: 1px;
    }

    .chat-modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-height: 260px;
    }

    .chat-messages {
      flex: 1;
      background: rgba(255,255,255,0.65);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(139,87,42,0.35);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .chat-row {
      display: flex;
      flex-direction: column;
      max-width: 80%;
    }
    .chat-row.me {
      align-self: flex-end;
      text-align: right;
    }
    .chat-row.other {
      align-self: flex-start;
      text-align: left;
    }

    .chat-name {
      font-size: 11px;
      color: #6d4c41;
      margin-bottom: 2px;
      opacity: 0.9;
    }

    .chat-bubble {
      padding: 6px 10px;
      border-radius: 12px;
      line-height: 1.3;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      word-break: break-word;
    }

    .chat-row.me .chat-bubble {
      background: #8e5b32;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .chat-row.other .chat-bubble {
      background: rgba(255,255,255,0.95);
      color: #3e2723;
      border-bottom-left-radius: 4px;
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .chat-input-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #b19063;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      background: rgba(255,255,255,0.9);
    }
    .chat-input-row input:focus {
      border-color: #8e5b32;
      box-shadow: 0 0 0 2px rgba(142,91,50,0.2);
    }

    .chat-send-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #8e5b32;
      color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    }
    .chat-send-btn:hover {
      filter: brightness(1.05);
    }

    .chat-empty {
      font-size: 12px;
      color: #8d6e63;
      text-align: center;
      margin-top: 12px;
    }

    /* ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out;
      z-index: 50;
    }
    .toast.show {
      opacity: 1;
    }
  </style>
</head>

<body>
<div class="overlay">

  <!-- ìƒë‹¨ ë°” -->
  <div class="top-bar">
    <div class="player-info">
      <strong id="playerName">Player: ë¡œê·¸ì¸</strong>
      <span class="stats" id="statLine"></span>
    </div>
    <div class="top-buttons">
      <button class="btn-top chat" onclick="openChat()">ì±„íŒ…</button>
      <button class="btn-top" onclick="openShop()">ìƒì </button>
      <button class="btn-top save" onclick="saveGame()">ì €ì¥</button>
    </div>
  </div>

  <!-- ë¯¸ë‹ˆ ì±„íŒ… ë°” (ìµœê·¼ 2ê°œ) -->
  <div class="chat-mini-wrapper">
    <div class="chat-mini" id="chatMini">
      <div class="chat-mini-empty">ì±„íŒ…ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ì¹œêµ¬ë“¤ì—ê²Œ ë¨¼ì € ë§ì„ ê±¸ì–´ë³´ì„¸ìš”!</div>
    </div>
  </div>

  <!-- ìŠ¤í† ë¦¬ ì¹´ë“œ -->
  <div class="story-wrapper">
    <div class="story-card">
      <div class="story-ko" id="storyKo">ì—¬ê¸°ì— ìŠ¤í† ë¦¬ í•œêµ­ì–´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div class="story-en" id="storyEn">Here the English translation will appear.</div>
      <button class="next-btn" onclick="nextStory()">ë‹¤ìŒ ì§„í–‰</button>
    </div>
  </div>

  <!-- ìƒì  ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="shopBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>Pilgrim ìƒì </h2>
        <button class="modal-close" onclick="closeShop()">Ã—</button>
      </div>

      <div class="shop-faith" id="shopFaithText"></div>

      <!-- ëœë¤ë½‘ê¸° ê¸°ë¡ì°½ -->
      <div id="randomLogBox" class="gacha-log-box">
        <p style="margin:0; color:#999;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>

      <div class="shop-grid" id="shopGrid"></div>

      <div class="gacha-section">
        <div class="gacha-desc">ëœë¤ ë½‘ê¸° (50F) â€“ í° ë³´ìƒ ë˜ëŠ” ê½!</div>
        <button class="gacha-btn" onclick="rollGacha()">âœ¨ ëœë¤ ë½‘ê¸° âœ¨</button>
      </div>
    </div>
  </div>

  <!-- ì±„íŒ… ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="chatBackdrop">
    <div class="chat-modal">
      <div class="chat-modal-header">
        <h2>Prayer Chat</h2>
        <button class="modal-close" onclick="closeChat()">Ã—</button>
      </div>
      <div class="chat-modal-body">
        <div class="chat-messages" id="chatMessages">
          <!-- JSë¡œ ì±„ì›€ -->
        </div>
        <div class="chat-input-row">
          <input id="chatInput" type="text" maxlength="100"
                 placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”. (ìµœëŒ€ 100ì)">
          <button class="chat-send-btn" onclick="sendChat()">ë³´ë‚´ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwUqF_7np5AgJTygWKEn8diNyiFmvAnHaSsY0Xz3zVMuw5bGnn6y2Wr35zmq-w_ZuHyTQ/exec";

  let playerId = localStorage.getItem("pilgrimPlayerId") || "";
  let playerName = localStorage.getItem("pilgrimPlayerName") || "ë¡œê·¸ì¸";

  let state = {
    str: 1,
    hp: 10,
    dex: 1,
    def: 1,
    life: 1,
    faith: 0,
    storyIndex: 0
  };

  try {
    const saved = JSON.parse(localStorage.getItem("pilgrimSaveData") || "null");
    if (saved) state = Object.assign(state, saved);
  } catch(e){}

  /* ëœë¤ë½‘ê¸° ë¡œê·¸ ì €ì¥ (ì„¸ì…˜ ìœ ì§€) */
  let randomLog = [];

  /* ì±„íŒ… ë°ì´í„° */
  let chatMessages = [];
  let chatPollTimer = null;

  /* ìŠ¤í† ë¦¬ */
  const stories = [
    { ko:"ì˜¤ëŠ˜ë„ ë„ˆì˜ ì‹ ì•™ì˜ ì—¬ì •ì´ ì‹œì‘ë©ë‹ˆë‹¤.", en:"Today, your journey of faith begins again." },
    { ko:"í•˜ë‚˜ë‹˜ì€ ì‘ì€ ë¯¿ìŒë„ ì†Œì¤‘íˆ ì—¬ê¸°ì‹­ë‹ˆë‹¤.", en:"God treasures even a small amount of faith." },
    { ko:"ê¸°ë„ì™€ ë§ì”€ìœ¼ë¡œ í˜ì„ ì–»ì–´ ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ ë³´ì„¸ìš”.", en:"Gain strength through prayer and the Word, and move forward." }
  ];

  function renderStory() {
    const idx = Math.min(state.storyIndex, stories.length - 1);
    document.getElementById("storyKo").textContent = stories[idx].ko;
    document.getElementById("storyEn").textContent = stories[idx].en;
  }

  function nextStory() {
    if (state.storyIndex < stories.length - 1) {
      state.storyIndex++;
      renderStory();
    } else {
      showToast("ë§ˆì§€ë§‰ ìŠ¤í† ë¦¬ì…ë‹ˆë‹¤.");
    }
  }

  /* ìƒë‹¨ ì •ë³´ ë Œë” */
  function renderHeader() {
    document.getElementById("playerName").textContent = "Player: " + playerName;
    document.getElementById("statLine").textContent =
      `ëŠ¥ë ¥ì¹˜ â€“ STR:${state.str} | HP:${state.hp} | DEX:${state.dex} | DEF:${state.def} | LIFE:${state.life} | FAITH:${state.faith}`;
  }

  /* ìƒì  */
  const shopItems = [
    { label:"í˜ +1", stat:"str",  amount:1, cost:10 },
    { label:"ì²´ë ¥ +1", stat:"hp", amount:1, cost:5 },
    { label:"íšŒí”¼ +1", stat:"dex", amount:1, cost:5 },
    { label:"ë°©ì–´ +1", stat:"def", amount:1, cost:5 },
    { label:"ëª©ìˆ¨ +1", stat:"life",amount:1, cost:50 }
  ];

  function openShop() {
    document.getElementById("shopBackdrop").style.display = "flex";
    updateShopFaithText();
    buildShopGrid();
    updateRandomLogUI();
  }

  function closeShop() {
    document.getElementById("shopBackdrop").style.display = "none";
  }

  function updateShopFaithText() {
    document.getElementById("shopFaithText").textContent =
      `í˜„ì¬ ì‹ ì•™ì‹¬(Faith): ${state.faith}F`;
  }

  function buildShopGrid() {
    const box = document.getElementById("shopGrid");
    box.innerHTML = "";
    shopItems.forEach(item=>{
      const div = document.createElement("div");
      div.className="shop-item";

      div.innerHTML = `
        <div class="shop-item-title">${item.label}</div>
        <div class="shop-item-cost">${item.cost}F</div>
        <button class="shop-buy-btn">êµ¬ì…</button>
      `;
      
      div.querySelector("button").onclick = ()=>buyItem(item);
      box.appendChild(div);
    });
  }

  function buyItem(item) {
    if (state.faith < item.cost) {
      showToast("ì‹ ì•™ì‹¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
      return;
    }
    state.faith -= item.cost;
    state[item.stat] += item.amount;

    renderHeader();
    updateShopFaithText();
    saveGame(true);
    showToast(`êµ¬ì… ì™„ë£Œ: ${item.label}`);
  }

  /* ë¡œê·¸ ì—…ë°ì´íŠ¸ */
  function updateRandomLogUI() {
    const box = document.getElementById("randomLogBox");
    if (!randomLog.length) {
      box.innerHTML = "<p style='margin:0;color:#999;'>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      return;
    }
    box.innerHTML = randomLog
      .map(item=>`<div>â€¢ ${item}</div>`)
      .join("");
  }

  /* Gift Card ë‹¹ì²¨ íŒì—… */
  function showGiftPopup(itemName){
  const back = document.createElement("div");
  back.style = `
    position:fixed; inset:0; 
    background:rgba(0,0,0,0.75);
    display:flex; align-items:center; justify-content:center;
    z-index:200;
  `;

  const card = document.createElement("div");
  card.style = `
    background:white; width:80%; max-width:420px;
    padding:30px; border-radius:20px;
    text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5);
  `;

  card.innerHTML = `
    <h2 style="font-size:28px; color:#d33; margin-bottom:10px;">
      ğŸ‰ CONGRATULATIONS! ğŸ‰
    </h2>

    <div style="font-size:22px; margin-bottom:20px;">
      You won:<br>
      <strong style="font-size:26px; color:#2a6;">${itemName}</strong>
    </div>

    <p style="font-size:15px; margin-bottom:6px;">
      ğŸ“¸ ìŠ¤í¬ë¦°ìƒ·ì„ ì°ì–´ì„œ ì´ì¬ê´€ ëª©ì‚¬ë‹˜ê»˜ ì¹´í†¡ìœ¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”!
    </p>
    <p style="font-size:13px; color:#666;">
      ğŸ“¸ Please take a screenshot and send it to Pastor Jaegwan via KakaoTalk!
    </p>

    <button 
      style="
        margin-top:12px;
        background:#2a6;
        color:white;
        padding:10px 18px;
        border-radius:8px;
        border:none;
        cursor:pointer;
      "
      onclick="captureScreenshot()"
    >
      ğŸ“· ìŠ¤í¬ë¦°ìƒ· ì°ê¸°
    </button>

    <br>

    <button 
      style="
        margin-top:20px;
        background:#444;
        color:white;
        padding:10px 20px;
        border-radius:8px;
        border:none;
        cursor:pointer;
      "
      onclick="this.parentElement.parentElement.remove()"
    >
      ë‹«ê¸° Close
    </button>
  `;

  back.appendChild(card);
  document.body.appendChild(back);
}

  /* ëœë¤ë½‘ê¸° */
  const gachaCost = 50;

  const gachaTable = [
  { text:"í˜ +1",      apply:()=>{state.str+=1;},    weight:7 },
  { text:"í˜ +5",      apply:()=>{state.str+=5;},    weight:7 },
  { text:"í˜ +10",     apply:()=>{state.str+=10;},   weight:3 },

  { text:"ì²´ë ¥ +1",    apply:()=>{state.hp+=1;},     weight:7 },
  { text:"ì²´ë ¥ +5",    apply:()=>{state.hp+=5;},     weight:7 },
  { text:"ì²´ë ¥ +10",   apply:()=>{state.hp+=10;},    weight:3 },

  { text:"íšŒí”¼ +1",    apply:()=>{state.dex+=1;},    weight:7 },
  { text:"íšŒí”¼ +5",    apply:()=>{state.dex+=5;},    weight:7 },
  { text:"íšŒí”¼ +10",   apply:()=>{state.dex+=10;},   weight:3 },

  { text:"ë°©ì–´ +1",    apply:()=>{state.def+=1;},    weight:7 },
  { text:"ë°©ì–´ +5",    apply:()=>{state.def+=5;},    weight:7 },
  { text:"ë°©ì–´ +10",   apply:()=>{state.def+=10;},   weight:3 },

  { text:"ì‹ ì•™ì‹¬ +50", apply:()=>{state.faith+=50;}, weight:5 },
  { text:"ì‹ ì•™ì‹¬ +100",apply:()=>{state.faith+=100;},weight:1 },

  { text:"ëª©ìˆ¨ +1",    apply:()=>{state.life+=1;},   weight:2 },
  { text:"ëª©ìˆ¨ +2",    apply:()=>{state.life+=2;},   weight:1 },
  { text:"ëª©ìˆ¨ +3",    apply:()=>{state.life+=3;},   weight:1.82 },

  // ==== ì—¬ê¸°ë¶€í„° Gift Card í™•ë¥  í¬ê²Œ ë‚®ì¶˜ ë²„ì „ ====
  { text:"Starbucks Gift Card $5",  apply:()=>{}, weight:0.1 },
  { text:"Starbucks Gift Card $10", apply:()=>{}, weight:0.01 },
  { text:"Starbucks Gift Card $20", apply:()=>{}, weight:0.002 },

  { text:"Amazon Gift Card $10",    apply:()=>{}, weight:0.01 },
  { text:"Amazon Gift Card $20",    apply:()=>{}, weight:0.002 },

  { text:"Google Play Gift Card $5",  apply:()=>{}, weight:0.1 },
  { text:"Google Play Gift Card $10", apply:()=>{}, weight:0.01 },
  { text:"Google Play Gift Card $20", apply:()=>{}, weight:0.002 },

  // ë‚˜ë¨¸ì§€ í™•ë¥ ì€ ì „ë¶€ 'ê½' ìœ¼ë¡œ ë³´ì •
  { text:"ê½", apply:()=>{}, weight:20.944 }
];


  function rollGacha() {

    if (state.faith < gachaCost) {
      showToast(`ì‹ ì•™ì‹¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (${gachaCost}F í•„ìš”)`);
      return;
    }

    state.faith -= gachaCost;

    let total = gachaTable.reduce((s,x)=>s+x.weight, 0);
    let r = Math.random() * total;

    let chosen = gachaTable[gachaTable.length-1];
    for (const entry of gachaTable) {
      if (r < entry.weight) {
        chosen = entry;
        break;
      }
      r -= entry.weight;
    }

    /* ë¡œê·¸ ì¶”ê°€ */
    const time = new Date().toLocaleTimeString("ko-KR", {hour:"2-digit", minute:"2-digit"});
    randomLog.unshift(`${time} â†’ ${chosen.text}`);
    updateRandomLogUI();

    /* Gift Card ë‹¹ì²¨ì´ë©´ íŒì—… */
    if (chosen.text.includes("Gift Card")) {
      showGiftPopup(chosen.text);
      return;
    }

    /* ì¼ë°˜ ë³´ìƒ */
    chosen.apply();
    renderHeader();
    updateShopFaithText();
    saveGame(true);

    confettiEffect();
    showToast("ëœë¤ ë½‘ê¸°: " + chosen.text);
  }

  /* ì €ì¥ */
  async function saveGame(silent=false){
    if (!playerId) {
      if (!silent) alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }
    localStorage.setItem("pilgrimSaveData", JSON.stringify(state));

    try {
      const r = await fetch(API_URL,{
        method:"POST",
        body:JSON.stringify({
          type:"save",
          id:playerId,
          saveData:state
        })
      });
      const t = await r.text();
      if(!silent){
        if(t==="saved") showToast("ì €ì¥ë¨!");
        else showToast("ì €ì¥ ì‹¤íŒ¨");
      }
    } catch(e){
      if(!silent) alert("ì €ì¥ ì˜¤ë¥˜");
    }
  }

  /* ===== ì±„íŒ… ê¸°ëŠ¥ ===== */

  function openChat() {
    document.getElementById("chatBackdrop").style.display = "flex";
    fetchChat(true);
    setTimeout(() => {
      const input = document.getElementById("chatInput");
      if (input) input.focus();
    }, 100);
  }

  function closeChat() {
    document.getElementById("chatBackdrop").style.display = "none";
  }

  async function fetchChat(silent = true) {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ type: "chatList" })
      });
      const text = await res.text();
      let list = [];
      try {
        list = JSON.parse(text);
      } catch (e) {
        list = [];
      }
      chatMessages = Array.isArray(list) ? list : [];
      renderChatMini();
      renderChatModalMessages();
    } catch (err) {
      if (!silent) console.error(err);
    }
  }

  function renderChatMini() {
    const box = document.getElementById("chatMini");
    if (!chatMessages.length) {
      box.innerHTML = "<div class='chat-mini-empty'>ì±„íŒ…ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ì¹œêµ¬ë“¤ì—ê²Œ ë¨¼ì € ë§ì„ ê±¸ì–´ë³´ì„¸ìš”!</div>";
      return;
    }

    const lastTwo = chatMessages.slice(-2);
    box.innerHTML = lastTwo.map(msg => {
      const name = escapeHtml(msg.name || "ëˆ„êµ°ê°€");
      const text = escapeHtml(msg.message || "");
      return `
        <div class="chat-mini-line">
          <span class="chat-mini-name">${name} :</span>
          <span class="chat-mini-text">${text}</span>
        </div>
      `;
    }).join("");
  }

  function renderChatModalMessages() {
    const wrap = document.getElementById("chatMessages");
    if (!chatMessages.length) {
      wrap.innerHTML = `<div class="chat-empty">ì•„ì§ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</div>`;
      return;
    }

    wrap.innerHTML = chatMessages.map(msg => {
      const isMe = (msg.name === playerName);
      const cls = isMe ? "me" : "other";
      const name = escapeHtml(msg.name || "Player");
      const text = escapeHtml(msg.message || "");
      return `
        <div class="chat-row ${cls}">
          <div class="chat-name">${name}</div>
          <div class="chat-bubble">${text}</div>
        </div>
      `;
    }).join("");

    // ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
    wrap.scrollTop = wrap.scrollHeight;
  }

  async function sendChat() {
    const input = document.getElementById("chatInput");
    if (!input) return;
    const msg = (input.value || "").trim();
    if (!msg) return;
    if (!playerId) {
      alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
      return;
    }

    input.value = "";
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          type: "chatSend",
          id: playerId,
          name: playerName,
          message: msg
        })
      });
      const text = await res.text();
      if (text !== "ok") {
        showToast("ì±„íŒ… ì „ì†¡ ì‹¤íŒ¨: " + text);
      }
    } catch (e) {
      showToast("ì±„íŒ… ì „ì†¡ ì˜¤ë¥˜");
    }

    // ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    fetchChat(true);
  }

  // ì…ë ¥ì—ì„œ ì—”í„°ë¡œ ì „ì†¡
  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const chatInput = document.getElementById("chatInput");
      if (document.activeElement === chatInput) {
        e.preventDefault();
        sendChat();
      }
    }
  });

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  /* í† ìŠ¤íŠ¸ */
  function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2000);
  }

  /* í­ì£½ */
  function confettiEffect() {
    const duration = 1200;
    const end = Date.now() + duration;

    (function frame(){
      const colors = ["#ffcc00","#ff6699","#66ccff","#99ff66","#ff9966"];
      const div = document.createElement("div");
      div.style = `
        position:fixed; top:${Math.random()*40}%; left:${Math.random()*80+10}%;
        width:8px; height:14px;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        opacity:0.95; transform:rotate(${Math.random()*360}deg);
        transition: transform 1s ease-out, top 1s ease-out, opacity 1s;
        z-index:300;
      `;
      document.body.appendChild(div);
      setTimeout(()=>{
        div.style.top="100%";
        div.style.opacity="0";
        div.style.transform+=" rotate(720deg)";
      },10);
      setTimeout(()=>div.remove(),1500);
      if(Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  /* ì´ˆê¸° ì‹¤í–‰ */
  renderHeader();
  renderStory();
  fetchChat(true);                     // ì²˜ìŒ ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸°
  chatPollTimer = setInterval(fetchChat, 1000); // 5ì´ˆë§ˆë‹¤ ê°±ì‹ 

  async function captureScreenshot() {
  try {
    // 1) í™”ë©´ ìº¡ì²˜ ê¶Œí•œ ìš”ì²­
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: { mediaSource: "screen" }
    });

    // 2) ë¹„ë””ì˜¤ë¡œ í™”ë©´ ë Œë”ë§
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    const bitmap = await imageCapture.grabFrame();

    // 3) canvasì— ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
    const canvas = document.createElement("canvas");
    canvas.width = bitmap.width;
    canvas.height = bitmap.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);

    // 4) PNG ì¶”ì¶œ
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);

      // ìë™ ë‹¤ìš´ë¡œë“œ
      const a = document.createElement("a");
      a.href = url;
      a.download = "pilgrim_giftcard_screenshot.png";
      document.body.appendChild(a);
      a.click();
      a.remove();

      // ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
      stream.getTracks().forEach(track => track.stop());
    });

  } catch (err) {
    alert("í™”ë©´ ìº¡ì²˜ê°€ ì·¨ì†Œë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}
</script>

</body>
</html>







